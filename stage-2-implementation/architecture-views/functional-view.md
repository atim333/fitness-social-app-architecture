# Функциональное представление архитектуры (DDD-ориентированное)

## Обзор

Функциональное представление описывает систему с точки зрения функциональности, организованной по принципам Domain-Driven Design (DDD). Функции сгруппированы по ограниченным контекстам и реализуются через агрегаты, доменные сервисы и доменные события.

---

## 1. User & Social Context (Core Domain)

### 1.1 Управление пользователями (Агрегат `User`)

**Агрегат-корень:** `User`
**Сервисы:** UserManagementService, AuthenticationService

#### Функции:

**Регистрация и аутентификация:**
- Создание нового пользователя с валидацией минимального возраста (13+)
- Аутентификация через OAuth 2.0, JWT, социальные сети
- Двухфакторная аутентификация для администраторов
- Восстановление пароля через подтверждённый email

**Управление профилем:**
- Создание и редактирование спортивного профиля (цели, интересы, предпочтения)
- Управление спортивным инвентарём (обувь, снаряжение) с отслеживанием износа
- Настройки приватности (уровни доступа к данным)
- Управление подписками (free, premium, pro)

#### Бизнес-правила:
- Максимальное количество друзей: 5000 на пользователя
- Минимальный возраст для регистрации: 13 лет
- Обязательная верификация email для активации аккаунта
- Правила хранения и обработки персональных данных (GDPR)

#### Доменные события:
- `UserRegistered` → триггер welcome-серии
- `ProfileUpdated` → обновление кэша рекомендаций
- `InventoryAdded` → проверка рекомендаций по обновлению

### 1.2 Социальный граф и сообщества (Агрегаты `SocialGroup`, `Friendship`)

**Агрегаты-корни:** `SocialGroup`, `Friendship`
**Сервисы:** SocialGraphService, GroupManagementService

#### Функции:

**Управление социальными связями:**
- Добавление в друзья и отправка запросов на дружбу
- Управление списком подписчиков и подписок
- Блокировка пользователей и управление чёрными списками
- Рекомендации друзей на основе общих интересов и геолокации

**Создание и управление сообществами:**
- Создание групп по спортивным интересам (бег, йога, велоспорт)
- Управление членством (приглашения, принятие, исключение)
- Назначение ролей в группе (администратор, модератор, участник)
- Организация групповых тренировок и мероприятий

**Лента социальной активности:**
- Агрегация активности друзей и групп
- Публикация достижений и результатов тренировок
- Взаимодействия (лайки, комментарии, репосты)
- Персонализация ленты на основе интересов

#### Бизнес-правила:
- Минимальный возраст для создания групп: 16 лет
- Максимальный размер группы: 5000 участников (для бесплатных аккаунтов)
- Правила модерации пользовательского контента
- Ограничение на количество запросов в друзья: 50 в день

#### Доменные события:
- `FriendshipEstablished` → уведомление друзей, обновление социального графа
- `GroupCreated` → инициализация модерации, рекомендации участников
- `ActivityPublished` → обновление ленты друзей, проверка достижений
- `UserJoinedGroup` → обновление статистики группы, welcome-сообщение

---

## 2. Activity & Training Context

### 2.1 Трекинг тренировок (Агрегат `TrainingSession`)

**Агрегат-корень:** `TrainingSession`
**Сервисы:** WorkoutTrackingService, DeviceIntegrationService

#### Функции:

**Запись и мониторинг тренировок:**
- Старт, пауза, возобновление и завершение тренировочной сессии
- Запись телеметрии в реальном времени (GPS, высота, скорость, пульс)
- Автоматическое определение типа активности (бег, велосипед, плавание)
- Интеграция с внешними устройствами (фитнес-браслеты, пульсометры)

**Валидация и обработка данных:**
- Проверка физиологической корректности данных (ЧСС, калории, расстояние)
- Коррекция GPS-треков и удаление выбросов
- Расчет производных метрик (темп, сожжённые калории, VO₂ Max)
- Обнаружение и обработка аномалий в данных

#### Бизнес-правила:
- Валидация ЧСС: минимальное значение 40 BPM, максимальное 220 - возраст
- Проверка GPS-координат: широта (-90 до +90), долгота (-180 до +180)
- Максимальная продолжительность непрерывной тренировки: 24 часа
- Минимальная продолжительность для записи: 1 минута

#### Доменные события:
- `WorkoutStarted` → начало отслеживания сессии, инициализация метрик
- `WorkoutPaused` → приостановка записи, сохранение промежуточных данных
- `WorkoutResumed` → возобновление записи, обновление таймеров
- `WorkoutCompleted` → финализация данных, расчёт статистики

### 2.2 Аналитика тренировок и прогресс (Агрегат `ProgressTracker`)

**Агрегат-корень:** `ProgressTracker`
**Сервисы:** TrainingAnalyticsService, PersonalStatisticsService

#### Функции:

**Анализ и визуализация данных:**
- Хранение истории тренировок за все время (архивирование старых данных)
- Отображение прогресса через графики и диаграммы (неделя, месяц, год)
- Сравнение с предыдущими результатами (персональные рекорды)
- Анализ трендов и паттернов тренировочной активности

**Персональная статистика и отчёты:**
- Расчёт ключевых показателей (общий километраж, время, сожжённые калории)
- Сравнение с пользователями своего региона и возрастной группы
- Генерация еженедельных и ежемесячных отчётов
- Рекомендации по улучшению на основе статистики

**Управление тренировочными планами (Агрегат `TrainingPlan`):**
- Создание персонализированных планов (на основе целей и уровня подготовки)
- Адаптация планов в зависимости от прогресса и обратной связи
- Интеграция с календарём пользователя (напоминания о тренировках)
- Отслеживание выполнения плана и корректировка при необходимости

#### Бизнес-правила:
- Минимальное количество тренировок для расчёта статистики: 5 сессий
- Максимальный период хранения детальных данных: 5 лет
- Автоматическая архивация данных старше 1 года
- Персональные рекорды обновляются только при подтверждённых данных (валидация)

#### Доменные события:
- `ProgressUpdated` → обновление статистики, проверка достижений
- `PersonalRecordAchieved` → публикация в ленте, награждение бейджем
- `TrainingPlanCreated` → интеграция с календарём, напоминания
- `PlanMilestoneReached` → начисление баллов, уведомление

---

## 3. Health & Device Context

### 3.1 Интеграция медицинских устройств (Агрегат `Device`)

**Агрегат-корень:** `Device`
**Сервисы:** DeviceIntegrationService, HealthMetricsService

#### Функции:

**Подключение и управление устройствами:**
- Автоматическое обнаружение и сопряжение устройств (Bluetooth, ANT+)
- Регистрация и аутентификация устройств (серийные номера, ключи)
- Управление списком подключенных устройств (добавление, удаление, приоритеты)
- Мониторинг состояния подключения и уровня заряда батареи

**Калибровка и валидация данных:**
- Калибровка датчиков под индивидуальные характеристики пользователя
- Валидация получаемых данных на соответствие медицинским стандартам
- Коррекция погрешностей измерений на основе калибровочных кривых
- Обнаружение и обработка сбоев в работе устройств

**Поддержка протоколов и платформ:**
- Apple HealthKit (iOS) - синхронизация данных о здоровье
- Google Fit (Android) - интеграция с экосистемой Google
- Fitbit API - работа с фитнес-трекерами Fitbit
- Garmin Connect - импорт данных с устройств Garmin
- Стандартные протоколы: Bluetooth Low Energy (BLE), ANT+

#### Бизнес-правила:
- Подтверждение соответствия устройств медицинским стандартам (CE, FDA)
- Валидация диапазонов измерений для каждого типа датчика
- Требование повторной калибровки при смене пользователя устройства
- Автоматическое отключение неисправных или неподдерживаемых устройств

#### Доменные события:
- `DeviceConnected` → начало калибровки, синхронизация исторических данных
- `DeviceCalibrated` → применение калибровочных коэффициентов, валидация
- `DeviceDisconnected` → остановка потока данных, уведомление пользователя
- `DeviceErrorDetected` → генерация предупреждения, рекомендации по устранению

### 3.2 Мониторинг здоровья и оповещения (Агрегат `HealthMetric`)

**Агрегат-корень:** `HealthMetric`
**Сервисы:** HealthMonitoringService, AlertService

#### Функции:

**Сбор и обработка медицинских данных:**
- Регулярный сбор показателей здоровья (пульс, кислород в крови, давление)
- Агрегация данных за разные периоды (час, день, неделя, месяц)
- Нормализация данных для сравнения с возрастными и половыми нормами
- Выявление трендов и долгосрочных изменений в показателях

**Система оповещений и рекомендаций:**
- Мониторинг критических значений показателей (высокий/низкий пульс, гипоксия)
- Генерация предупреждений при обнаружении аномалий или опасных трендов
- Персонализированные рекомендации по улучшению показателей здоровья
- Интеграция с тревожными кнопками и экстренными службами (при необходимости)

**Анализ и отчётность по здоровью:**
- Формирование еженедельных отчётов о состоянии здоровья
- Сравнение показателей с предыдущими периодами и целевыми значениями
- Оценка эффективности тренировок на основе показателей восстановления
- Прогнозирование возможных проблем на основе исторических данных

#### Бизнес-правила:
- Критические значения пульса: ниже 40 BPM или выше 220 - возраст
- Критический уровень кислорода в крови: ниже 90% (для большинства пользователей)
- Обязательное подтверждение получения критических оповещений
- Хранение медицинских данных с усиленным шифрованием и доступом

#### Доменные события:
- `HealthMetricRecorded` → валидация, агрегация, проверка на аномалии
- `CriticalAlertTriggered` → уведомление пользователя и (опционально) контактов
- `HealthTrendDetected` → обновление рекомендаций, корректировка тренировочного плана
- `RecoveryMetricsUpdated` → расчёт времени восстановления, адаптация нагрузок

---

## 4. Commerce & Recommendations Context

### 4.1 Управление продуктами и инвентарём (Агрегат `Product`)

**Агрегат-корень:** `Product`
**Сервисы:** ProductCatalogService, InventoryManagementService

#### Функции:

**Каталог спортивных товаров:**
- Ведение каталога продукции компании (одежда, обувь, инвентарь)
- Управление категориями, фильтрами и атрибутами товаров
- Обновление информации о наличии, ценах и характеристиках
- Поддержка региональных вариаций товаров и цен

**Отслеживание износа и рекомендации по замене:**
- Мониторинг использования спортивной экипировки пользователями
- Расчёт износа на основе тренировочной статистики (километраж, время, тип активности)
- Автоматические рекомендации по замене изношенной экипировки
- Интеграция с историей покупок для точного расчёта срока службы

**Управление промоакциями:**
- Создание и настройка промоакций (скидки, акции, специальные предложения)
- Привязка акций к типам тренировок или спортивным событиям
- Географическое и временное ограничение промоакций
- Анализ эффективности акций и коэффициента конверсии

#### Бизнес-правила:
- Расчёт износа обуви: замена рекомендуется после 800-1000 км бега
- Проверка совместимости товаров с типами тренировок пользователя
- Минимальный порог для рекомендаций: 70% износа или 80% от среднего срока службы
- Автоматическое обновление цен при синхронизации с системой компании

#### Доменные события:
- `ProductAddedToCatalog` → индексация для поиска, обновление рекомендаций
- `InventoryUpdated` → пересчёт рекомендаций, уведомление о наличии
- `WearLevelCalculated` → проверка порогов, генерация рекомендаций по замене
- `PromotionActivated` → уведомление пользователей, применение скидок

### 4.2 Персонализированные рекомендации (Агрегат `Recommendation`)

**Агрегат-корень:** `Recommendation`
**Сервисы:** RecommendationEngine, PersonalizationService

#### Функции:

**Генерация рекомендаций тренировок:**
- Анализ истории тренировок и прогресса пользователя
- Рекомендации тренировок на основе целей (похудение, выносливость, сила)
- Персонализация планов с учётом доступного времени и инвентаря
- Адаптация рекомендаций на основе обратной связи и выполнения

**Рекомендации экипировки и товаров:**
- Анализ текущего инвентаря и уровня его износа
- Подбор товаров, соответствующих спортивным интересам и целям
- Рекомендации на основе сезонности и погодных условий
- Учёт бюджета пользователя и предпочтений по брендам

**Социальные рекомендации:**
- Подбор друзей с общими спортивными интересами и уровнем подготовки
- Рекомендации групп и сообществ по видам спорта и геолокации
- Предложения совместных тренировок и мероприятий
- Рекомендации контента (статьи, видео, тренировочные программы)

**Модели машинного обучения:**
- Collaborative filtering для товаров и тренировок
- Content-based filtering для точного подбора по характеристикам
- Graph neural networks для социальных рекомендаций
- Reinforcement learning для адаптации рекомендаций в реальном времени

#### Бизнес-правила:
- Вес рекомендаций: 70% на основе истории, 30% на основе социального графа
- Минимальная история для персонализации: 5 тренировочных сессий
- Обновление моделей машинного обучения: ежедневное пакетное обучение
- Конфиденциальность данных: анонимизация для обучения моделей

#### Доменные события:
- `RecommendationGenerated` → кэширование, отправка пользователю
- `ProductViewed` → обновление моделей, учёт интересов
- `RecommendationAccepted` → учёт в будущих рекомендациях, начисление баллов
- `TrainingCompleted` → обновление моделей на основе результатов

---
## 5. Event Management & Order Processing Context 

### 5.1 Управление заказами с Event Sourcing (Агрегат `Order`)

**Агрегат-корень:** `Order` (реализован как Akka Actor)
**Сервисы:** OrderService, EventSourcingManager

#### Функции:

**Event Sourcing для заказов:**
- Хранение всех изменений заказа как последовательности доменных событий
- Восстановление состояния заказа через реплей событий
- Создание снапшотов для оптимизации производительности
- Публикация доменных событий для аналитики и других сервисов

**Жизненный цикл заказа:**
- Создание заказа с идемпотентным ключом (Idempotency-Key)
- Резервирование товаров через Inventory Service
- Обработка платежей через Payment Service
- Подтверждение и выполнение заказа
- Отмена и компенсирующие транзакции

**Аналитика воронки продаж:**
- Отслеживание конверсии на каждом этапе (просмотр → корзина → оформление → оплата)
- Анализ причин отмен заказов
- Измерение времени на каждом этапе процесса
- Сегментация клиентов по поведенческим паттернам

#### Бизнес-правила:
- Идемпотентность всех операций с заказами через Idempotency-Key
- TTL для резервирования товаров: 30 минут
- Автоматическая отмена при истечении TTL резервирования
- Гарантированная однопоточность обработки команд для каждого заказа (Actor Model)

#### Доменные события:
- `OrderCreated` → запуск процесса резервирования товаров
- `OrderConfirmed` → подтверждение платежа, обновление статуса
- `OrderCancelled` → запуск компенсирующих транзакций
- `OrderFulfilled` → уведомление пользователя, обновление инвентаря

### 5.2 Обработка платежей (Агрегат `Payment`)

**Агрегат-корень:** `Payment` (реализован как Akka Actor)
**Сервисы:** PaymentProcessor, FraudDetectionService

#### Функции:

**Обработка финансовых операций:**
- Поддержка multiple payment methods (карты, Apple Pay, PayPal)
- Проведение транзакций с гарантией идемпотентности
- Возвраты и частичные refunds
- Сверка с платежными провайдерами

**Обнаружение мошенничества:**
- Анализ паттернов транзакций в реальном времени
- Выявление аномальных операций (много мелких платежей, разные карты)
- Интеграция с внешними anti-fraud системами
- Блокировка подозрительных операций

**Аналитика платежей:**
- Сравнение конверсии по разным методам оплаты
- Оптимизация комиссий на основе данных
- Отслеживание успешности транзакций
- Аудит всех финансовых операций

#### Бизнес-правила:
- Максимальная сумма транзакции: 50,000 USD (или эквивалент)
- Минимальный интервал между одинаковыми транзакциями: 10 секунд
- Обязательная проверка CVV/CVC для карточных платежей
- Автоматическая блокировка при 3 неудачных попытках оплаты

#### Доменные события:
- `PaymentInitiated` → начало обработки платежа
- `PaymentCompleted` → успешная транзакция, обновление статуса заказа
- `PaymentFailed` → уведомление пользователя, повторная попытка
- `PaymentRefunded` → возврат средств, обновление финансовой отчетности

## 6. Inventory Management Context 

### 6.1 Управление запасами (Агрегат `ProductStock`)

**Агрегат-корень:** `ProductStock` (реализован как Akka Actor)
**Сервисы:** InventoryService, StockReservationManager

#### Функции:

**Управление остатками товаров:**
- Отслеживание доступного количества на складах
- Резервирование товаров для заказов с TTL
- Автоматическое освобождение резервов по истечении времени
- Синхронизация остатков между регионами

**Оптимизация складских запасов:**
- Прогнозирование спроса на основе исторических данных
- Рекомендации по пополнению запасов
- Управление страховыми запасами (safety stock)
- Аналитика оборачиваемости товаров

**Геораспределенное управление:**
- Репликация данных о запасах между регионами
- Локальные резервирования для минимизации задержек
- Межрегиональные трансферы товаров
- Согласованность eventual consistency

#### Бизнес-правила:
- TTL резервирования: 30 минут (автоматическое освобождение)
- Минимальный страховой запас: 10% от среднемесячного спроса
- Приоритет локальных резервирований перед межрегиональными
- Запрет отрицательных остатков (за исключением резервирований)

#### Доменные события:
- `StockReserved` → уменьшение доступного количества, уведомление о резерве
- `StockReleased` → освобождение товаров, увеличение доступного количества
- `LowStockAlert` → уведомление о необходимости пополнения
- `InventoryUpdated` → синхронизация между регионами, обновление кэшей

## 7. Analytics & Reporting Context 

### 7.1 CQRS для аналитики (Read Models)

**Read models:** `CustomerFunnel`, `SalesDashboard`, `UserBehavior`
**Сервисы:** AnalyticsQueryService, ReportGenerator

#### Функции:

**CQRS-архитектура:**
- **Write side:** Прием событий из других сервисов через Kafka
- **Read side:** Оптимизированные read models в ClickHouse
- **Eventual consistency:** Асинхронное обновление read models
- **Materialized views:** Предрасчитанные агрегации для быстрых запросов

**Real-time аналитика:**
- Дашборды для менеджеров в реальном времени
- Мониторинг ключевых метрик (DAU, MAU, конверсия)
- A/B тестирование новых функций
- Прогнозирование трендов и спроса

**Глубокий анализ данных:**
- Построение воронок продаж
- Сегментация пользователей по поведению
- Анализ эффективности маркетинговых кампаний
- Выявление паттернов и аномалий

#### Бизнес-правила:
- Задержка обновления read models: не более 5 секунд
- Хранение детализированных данных: 30 дней в ClickHouse
- Агрегированные данные: 5 лет для долгосрочного анализа
- Анонимизация данных для аналитики (GDPR compliance)

#### Доменные события (потребление):
- Потребляет: `OrderCreated`, `PaymentCompleted`, `UserRegistered` и др.
- Генерирует: `ReportGenerated`, `InsightDiscovered`, `AnomalyDetected`

----

## 8. Поддерживающие домены (Supporting Domains)

### 8.1 Геймификация (Агрегаты `Achievement`, `Leaderboard`)

**Агрегаты-корни:** `Achievement`, `Leaderboard`
**Сервисы:** GamificationEngine, RewardService

#### Функции:

**Система достижений и бейджей:**
- Определение условий для получения достижений (количество, качество, регулярность)
- Автоматическая проверка выполнения условий при каждом значимом событии
- Награждение пользователей виртуальными бейджами и званиями
- Отображение коллекции достижений в профиле

**Рейтинговые таблицы и уровни:**
- Расчёт рейтинга пользователей на основе активности и результатов
- Обновление позиций в лидербордах в реальном времени
- Система уровней с нелинейным прогрессом и бонусами за новые уровни
- Разделение лидербордов по регионам, возрастам и видам спорта

**Челленджи и соревнования:**
- Создание временных и постоянных челленджей (личных и групповых)
- Регистрация участников и отслеживание прогресса в челленджах
- Определение победителей и награждение призами (виртуальными и реальными)
- Интеграция с календарём спортивных событий

#### Бизнес-правила:
- Баланс системы наград: достижения должны быть сложными, но достижимыми
- Обновление лидербордов: ежечасное для активности, ежедневное для статистики
- Ограничение на количество активных челленджей: 3 одновременных на пользователя
- Прогресс в челленджах сохраняется даже при перерывах в участии

#### Доменные события:
- `AchievementUnlocked` → уведомление, публикация в ленте, начисление баллов
- `LeaderboardUpdated` → пересчёт позиций, уведомление об изменении ранга
- `ChallengeStarted` → приглашение друзей, создание группы для участников
- `ChallengeCompleted` → определение победителей, распределение наград

### 8.2 Уведомления и коммуникация (Агрегат `Notification`)

**Агрегат-корень:** `Notification`
**Сервисы:** NotificationService, MessagingService

#### Функции:

**Система уведомлений:**
- Управление подписками и предпочтениями уведомлений
- Очередь и планирование доставки уведомлений
- Шаблоны для различных типов уведомлений (персонализация)
- Отслеживание статуса доставки и открытия

**Многоуровневая доставка:**
- Push-уведомления для мобильных приложений (iOS/Android)
- Email-рассылки для важных событий и новостей
- In-app уведомления для внутриприложенных событий
- СМС-оповещения для критически важной информации

**Встроенная система сообщений:**
- Личные сообщения между пользователями
- Групповые чаты для команд и сообществ
- Обмен медиафайлами и документами
- Уведомления о новых сообщениях

#### Бизнес-правила:
- Частота уведомлений: не более 3 push-уведомлений в час
- Персонализация: использование имени и контекста в уведомлениях
- Отказ от подписки: однокликовая отписка от любого типа уведомлений
- Приоритетность: разделение на информационные, важные и критические

#### Доменные события:
- `NotificationScheduled` → добавление в очередь, планирование доставки
- `NotificationDelivered` → обновление статуса, метрики доставки
- `NotificationRead` → учёт в аналитике, обновление непрочитанных
- `MessageSent` → доставка получателю, уведомление о новом сообщении

### 8.3 Аналитика и бизнес-интеллект (Агрегат `Report`)

**Агрегат-корень:** `Report`
**Сервисы:** AnalyticsEngine, BusinessIntelligenceService

#### Функции:

**Пользовательская аналитика:**
- Сбор и агрегация метрик по пользователям и активности
- Анализ поведения и выявление паттернов
- Генерация персонализированных отчётов и инсайтов
- Прогнозирование трендов и рекомендаций

**Бизнес-аналитика:**
- Мониторинг ключевых показателей продукта (активность, удержание, конверсия)
- Анализ эффективности функций и A/B тестирование
- Отчётность для руководства и заинтересованных сторон
- Прогнозирование роста и планирование ресурсов

**Data Pipeline:**
- ETL-процессы для обработки больших объёмов данных
- Реализация data lake для хранения сырых и обработанных данных
- Интеграция с инструментами визуализации (Tableau, Power BI)
- Автоматизация отчётности и алертинга

#### Бизнес-правила:
- Анонимизация данных для аналитики в соответствии с GDPR
- Минимальный размер выборки для статистической значимости: 1000 пользователей
- Ежедневное обновление агрегированных метрик
- Хранение детализированных данных: 30 дней, агрегированных: 5 лет

#### Доменные события:
- `MetricsCollected` → агрегация, добавление в data lake
- `ReportGenerated` → сохранение, уведомление получателей
- `TrendIdentified` → генерация алертов, обновление прогнозов
- `AnomalyDetected` → расследование инцидента, уведомление команды

---

## 9. Инфраструктурные домены (Infrastructure Domains)

### 9.1 Управление транзакциями и идемпотентностью (Агрегат `Transaction`)

**Агрегат-корень:** `Transaction`
**Сервисы:** IdempotencyService, TransactionManager

#### Функции:

**Обеспечение идемпотентности операций:**
- Генерация и валидация Idempotency-Key (UUID v4)
- Кэширование результатов идемпотентных операций в Redis
- Автоматическая очистка устаревших ключей (TTL 24 часа)
- Интеграция с API Gateway через middleware

**Управление распределёнными транзакциями:**
- Оркестрация саг (Saga Orchestrator) для сложных бизнес-процессов
- Хранение состояний саг и управление компенсирующими действиями
- Обеспечение консистентности при откатах транзакций
- Интеграция с доменными событиями для хореографии саг

#### Бизнес-правила:
- Формат Idempotency-Key: UUID v4 (обязательный заголовок X-Idempotency-Key)
- Время жизни кэшированных результатов: 24 часа
- Максимальное время выполнения саги: 30 минут
- Автоматический откат при таймауте транзакции

#### Доменные события:
- `TransactionStarted` → начало оркестрации саги, блокировка ресурсов
- `TransactionCompleted` → фиксация изменений, очистка временных данных
- `TransactionCompensated` → выполнение компенсирующих действий
- `IdempotencyKeyUsed` → возврат кэшированного результата

### 9.2 Управление TTL и временными данными (Агрегат `TTLRecord`)

**Агрегат-корень:** `TTLRecord`
**Сервисы:** TTLManager, TemporaryDataService

#### Функции:

**Автоматическое управление временными данными:**
- Установка TTL для временных сущностей (корзины, резервирования, сессии)
- Автоматическое удаление устаревших записей в Redis
- Фоновая очистка истекших данных в БД
- Мониторинг и алертинг по аномальным TTL-паттернам

**Управление жизненным циклом данных:**
- Классификация данных по категориям TTL (короткие, средние, длинные)
- Автоматическая архивация данных перед истечением TTL
- Восстановление данных при преждевременном удалении
- Интеграция с системой резервного копирования

#### Бизнес-правила:
- TTL корзин покупок: 24 часа
- TRL резервирований товаров: 30 минут
- TTL ценовых сессий: 15 минут
- TTL сессий пользователей: 7 дней

#### Доменные события:
- `TTLSet` → установка времени жизни, планирование очистки
- `RecordExpired` → автоматическое удаление, нотификация (при необходимости)
- `TTLExtended` → продление времени жизни, обновление планировщика
- `TTLPolicyViolated` → алерт для администратора, исследование инцидента

### 9.3 Массовая обработка и очереди (Агрегат `BatchJob`)

**Агрегат-корень:** `BatchJob`
**Сервисы:** BatchProcessor, QueueManager

#### Функции:

**Обработка массовых операций:**
- Приём и буферизация запросов через Apache Kafka
- Пакетная обработка сообщений (batch processing)
- Автоматическое масштабирование воркеров на основе нагрузки
- Гарантированная доставка и обработка сообщений

**Управление очередями и приоритетами:**
- Приоритизация запросов (высокий, средний, низкий приоритет)
- Балансировка нагрузки между воркерами
- Мониторинг длины очередей и времени обработки
- Автоматическое перераспределение задач при сбоях

**Пессимистические блокировки:**
- Управление распределёнными блокировками через Redis
- Предотвращение конфликтов при доступе к ограниченным ресурсам
- Автоматическое освобождение блокировок при таймаутах
- Механизм продления блокировок для длительных операций

#### Бизнес-правила:
- Размер батча: 1000 сообщений или 30 секунд накопления
- Максимальное время удержания блокировки: 30 секунд
- Автоскейлинг воркеров: от 5 до 100 инстансов
- Максимальная длина очереди: 1 000 000 сообщений

#### Доменные события:
- `BatchReceived` → добавление в очередь, балансировка нагрузки
- `BatchProcessed` → обновление статуса, нотификация клиента
- `LockAcquired` → блокировка ресурса, начало операции
- `LockReleased` → освобождение ресурса, разрешение следующих операций

---
## 10. Event Infrastructure & Processing Context (Новый домен)

### 10.1 Event Sourcing Framework

**Компоненты:** EventStore, SnapshotStore, EventPublisher
**Сервисы:** EventStoreService, SnapshotManager

#### Функции:

**Хранение и управление событиями:**
- Event Store для persistence событий
- Управление снапшотами для оптимизации
- Реплей событий для восстановления состояния
- Миграция схем событий

**Публикация и подписка:**
- Публикация доменных событий в Kafka
- Подписка на события других сервисов
- Маршрутизация событий по топикам
- Гарантированная доставка и порядок

**Actor Model инфраструктура:**
- Akka Cluster для распределенных акторов
- Sharding агрегатов по идентификаторам
- Supervision стратегии для отказоустойчивости
- Мониторинг состояния акторов

#### Бизнес-правила:
- Retention событий: 7 лет для аудита
- Частота снапшотов: каждые 100 событий
- Гарантии доставки: at-least-once
- Порядок событий: guaranteed per aggregate

### 10.2 Разделение потоков событий

**Топики Kafka:**
- `business.orders` - события заказов (для аналитики)
- `business.payments` - финансовые события (для аудита)
- `business.inventory` - события запасов (для синхронизации)
- `technical.metrics` - метрики производительности
- `technical.audit` - события аудита (для compliance)

**Обработчики событий:**
- **Analytics Processors:** Обновление read models в ClickHouse
- **Report Processors:** Генерация отчетов в MongoDB
- **Cache Processors:** Обновление кэшей в Redis
- **Integration Processors:** Синхронизация с внешними системами


## Заключение

Функциональное представление архитектуры, организованное по принципам Domain-Driven Design, обеспечивает:

1. **Чёткое разделение ответственности** - каждый ограниченный контекст отвечает за свою область бизнес-логики
2. **Масштабируемость команд** - команды могут работать независимо над разными контекстами
3. **Гибкость архитектуры** - возможность независимой эволюции отдельных частей системы
4. **Покрытие бизнес-требований** - все функциональные требования реализованы через агрегаты и сервисы
5. **Поддержание целостности данных** - бизнес-правила инкапсулированы внутри агрегатов
6. **Надёжность распределённых операций** - инфраструктурные домены обеспечивают идемпотентность, управление транзакциями и массовую обработку

Данное представление служит основой для детального проектирования, реализации и тестирования системы.



