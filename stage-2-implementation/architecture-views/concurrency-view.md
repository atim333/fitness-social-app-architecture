# Представление многозадачности (Concurrency View)

## Обзор параллелизма в DDD-ориентированной системе

### Контекст и требования

Фитнес-социальное приложение построено на принципах Domain-Driven Design и должно поддерживать глобальную аудиторию с разнообразными сценариями использования.

**Ключевые требования к параллелизму в DDD-контексте:**

- **Конкурентное обновление агрегатов:** Одновременные изменения одних и тех же агрегатов разными пользователями.
- **Геораспределённость:** Обработка событий в разных регионах с минимальной задержкой.
- **Согласованность между ограниченными контекстами:** Eventual consistency через доменные события.
- **Массовые события:** Обработка тысяч одновременных участников в соревнованиях и челленджах.
- **Потоковая обработка телеметрии:** Данные с фитнес-устройств в реальном времени.

### Классификация рабочих нагрузок по DDD-контекстам

| Ограниченный контекст | Тип нагрузки | Параллелизм | Консистентность |
|-----------------------|--------------|-------------|-----------------|
| **User & Social**     | Высокочастотные обновления | Оптимистичные блокировки | Eventual |
| **Activity & Training** | Потоковая обработка | Шардирование по пользователям | Session |
| **Health & Device**   | Real-time данные | Конкурентные обновления | Strong |
| **Commerce & Recommendations** | Фоновые вычисления | Изоляция ресурсов | Eventual |

---

## 1. DDD и конкурентность: Основные принципы

### 1.1 Управление состоянием агрегатов

**Агрегаты как границы консистентности:**

- Каждый агрегат обрабатывается в рамках одной транзакции.
- Агрегат-корень гарантирует инварианты всей совокупности сущностей.
- Внешние ссылки только на идентификаторы агрегатов-корней.

**Версионирование агрегатов для конкурентного контроля:**

- Оптимистичные блокировки через поле `version` в каждом агрегате.
- При каждом изменении агрегата версия увеличивается.
- Если версия при обновлении не совпадает с ожидаемой, возникает конфликт параллелизма.

**Пример сценария:** Два устройства одновременно отправляют данные тренировки для одного пользователя. Система обнаруживает конфликт версий и применяет стратегию слияния или уведомляет пользователя.

### 1.2 Доменные события и eventual consistency

**Механизм согласованности между контекстами:**

- Асинхронная публикация доменных событий при изменении агрегатов.
- Потребители событий обновляют свои проекции данных.
- Гарантии доставки: At-least-once семантика.

**Пример цепочки событий для социального взаимодействия:**

1. Пользователь завершает тренировку → `TrainingSession` публикует `WorkoutCompleted`.
2. `SocialGraphService` получает событие → обновляет ленту активности.
3. `GamificationEngine` получает событие → начисляет баллы.
4. `RecommendationService` получает событие → обновляет модели.

### 1.3 Изоляция транзакций по ограниченным контекстам

**Каждый ограниченный контекст имеет свою стратегию управления транзакциями:**

- **User & Social Context:** Короткие транзакции с оптимистичными блокировками.
- **Activity & Training Context:** Длинные транзакции (сессии тренировок) с компенсирующими операциями.
- **Health & Device Context:** Транзакции с гарантией доставки и подтверждением.
- **Commerce & Recommendations Context:** Саги для распределённых транзакций.

---

## 2. Обработка потоковых данных с фитнес-устройств

### 2.1 Архитектура потоковой обработки

**Поток данных:** Источники событий → Обработчики потоков → Стоки данных.

**Источники событий:**

- Датчики фитнес-устройств: Пульс (1-100 Гц), GPS (1 Гц), акселерометр (50 Гц), шагомер.
- Действия пользователей: Старт/стоп тренировки, изменение целей, просмотр контента.
- Социальные взаимодействия: Лайки, комментарии, подписки, сообщения, челленджи.
- Системные события: Уведомления, напоминания, обновления статуса, системные метрики.
- Внешние данные: Погодные условия, картографическая информация, спортивные события.

**Обработчики потоков:**

**Типы обработчиков:**

1. **Real-time агрегаторы:**
   - Мгновенный расчет статистики тренировок (текущий темп, сожженные калории).
   - Мониторинг физиологических показателей в реальном времени.
   - Определение достижений и рекордов по мере поступления данных.

2. **Оконные процессоры:**
   - **Фиксированные окна:** Статистика за 1 секунду, 1 минуту, 5 минут, 1 час.
   - **Скользящие окна:** Средние значения за последние N измерений.
   - **Сессионные окна:** Обработка данных в рамках одной тренировочной сессии.
   - **Tumbling windows:** Агрегация по календарным интервалам (день, неделя, месяц).

3. **Корреляционные движки:**
   - Выявление взаимосвязей между разными типами событий.
   - Обнаружение паттернов поведения (регулярность тренировок, прогресс).
   - Определение социального влияния (как активность друзей влияет на мотивацию).

4. **Обогатители данных:**
   - Добавление контекстной информации из профилей пользователей.
   - Обогащение геоданных информацией о местности и погоде.
   - Привязка событий к спортивному инвентарю и оборудованию.

**Стоки данных:**

**Многоуровневое хранение:**

1. **Горячий слой (Hot Storage):**
   - **In-memory базы:** Текущие активные сессии, онлайн-статусы.
   - **SSD-оптимизированные БД:** Последние 24 часа данных, часто запрашиваемая статистика.
   - **Кэши L1/L2:** Персональные рекорды, прогресс друзей, актуальные лидерборды.

2. **Теплый слой (Warm Storage):**
   - **Column-store БД:** Данные за последние 30 дней для аналитических запросов.
   - **Search-индексы:** Полнотекстовый поиск по историческим данным.
   - **Графовые БД:** Социальные связи и взаимодействия.

3. **Холодный слой (Cold Storage):**
   - **Data Lake:** Сырые события за весь период (5+ лет).
   - **Архивное хранилище:** Агрегированные данные для долгосрочной аналитики.
   - **Backup системы:** Резервные копии для восстановления.
  
   ### 2.2 Стратегии обработки потоков

**Гарантии доставки:**

- **Exactly-once:** Для финансовых операций и начисления баллов.
- **At-least-once:** Для статистики тренировок и социальных событий.
- **Best-effort:** Для некритичных системных метрик.

**Механизмы обработки сбоев:**

- **Чекпойнты (Checkpointing):** Регулярное сохранение состояния обработки.
- **Водяные знаки (Watermarks):** Отслеживание полноты данных в окнах.
- **Dead Letter Queues:** Изоляция необрабатываемых сообщений для анализа.

**Оптимизации производительности:**

- **Микробатчинг (Micro-batching):** Группировка событий для эффективной записи.
- **Компрессия данных:** Уменьшение объема передаваемой информации.
- **Предиктивная загрузка:** Предварительная загрузка данных на основе паттернов доступа.

### 2.3 Сценарии использования потоковой обработки

**Real-time дашборды тренировок:**

- Отображение текущих показателей во время тренировки.
- Сравнение с предыдущими результатами в реальном времени.
- Анализ эффективности по зонам пульса.

**Социальные уведомления:**

- Мгновенные оповещения о достижениях друзей.
- Real-time обновления в групповых челленджах.
- Интерактивные трансляции тренировок.

**Адаптивные рекомендации:**

- Динамическая корректировка планов тренировок.
- Персонализированные советы на основе текущего состояния.
- Предупреждения о потенциальных рисках (перетренированность).

**Мониторинг событий:**

- Отслеживание массовых спортивных мероприятий.
- Анализ географического распределения активности.
- Выявление аномальных паттернов использования.

---

## 3. Управление состоянием и синхронизация в DDD

### 3.1 Модели консистентности данных

**Стратегии для разных типов данных:**

- **Строгая консистентность:** Пользовательские профили, финансовые транзакции.
- **Eventual consistency:** Социальные взаимодействия, лайки, комментарии.
- **Session consistency:** Данные активной тренировки, временные метрики.
- **Causal consistency:** Цепочки сообщений, поток активности.
- 
### 3.2 Механизмы синхронизации

**Оптимистичные блокировки:**

- **Применение:** Обновление статистики, рейтингов, достижений.
- **Механизм:** Версионирование записей, проверка перед записью.
- **Разрешение конфликтов:** Last write wins с меткой времени, слияние изменений.

**Распределённые транзакции:**

- **Паттерн Saga:** Для бизнес-транзакций, затрагивающих несколько сервисов.
- **Компенсирующие операции:** Откат через обратные действия.
- **Идемпотентность:** Гарантия безопасного повторного выполнения.

**Шардированные агрегаты:**

- **Геошардирование:** Данные пользователей по регионам.
- **Временное шардирование:** Данные тренировок по временным диапазонам.
- **Хэш-шардирование:** Равномерное распределение нагрузки.

### 3.3 Стратегии синхронизации для агрегатов

**Оптимистичные блокировки для агрегатов:**

- Каждый агрегат содержит поле `version` для контроля изменений.
- При обновлении проверяется, что версия не изменилась с момента чтения.
- При конфликте версий система предлагает пользователю разрешить конфликт или повторяет операцию.

**Пессимистичные блокировки для критических операций:**

- Используются для операций, где конфликты недопустимы.
- Короткое время удержания блокировки для минимизации влияния на производительность.
- Автоматическое освобождение блокировки при таймауте.

**Event sourcing для отслеживания изменений:**

- Все изменения состояния сохраняются как последовательность событий.
- Возможность воспроизведения событий для восстановления состояния.
- Аудит всех изменений и возможность отката к предыдущим состояниям.

### 3.4 Стратегии для массовых событий

**Подготовка к массовым соревнованиям:**

1. **Предварительное масштабирование:** Увеличение мощности за 24 часа до события.
2. **Шардирование данных:** Распределение участников по разным шардам.
3. **Локальные кэши:** Кэширование общих данных на edge-локациях.
4. **Упрощённая логика:** Включение degraded mode для сложных вычислений.

**Обработка пиковых нагрузок:**

- **Динамическое масштабирование:** Автоматическое добавление ресурсов.
- **Rate limiting:** Ограничение запросов для защиты от перегрузки.
- **Приоритетная обработка:** Критичные операции обрабатываются в первую очередь.
- **Асинхронная обработка:** Отложенная обработка некритичных задач.

---

## 4. Очереди сообщений и планирование задач

### 4.1 Многоуровневая система очередей

**Приоритетные очереди:**

- **Высокий приоритет:** Уведомления в реальном времени, экстренные оповещения.
- **Средний приоритет:** Социальные взаимодействия, обновления ленты.
- **Низкий приоритет:** Аналитические задачи, email-рассылки, бэкапы.

**Стратегии обработки:**

- **Round Robin:** Равномерное распределение между воркерами.
- **Least Connections:** Направление в наименее загруженный обработчик.
- **Sticky Sessions:** Привязка пользовательских событий к конкретному воркеру.

**Мониторинг очередей:**

- **Длина очереди:** Количество ожидающих обработки сообщений.
- **Время ожидания:** Среднее время нахождения сообщения в очереди.
- **Процент отказов:** Сообщения, которые не удалось обработать.
- **Скорость обработки:** Количество обработанных сообщений в единицу времени.

### 4.2 Распределённые планировщики

**Типы запланированных задач:**

- **Периодические:** Ежечасное обновление лидербордов, ежедневная статистика.
- **Отложенные:** Напоминания о тренировках, отложенные уведомления.
- **Зависимые:** Цепочки задач с условиями выполнения.

**Гарантии выполнения:**

- **At least once:** Критичные бизнес-процессы.
- **At most once:** Статистические вычисления, аналитика.
- **Exactly once:** Финансовые операции, начисления баллов.

### 4.3 Мониторинг производительности

**Ключевые метрики параллелизма:**

- **Throughput:** Количество обработанных запросов/событий в секунду.
- **Concurrency:** Количество одновременных подключений/обработчиков.
- **Queue depth:** Длина очередей сообщений и задач.
- **Processing lag:** Задержка обработки событий от момента генерации.

**Метрики ресурсов:**

- **Thread pool utilization:** Загрузка пулов потоков обработки.
- **Connection pool stats:** Использование пулов соединений к БД и внешним сервисам.
- **Memory pressure:** Использование памяти для кэшей и буферов.

---

## 5. Масштабирование и балансировка нагрузки

### 5.1 Стратегии горизонтального масштабирования

**Метрики для автомасштабирования:**

- **CPU/Memory utilization:** Порог 70% для масштабирования вверх.
- **Request rate:** Количество запросов в секунду на инстанс.
- **Queue length:** Длина очереди сообщений для обработчиков событий.
- **P95 latency:** 95-й процентиль времени ответа.

**Политики масштабирования:**

- **Predictive scaling:** Предсказание нагрузки на основе расписания событий.
- **Reactive scaling:** Реакция на текущие метрики нагрузки.
- **Scheduled scaling:** Плановое увеличение мощности для известных событий.

### 5.2 Глобальная балансировка нагрузки

**Geo-based routing:**

- **DNS-based:** Перенаправление на ближайший регион.
- **Anycast:** Распределение на уровне сети.
- **Application-level:** Определение региона по заголовкам запроса.

**Стратегии балансировки внутри региона:**

- **Least Connections:** Для долгоживущих соединений WebSocket.
- **Round Robin:** Для stateless HTTP запросов.
- **IP Hash:** Для привязки сессий пользователей.

---

## 6. Защита от перегрузок

### 6.1 Rate Limiting политики

**Per user limits:**

- 100 запросов/минуту для API endpoints.
- 50 запросов/минуту для социальных взаимодействий.
- 10 запросов/минуту для операций с финансовыми данными.

**Per IP limits:**

- 1000 запросов/минуту для защиты от ботов.
- 500 запросов/минуту для неаутентифицированных запросов.
- 200 запросов/минуту для сканирования данных.

**Burst allowance:**

- Кратковременное превышение лимитов для легитимных пользователей.
- Плавное восстановление после всплеска активности.
- Динамическая корректировка лимитов на основе поведения.

### 6.2 Circuit Breaker паттерны

**Три состояния:**

- **Closed:** Нормальная работа, все запросы проходят.
- **Open:** Сервис недоступен, запросы не проходят.
- **Half-Open:** Ограниченное количество запросов для проверки восстановления.

**Метрики срабатывания:**

- **Процент ошибок:** При превышении 50% в течение 30 секунд.
- **Время ответа:** При превышении 5 секунд для 95% запросов.
- **Количество таймаутов:** Более 10 таймаутов в минуту.

**Восстановление:**

- Постепенное возобновление трафика после восстановления сервиса.
- Экспоненциальная отсрочка между попытками.
- Мониторинг стабильности после возврата в нормальное состояние.

### 6.3 Bulkhead изоляция

**Разделение ресурсов:**

- **Пул потоков:** Отдельные пулы для разных типов операций.
- **Connection pools:** Раздельные соединения для критичных и некритичных сервисов.
- **Очереди сообщений:** Изоляция трафика разных функциональных областей.

**Преимущества изоляции:**

- **Локализация сбоев:** Проблемы в одном компоненте не влияют на другие.
- **Predictable performance:** Гарантированные ресурсы для критичных операций.
- **Graceful degradation:** Постепенное ухудшение функциональности при перегрузках.

---

## 7. Мониторинг и observability

### 7.1 Distributed tracing

**Трассировка запросов:**

- **End-to-end tracing:** Отслеживание запросов через все сервисы.
- **Dependency mapping:** Автоматическое построение карты зависимостей.
- **Latency analysis:** Выявление узких мест в цепочке обработки.
- **Error correlation:** Связь ошибок с конкретными запросами и пользователями.

**Инструменты:**

- **OpenTelemetry:** Стандарт для сбора телеметрии.
- **Jaeger:** Хранение и визуализация трейсов.
- **Prometheus:** Сбор метрик производительности.
- **Grafana:** Визуализация метрик и создание дашбордов.

### 7.2 Алертинг и реагирование

**Уровни алертов:**

- **Critical:** Немедленное реагирование, остановка бизнес-процессов.
- **Warning:** Требует внимания, но не останавливает работу.
- **Info:** Информационные сообщения для анализа.

**Процесс реагирования:**

1. **Обнаружение:** Система мониторинга обнаруживает аномалию.
2. **Эскалация:** Уведомление ответственной команды.
3. **Диагностика:** Анализ причин проблемы.
4. **Восстановление:** Применение исправлений.
5. **Постмортем:** Анализ инцидента и предотвращение повторения.

---

## 8. Стратегии устойчивости к ошибкам

### 8.1 Экспоненциальная отсрочка

**Параметры повторных попыток:**

- **Базовая задержка:** 100 мс с экспоненциальным увеличением до 10 секунд.
- **Максимальное количество попыток:** 5 для пользовательских операций, 10 для системных.
- **Jitter:** Случайная добавка для предотвращения синхронизации повторных попыток.

**Условия повторения:**

- **Transient errors:** Таймауты, временная недоступность, сетевые сбои.
- **Non-retryable errors:** Ошибки валидации, недостаток прав, логические ошибки.
- **Circuit breaker integration:** Прекращение повторных попыток при открытом circuit breaker.

### 8.2 Graceful degradation

**Стратегии деградации:**

- **Отключение не критичных функций:** Сложные рекомендации, детальная аналитика.
- **Упрощение расчетов:** Аппроксимация статистики, кэширование лидербордов.
- **Fallback стратегии:** Возврат закэшированных данных при недоступности сервиса.
- **Ограничение функциональности:** Временное отключение социальных функций для сохранения основных.

**Приоритеты при деградации:**

1. **Безопасность и конфиденциальность:** Не должны быть нарушены.
2. **Основные функции:** Тренировки и сбор данных.
3. **Социальные функции:** Лента активности, группы, друзья.
4. **Расширенные возможности:** Рекомендации, аналитика, геймификация.

---

## Заключение

Архитектура параллелизма фитнес-социального приложения построена на принципах Domain-Driven Design и обеспечивает:

1. **Конкурентную обработку агрегатов** через оптимистичные блокировки и версионирование.
2. **Eventual consistency между ограниченными контекстами** через доменные события.
3. **Масштабируемость до миллионов пользователей** через горизонтальное шардирование.
4. **Устойчивость к пиковым нагрузкам** через circuit breakers, rate limiting и graceful degradation.
5. **Наблюдаемость и мониторинг** через distributed tracing и комплексные метрики.

Данная архитектура позволяет системе эффективно обрабатывать массовые события, поддерживать глобальную аудиторию и обеспечивать высокую доступность при любых нагрузках.
