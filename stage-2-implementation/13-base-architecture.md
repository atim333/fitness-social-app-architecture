# 13. Базовая архитектура системы

## Обзор

Базовая архитектура описывает детализированную структуру системы с учетом бизнес-требований, нефункциональных требований, выбранных архитектурных опций и атрибутов качества. Архитектура построена на принципах Domain-Driven Design (DDD), что позволяет четко отразить бизнес-процессы и обеспечить гибкость системы.

## Детализация критических технических решений

### 2.1. Обеспечение Идемпотентности (Idempotency-Key)

**Цель:** Гарантировать, что повторный вызов API с тем же ключом не приведет к дублированию операций (критично для платежей, создания заказов, регистрации действий).

**Архитектурное решение:**

**Архитектурные компоненты:**

- API Gateway (Kong/Envoy) с кастомным middleware
- Redis Cluster для хранения ключей и результатов
- Сервисы бэкенда, поддерживающие идемпотентные операции

**Последовательность обработки запроса:**

1. Клиент отправляет запрос с заголовком X-Idempotency-Key
2. API Gateway проверяет ключ в Redis
3. Если ключ новый, запрос передается в Order Service
4. Order Service вызывает Cart Service для получения корзины
5. Order Service вызывает Pricing Service для проверки цен
6. Order Service вызывает Inventory Service для резервирования товаров
7. Результат сохраняется в Redis с TTL 24 часа
8. Клиент получает ответ

### 2.2. Механизмы TTL (Time-To-Live) для Временных Данных

**Цель:** Автоматическая очистка устаревших данных (резервирования, сессии, кэши).

**Архитектурное решение:**

**Уровни реализации:**

1. **Уровень кэша (Redis):** Нативное использование команд EXPIRE
   - Резервирования товаров: 30 минут
   - Корзины покупок: 24 часа
   - Сессии пользователей: 7 дней
   - Ценовые сессии: 15 минут

2. **Уровень базы данных:**
   - Поля expires_at во всех временных сущностях
   - Фоновые джобы (cron) для очистки истекших записей
   - Индексы по полю expires_at для эффективной очистки

3. **Уровень приложения:**
   - Сервисы периодически проверяют и отменяют устаревшие операции
   - Компенсирующие транзакции для отката устаревших резервирований

### 2.3. Паттерны Компенсирующих Транзакций

**Цель:** Обеспечить консистентность данных в распределенных транзакциях без использования 2PC.

**Архитектурное решение:** Реализация паттерна Saga в двух вариантах:

**1. Оркестрируемая Saga (для сложных бизнес-процессов)**

- Пример: Создание заказа с резервированием товаров
- Компоненты: Saga Orchestrator, участвующие сервисы
- Хранение состояния: Отдельная БД для состояний саг

**2. Хореографическая Saga (для простых процессов)**

- Пример: Обновление социального рейтинга
- Механизм: Сервисы обмениваются событиями через Kafka
- Компенсация: Каждый сервис слушает события неудач и выполняет свои компенсирующие действия

### 2.4. Массовая Обработка и Управление Пиковой Нагрузкой

**Цель:** Обрабатывать тысячи одновременных регистраций на глобальные события.

**Архитектурное решение:**

- Очередь сообщений: Apache Kafka для буферизации входящих запросов
- Пул воркеров: Auto-scaling группа инстансов, обрабатывающих сообщения батчами
- Блокировки: Пессимистические блокировки через Redis для операций с ограниченными ресурсами
- Мониторинг: Отслеживание длины очереди, времени обработки, ошибок

### 2.5. Реализация Пессимистических Блокировок

**Цель:** Предотвратить конфликты при одновременном доступе к ограниченным ресурсам (места на события, инвентарь).

**Архитектурное решение:**

- Использование Redis в качестве распределенного хранилища блокировок
- Реализация алгоритма Redlock для распределенных блокировок
- Время жизни блокировки: 30 секунд (автоматическое освобождение при таймауте)
- Механизм автоматического продления блокировки для длительных операций

## Архитектурные принципы

### 1. Domain-Driven Design (DDD)

- **Ограниченные контексты:** Четкие границы вокруг каждой бизнес-области
- **Единый язык:** Общий язык между разработчиками и бизнесом
- **Агрегаты:** Инкапсуляция бизнес-правил и инвариантов
- **Доменные события:** Моделирование бизнес-событий как первоклассных концепций

### 2. Дифференцированный подход к согласованности данных

- **Строгая согласованность:** Для операций с финансами, бронированиями и инвентарем
- **Eventual Consistency:** Для социальных лент, рекомендаций и лидербордов
- **Read-your-writes гарантии:** Для пользовательских данных и настроек

### 3. Принцип разделения ответственности (Single Responsibility)

Каждый микросервис соответствует ограниченному контексту и отвечает за одну бизнес-возможность с четко определенным контрактом API.

### 4. Принцип слабой связанности (Loose Coupling)

Сервисы взаимодействуют через асинхронные доменные события (event-driven) и имеют минимальные синхронные зависимости.

### 5. Принцип устойчивости к сбоям (Resilience)

Система проектируется с учетом возможных сбоев и продолжает работать при частичных отказах, с Circuit Breaker для внешних зависимостей.

### 6. Принцип наблюдаемости (Observability)

Все компоненты системы обеспечивают метрики, логи и трассировку для мониторинга и отладки с использованием OpenTelemetry.

### 7. Принцип безопасности по дизайну (Security by Design)

Безопасность интегрирована на всех уровнях архитектуры, с Zero Trust подходом и многофакторной аутентификацией.

### 8. Стратегии управления транзакциями

- **Двухфазное резервирование:** Для критических операций бронирования
- **Компенсирующие транзакции:** Для отката распределенных операций
- **Пессимистические блокировки:** Для предотвращения конфликтов при работе с инвентарем

## Доменная архитектура (DDD-based)

### Ограниченные контексты и их соответствие сервисам

#### 1. **Identity & Authentication Context** (Core Domain)

**Бизнес-возможности:** Управление пользователями, аутентификация, авторизация, безопасность

**Сервисы:**

- **Identity Service** - Регистрация, аутентификация, управление сессиями
- **Authorization Service** - Управление правами доступа, RBAC/ABAC

**Ключевые агрегаты:**

- `User` (агрегат-корень): `userId`, `credentials`, `permissions`, `securitySettings`
- `Session` (агрегат-корень): `sessionId`, `userId`, `expiryTime`, `deviceInfo`
- `SecurityPolicy`: `policyId`, `rules`, `complianceRequirements`

**Инварианты:**

- Минимальная сложность пароля: 12 символов с спец. символами
- MFA обязательна для доступа к медицинским данным
- Максимальное количество активных сессий: 5 на пользователя

**Управление данными:**

- **Тип БД:** PostgreSQL с ACID-транзакциями
- **Уровень изоляции:** Repeatable Read для операций с учетными данными
- **Кэширование:** Redis для активных сессий с TTL 24 часа
- **Стратегия транзакций:** Локальные ACID транзакции с компенсирующими действиями

#### 2. **Workout & Training Context** (Core Domain)

**Бизнес-возможности:** Трекинг тренировок, анализ метрик, управление тренировочными планами

**Сервисы:**

- **Workout Tracking Service** - Запись и хранение тренировок
- **Training Analytics Service** - Анализ и сравнение метрик
- **Training Plan Service** - Создание и управление тренировочными планами

**Ключевые агрегаты:**

- `TrainingSession` (агрегат-корень): `sessionId`, `userId`, `exercises`, `metrics`, `routeData`
- `TrainingPlan`: `planId`, `workouts`, `schedule`, `progressionRules`
- `ProgressTracker`: `trackerId`, `userId`, `achievements`, `streaks`

**Бизнес-правила:**

- Валидация ЧСС: 40-220 BPM (с учетом возраста)
- Проверка GPS координат на корректность (широта: -90° до +90°, долгота: -180° до +180°)
- Расчет калорий по формуле MET × вес × время с валидацией пределов

**Управление данными:**

- **Тип БД:** MongoDB для гибкой схемы тренировок
- **Согласованность:** Eventual consistency (приемлема для истории тренировок)
- **Индексы:** Геопространственные индексы для маршрутов, составные индексы по времени
- **Кэширование:** Redis для активных тренировок с TTL 2 часа

#### 3. **Social & Community Context** (Core Domain)

**Бизнес-возможности:** Социальные взаимодействия, группы, общение, соревнования

**Сервисы:**

- **Social Graph Service** - Управление социальными связями
- **Community Service** - Создание и управление сообществами
- **Content Feed Service** - Лента активности и контента

**Ключевые агрегаты:**

- `SocialProfile` (агрегат-корень): `profileId`, `userId`, `connections`, `privacySettings`
- `CommunityGroup` (агрегат-корень): `groupId`, `members`, `content`, `moderationRules`
- `Challenge` (агрегат-корень): `challengeId`, `participants`, `rules`, `leaderboard`

**Инварианты:**

- Ограничение количества участников в группе: 5000
- Максимальное количество запросов в друзья: 50 в день
- Минимальный возраст для создания групп: 16 лет

**Управление данными:**

- **Тип БД:** PostgreSQL для социального графа + Redis для ленты новостей
- **Уровень изоляции:** Read Committed для большинства операций
- **Кэширование:** Многоуровневое (L1: локальный, L2: Redis, L3: БД)
- **Материализованные представления:** Для популярных запросов (топ групп, активные пользователи)

#### 4. **Health & Device Integration Context**

**Бизнес-возможности:** Интеграция медицинских устройств, сбор и валидация данных о здоровье, обработка медицинских метрик

**Сервисы:**

- **Device Integration Service** - Подключение и управление устройствами
- **Health Metrics Service** - Обработка и валидация медицинских данных
- **Alert Service** - Генерация оповещений о критических значениях

**Ключевые агрегаты:**

- `MedicalDevice` (агрегат-корень): `deviceId`, `type`, `calibrationData`, `certifications`, `connectionStatus`
- `HealthMetric`: `metricId`, `type`, `value`, `timestamp`, `validationStatus`, `deviceId`
- `MedicalAlert`: `alertId`, `severity`, `message`, `acknowledged`, `acknowledgedBy`

**Бизнес-правила:**

- Соответствие медицинским стандартам (ISO 13485, HIPAA, GDPR)
- Валидация данных по возрастным и гендерным нормам
- Автоматическое обнаружение аномалий с помощью статистических методов
- Требования к точности калибровки: ±2% для медицинских устройств

**Управление данными:**

- **Тип БД:** TimescaleDB (расширение PostgreSQL) для временных рядов
- **Уровень изоляции:** Serializable для критических медицинских записей
- **Хранение:** Холодные данные в S3-совместимом хранилище, горячие в TimescaleDB
- **Сжатие:** Автоматическое сжатие старых временных рядов
- **Архивация:** Автоматический перенос данных старше 2 лет в cold storage

#### 5. **Commerce & Promotions Context**

**Бизнес-возможности:** Управление товарами, промоакциями, интеграция с e-commerce, управление корзинами

**Сервисы:**

- **Product Catalog Service** - Управление каталогом товаров и инвентарем
- **Promotion Service** - Управление промоакциями и скидками
- **Shopping Cart Service** - Управление корзинами и сессиями покупок

**Ключевые агрегаты:**

- `Product` (агрегат-корень): `productId`, `sku`, `specifications`, `inventoryLevels`, `pricingTiers`
- `Promotion` (агрегат-корень): `promotionId`, `rules`, `discounts`, `conditions`, `validityPeriod`
- `ShoppingSession` (агрегат-корень): `cartId`, `userId`, `items`, `appliedPromotions`, `expiryTime`

**Бизнес-правила:**

- Минимальная цена со скидкой: 70% от оригинальной цены
- Региональные ограничения для промоакций
- Автоматическое применение лучшей доступной скидки
- Проверка наличия товара перед применением промокода

**Управление данными:**

- **Тип БД:** PostgreSQL для ACID-транзакций + Redis для сессий корзины
- **Уровень изоляции:** Repeatable Read с пессимистическими блокировками FOR UPDATE для операций с инвентарем
- **Синхронизация:** Event-driven обновление цен через Kafka
- **TTL:** Автоматическое удаление брошенных корзин через 24 часа
- **Оптимистические блокировки:** Version fields для предотвращения конфликтов при редактировании корзины

#### 6. **Gamification & Motivation Context**

**Бизнес-возможности:** Система мотивации, достижения, рейтинги, награды, игровые механики

**Сервисы:**

- **Achievement Service** - Управление достижениями и бейджами
- **Leaderboard Service** - Рейтинговые таблицы и ранжирование
- **Reward Service** - Управление наградами и призами

**Ключевые агрегаты:**

- `Achievement` (агрегат-корень): `achievementId`, `unlockConditions`, `badgeDesign`, `rewards`, `rarity`
- `Leaderboard` (агрегат-корень): `leaderboardId`, `participants`, `scores`, `timeWindow`, `rankingAlgorithm`
- `Reward` (агрегат-корень): `rewardId`, `distributionRules`, `redemptionOptions`, `expiryDate`

**Бизнес-правила:**

- Прогрессивная сложность достижений (бронза → серебро → золото → платина)
- Ежедневные/еженедельные/ежемесячные лидерборды с автоматическим сбросом
- Ограничение начисления очков: максимум 1000 очков в день
- Правила предотвращения накрутки (античит-система)

**Управление данными:**

- **Тип БД:** Redis для счетчиков и лидербордов + PostgreSQL для перманентных данных
- **Согласованность:** Eventual consistency (приемлема для игровых механик)
- **Производительность:** In-memory структуры Redis (Sorted Sets для лидербордов, Hashes для счетчиков)
- **Резервное копирование:** Ежечасные снапшоты Redis RDB + AOF журналирование для durability
- **Шардирование:** Лидерборды шардируются по типам и временным интервалам

#### 7. **Event Management & Booking Context**

**Бизнес-возможности:** Организация спортивных событий, бронирование мест, управление квотами, очереди ожидания

**Сервисы:**

- **Event Management Service** - Создание и управление спортивными событиями
- **Booking Service** - Система бронирования мест и управления регистрациями
- **Waitlist Service** - Управление очередями ожидания и уведомлениями

**Ключевые агрегаты:**

- `SportEvent` (агрегат-корень): `eventId`, `schedule`, `venue`, `capacity`, `registrationRules`, `currentParticipants`
- `Booking` (агрегат-корень): `bookingId`, `eventId`, `userId`, `reservedSeats`, `paymentStatus`, `cancellationPolicy`
- `Waitlist` (агрегат-корень): `waitlistId`, `eventId`, `queue`, `notificationPreferences`, `priorityRules`

**Бизнес-правила:**

- Приоритетное бронирование для премиум-пользователей (24-часовое окно до публичного доступа)
- Автоматическая отмена неоплаченных броней через 30 минут
- Ограничение: максимум 2 события в день на одного пользователя
- Правила возврата средств в зависимости от времени до события

**Управление данными:**

- **Тип БД:** PostgreSQL с блокировками FOR UPDATE для управления местами
- **Уровень изоляции:** Serializable для операций бронирования
- **Стратегия резервирования:** Двухфазное подтверждение (проверка → блокировка → подтверждение)
- **Таймауты транзакций:** Автоматический откат транзакций бронирования через 30 секунд
- **Оптимизация:** Частичные индексы для активных событий, составные индексы для поиска по дате и местоположению

#### 8. **Analytics & Recommendations Context**

**Бизнес-возможности:** Аналитика данных, ML рекомендации, персонализация, прогнозирование трендов

**Сервисы:**

- **Analytics Engine Service** - Обработка и анализ больших данных
- **Recommendation Service** - Генерация персонализированных рекомендаций
- **Personalization Service** - Адаптация интерфейса и контента под пользователя

**Ключевые агрегаты:**

- `UserProfile` (агрегат-корень): `profileId`, `userId`, `behaviorPatterns`, `preferences`, `recommendationHistory`
- `AnalyticsReport`: `reportId`, `metrics`, `trends`, `insights`, `generationTime`
- `MLModel`: `modelId`, `version`, `features`, `performanceMetrics`, `trainingData`

**Бизнес-правила:**

- Минимальная история тренировок: 10 сессий для персонализации рекомендаций
- Вес рекомендации: 60% на основе истории, 25% на основе социального графа, 15% популярное
- Ежедневное обновление ML-моделей рекомендаций
- Автоматическое определение сезонных трендов и корректировка рекомендаций

**Управление данными:**

- **Тип БД:** Cassandra для аналитических данных + PostgreSQL для метаданных моделей
- **Согласованность:** Настраиваемая согласованность (QUORUM для важных данных, ONE для оперативных запросов)
- **Обработка:** Lambda-архитектура (пакетная обработка с Spark + потоковая с Kafka Streams)
- **Хранение:** Data Lake (S3) для сырых данных, Data Warehouse для агрегаций
- **Индексация:** Вторичные индексы в Cassandra для часто запрашиваемых атрибутов

#### 9. **Event Sourcing & CQRS Context** (Новый домен из курсовой)

**Бизнес-возможности:** Управление жизненным циклом заказов с полной аудируемостью, обработка платежей, управление остатками товаров, аналитика в реальном времени.

**Архитектурные особенности:**
- **Event Sourcing:** Все изменения состояния хранятся как последовательность доменных событий
- **CQRS (Command Query Responsibility Segregation):** Разделение на команды (запись) и запросы (чтение)
- **Actor Model:** Akka Actors для гарантированной однопоточной обработки агрегатов
- **Event Streaming:** Apache Kafka для передачи доменных событий между сервисами

**Сервисы:**
- **Order Service (Event Sourced)** - Управление заказами через Event Sourcing
- **Payment Service (Event Sourced)** - Обработка финансовых операций
- **Inventory Service (Event Sourced)** - Управление запасами товаров
- **Analytics Service (CQRS)** - Аналитика и отчетность через Read Models

**Ключевые агрегаты:**
- `Order` (Event Sourced): Управление жизненным циклом заказа
- `Payment` (Event Sourced): Обработка финансовых транзакций
- `ProductStock` (Event Sourced): Управление остатками товаров

**Read Models (CQRS):**
- `OrderSummary` - Денормализованное представление для UI
- `CustomerFunnel` - Данные для аналитики воронок продаж
- `InventoryStatus` - Текущее состояние остатков по всем складам
- `SalesDashboard` - Дашборды для менеджеров в реальном времени

**Инфраструктура:**
- **Event Store:** Apache Kafka с топиками: `orders.events`, `payments.events`, `inventory.events`
- **Read Model Stores:** ClickHouse (аналитика), MongoDB (оперативные данные), Redis (кэш)
- **Actor System:** Akka Cluster для распределенных агрегатов
- **Snapshot Storage:** S3/GCS для периодических снапшотов агрегатов

## Компонентная архитектура

### 1. Слой представления (Presentation Layer)

#### 1.1 Клиентские приложения

- **Мобильные приложения (iOS/Android):** React Native для кроссплатформенной разработки
- **Веб-приложение:** React с использованием PWA (Progressive Web App)
- **Виджеты для умных часов:** Native разработка для Apple Watch и Wear OS

#### 1.2 API Gateway

- **Технология:** Kong/APIGEE с GraphQL
- **Функции:**
  - Единая точка входа для всех клиентов
  - Аутентификация и авторизация (JWT валидация)
  - Rate limiting и защита от DDoS
  - Маршрутизация запросов к соответствующим сервисам
  - Агрегация данных из нескольких ограниченных контекстов
  - Трансформация протоколов (GraphQL/REST)

### 2. Бизнес-сервисы по ограниченным контекстам

#### 2.1 Identity & Authentication Context Services

##### 2.1.1 Identity Service

- **Технологии:** Java + Spring Boot, PostgreSQL (ACID-транзакции)
- **Основные операции:**
  - Регистрация и аутентификация (OAuth 2.0, JWT, MFA)
  - Управление профилем и настройками приватности
  - Управление спортивным инвентарем пользователя
  - Валидация минимального возраста (13+)
- **DDD компоненты:**
  - Агрегат `User` с инвариантом "макс. 5 активных сессий"
  - Доменные события: `UserRegistered`, `ProfileUpdated`, `InventoryAdded`
- **Управление транзакциями:**
  - Уровень изоляции: Repeatable Read для операций с учетными данными
  - Оптимистические блокировки через version fields для редактирования профиля
  - Redis для кэширования сессий с TTL 24 часа

##### 2.1.2 Authorization Service

- **Технологии:** Java + Spring Security, Redis
- **Основные операции:**
  - Проверка прав доступа к ресурсам
  - Управление ролями и разрешениями (RBAC)
  - Аудит действий пользователей
  - Интеграция с внешними системами аутентификации

#### 2.2 Workout & Training Context Services

##### 2.2.1 Workout Tracking Service

- **Технологии:** Go, MongoDB (для гибкой схемы тренировок), Redis (для активных сессий)
- **Основные операции:**
  - Запись и хранение данных тренировок с бизнес-валидацией
  - Интеграция с внешними устройствами
  - Расчет статистики и прогресса с физиологической валидацией
  - Сравнение с предыдущими тренировками и рекордами
- **DDD компоненты:**
  - Агрегат `TrainingSession` с валидацией метрик (ЧСС, координаты, время)
  - Доменные события: `WorkoutStarted`, `WorkoutCompleted`, `PersonalRecordAchieved`
- **Управление данными:**
  - Геопространственные индексы MongoDB для маршрутов
  - Составные индексы по userId и timestamp для быстрого доступа к истории
  - Шардирование по userId для равномерного распределения нагрузки

##### 2.2.2 Training Analytics Service

- **Технологии:** Python + FastAPI, Redis (для кэша аналитики), PostgreSQL (для агрегаций)
- **Основные операции:**
  - Анализ тренировочных данных в реальном времени
  - Выявление паттернов и трендов
  - Прогнозирование прогресса и результатов
  - Генерация персонализированных отчетов
- **Оптимизации:**
  - Materialized views для часто запрашиваемых агрегаций
  - Инкрементальное обновление статистики через события

##### 2.2.3 Training Plan Service

- **Технологии:** Python, PostgreSQL
- **Основные операции:**
  - Создание и управление персонализированными тренировочными планами
  - Адаптация планов на основе прогресса
  - Рекомендации по интенсивности и восстановлению
  - Интеграция с календарем пользователя
- **Управление транзакциями:**
  - Уровень изоляции: Read Committed для большинства операций
  - Сериализуемые транзакции для обновления прогресса и пересчета плана

#### 2.3 Social & Community Context Services

##### 2.3.1 Social Graph Service

- **Технологии:** Java + Spring Boot, PostgreSQL (для социального графа), Redis (для кэширования)
- **Основные операции:**
  - Управление друзьями и подписчиками
  - Создание и управление группами с модерацией
  - Поиск пользователей по интересам и местоположению
  - Рекомендации друзей на основе социального графа
- **DDD компоненты:**
  - Агрегат `SocialGroup` с правилами модерации
  - Доменные события: `FriendshipEstablished`, `GroupCreated`, `UserJoinedGroup`
- **Управление данными:**
  - Eventual consistency для ленты новостей (допустима задержка до 5 секунд)
  - Материализованные представления для топовых групп и активных пользователей
  - Кэширование социального графа в Redis с TTL 10 минут

##### 2.3.2 Community Service

- **Технологии:** Node.js + TypeScript, PostgreSQL
- **Основные операции:**
  - Управление членством в группах
  - Контент-модерация в сообществах
  - Организация групповых тренировок
  - Управление правами и ролями в группах
- **Управление транзакциями:**
  - Пессимистические блокировки при обновлении состава групп (FOR UPDATE)
  - Оптимистические блокировки для редактирования контента групп

##### 2.3.3 Content Feed Service

- **Технологии:** Go, Redis (лента новостей), PostgreSQL (персистентное хранение)
- **Основные операции:**
  - Генерация ленты активности друзей и групп
  - Ранжирование контента по релевантности
  - Фильтрация контента по пользовательским настройкам
- **Архитектура ленты:**
  - Fan-out-on-write для популярных пользователей
  - Fan-out-on-read для менее активных пользователей
  - Кэширование лент в Redis с TTL 5 минут

#### 2.4 Health & Device Integration Context Services

##### 2.4.1 Device Integration Service

- **Технологии:** Kotlin (Android), Swift (iOS), Python (серверная часть)
- **Поддерживаемые платформы:**
  - Apple HealthKit и Google Fit (мобильные)
  - Fitbit API, Garmin Connect, Polar Flow
  - Стандартные протоколы: Bluetooth LE, ANT+
- **Основные операции:**
  - Обнаружение и подключение устройств
  - Калибровка и валидация данных
  - Синхронизация в реальном времени
  - Управление энергопотреблением

##### 2.4.2 Health Metrics Service

- **Технологии:** Python + FastAPI, TimescaleDB (для временных рядов), Redis (для кэша)
- **Основные операции:**
  - Обработка и валидация медицинских метрик
  - Агрегация данных для аналитики
  - Обнаружение аномалий и паттернов
  - Генерация рекомендаций по здоровью
- **DDD компоненты:**
  - Агрегат `HealthMetric` с медицинской валидацией
  - Доменные события: `MetricRecorded`, `AnomalyDetected`, `HealthAlertGenerated`
- **Управление данными:**
  - Автоматическое сжатие данных старше 30 дней
  - Ретенция raw данных: 2 года в TimescaleDB, затем архив в S3
  - Индексы по времени и типу метрики для быстрого доступа

#### 2.5 Commerce & Promotions Context Services

##### 2.5.1 Product Catalog Service

- **Технологии:** Java + Spring Boot, PostgreSQL (для ACID-транзакций)
- **Основные операции:**
  - Управление каталогом спортивных товаров
  - Интеграция с системой инвентаризации компании
  - Обновление цен и наличия в реальном времени
  - Поддержка региональных промоакций
- **Управление транзакциями:**
  - Строгая согласованность для операций с инвентарем
  - Уровень изоляции: Repeatable Read с блокировками FOR UPDATE
  - Event-driven синхронизация изменений цен через Kafka

##### 2.5.2 Shopping Cart Service

- **Технологии:** Node.js, Redis (для сессий корзины)
- **Основные операции:**
  - Управление корзинами покупок
  - Применение промокодов и скидок
  - Расчет итоговой стоимости
  - Интеграция с платежными системами
- **Управление данными:**
  - TTL корзин: 24 часа автоматического удаления
  - Оптимистические блокировки при редактировании корзины
  - Компенсирующие транзакции при отмене бронирования товара

##### 2.5.3 Promotion Service

- **Технологии:** Python, Redis (для кэша правил), PostgreSQL (для персистентного хранения)
- **Основные операции:**
  - Управление промоакциями и скидками
  - Применение правил и условий акций
  - Интеграция с системой лояльности
  - Анализ эффективности промоакций

#### 2.6 Gamification & Motivation Context Services

##### 2.6.1 Achievement Service

- **Технологии:** Go, Redis (для счетчиков), PostgreSQL (для метаданных достижений)
- **Основные операции:**
  - Проверка условий разблокировки достижений
  - Начисление бейджей и наград
  - Отслеживание прогресса пользователя
  - Управление иерархией достижений (уровни, категории)
- **Управление данными:**
  - Redis для счетчиков с атомарными операциями INCR
  - Sorted Sets для ранжирования пользователей по достижениям
  - Eventual consistency для обновления достижений

##### 2.6.2 Leaderboard Service

- **Технологии:** Go, Redis (Sorted Sets)
- **Основные операции:**
  - Реалтайм обновление лидербордов
  - Ранжирование пользователей по различным метрикам
  - Управление временными окнами (ежедневные, еженедельные, ежемесячные таблицы)
  - Расчет наград по итогам периода
- **Оптимизации:**
  - Шардирование лидербордов по регионам и типам соревнований
  - Периодические снапшоты для предотвращения потери данных
  - Кэширование топ-N результатов

##### 2.6.3 Reward Service

- **Технологии:** Python, PostgreSQL
- **Основные операции:**
  - Управление виртуальными и физическими наградами
  - Обработка запросов на получение наград
  - Интеграция с системой доставки призов
  - Отслеживание статуса выдачи наград

#### 2.7 Event Management & Booking Context Services

##### 2.7.1 Event Management Service

- **Технологии:** Java + Spring Boot, PostgreSQL
- **Основные операции:**
  - Создание и управление спортивными событиями
  - Управление расписанием и локациями
  - Настройка правил регистрации и участия
  - Интеграция с картографическими сервисами
- **Управление транзакциями:**
  - Сериализуемые транзакции для управления доступностью мест
  - Блокировки FOR UPDATE для операций с квотами
  - Двухфазное резервирование мест (check-hold-confirm)

##### 2.7.2 Booking Service

- **Технологии:** Node.js + TypeScript, PostgreSQL
- **Основные операции:**
  - Обработка запросов на бронирование
  - Управление статусами бронирований (подтверждено, ожидание, отменено)
  - Интеграция с платежными системами
  - Управление политиками отмены и возврата
- **Стратегии согласованности:**
  - Строгая согласованность для операций бронирования
  - Компенсирующие транзакции для отмены брони
  - Eventual consistency для уведомлений о бронировании

##### 2.7.3 Waitlist Service

- **Технологии:** Python, Redis (очереди), PostgreSQL
- **Основные операции:**
  - Управление очередями ожидания на события
  - Автоматическое уведомление при освобождении мест
  - Приоритизация пользователей в очереди
  - Обработка отказов от места в очереди

#### 2.8 Analytics & Recommendations Context Services

##### 2.8.1 Analytics Engine Service

- **Технологии:** Python, Apache Spark, Cassandra
- **Основные операции:**
  - Обработка больших данных в режиме пакетной обработки
  - Анализ паттернов поведения пользователей
  - Генерация бизнес-отчетов и дашбордов
  - Обучение ML-моделей для рекомендаций
- **Архитектура данных:**
  - Lambda-архитектура: batch layer + speed layer
  - Serving layer с матермализованными представлениями
  - Ежедневные обновления агрегаций

##### 2.8.2 Recommendation Service

- **Технологии:** Python + TensorFlow/PyTorch, Redis (кэш рекомендаций)
- **Модели машинного обучения:**
  - Collaborative filtering для рекомендаций товаров
  - Content-based filtering для тренировочных планов
  - Graph neural networks для социальных рекомендаций
- **DDD компоненты:**
  - Агрегат `Recommendation` с правилами персонализации
  - Доменные события: `RecommendationGenerated`, `ProductViewed`, `PurchaseCompleted`
- **Управление данными:**
  - Кэширование персонализированных рекомендаций с TTL 1 час
  - A/B тестирование моделей рекомендаций
  - Мониторинг метрик качества рекомендаций

#### 2.9 Event Sourcing & CQRS Context Services

##### 2.9.1 Order Service (Event Sourced)

**Технологии:** Scala/Java + Akka, Apache Kafka (Event Store), Cassandra (долгосрочное хранение событий)

**Основные операции:**
- Создание заказа с идемпотентным ключом (Idempotency-Key)
- Резервирование товаров через Inventory Service
- Обработка платежей через Payment Service
- Управление статусами заказа (Created → Reserved → Confirmed → Fulfilled → Cancelled)

**Архитектурные особенности:**
- **Event Sourcing:** Все изменения состояния хранятся как последовательность событий
- **Actor Model:** Каждый заказ реализован как Akka Actor
- **Snapshotting:** Периодические снапшоты каждые 100 событий для быстрого восстановления
- **Компенсирующие транзакции:** Saga Pattern для распределенных операций

**Доменные события:**
- `OrderCreated` - инициирование процесса заказа
- `OrderReserved` - товары зарезервированы
- `OrderConfirmed` - платеж подтвержден
- `OrderCancelled` - отмена заказа с компенсирующими действиями

##### 2.9.2 Payment Service (Event Sourced)

**Технологии:** Scala/Java + Akka, Apache Kafka, PostgreSQL (для финансовой отчетности)

**Основные операции:**
- Обработка платежей через различные провайдеры (карты, Apple Pay, PayPal)
- Управление возвратами и частичными refunds
- Обнаружение мошенничества через анализ паттернов транзакций
- Сверка с платежными системами

**Архитектурные особенности:**
- **Полный аудит:** Каждая финансовая операция фиксируется как событие
- **Anti-fraud:** Интеграция с системами обнаружения мошенничества
- **Идемпотентность:** Гарантированная однократная обработка платежей
- **Гарантии доставки:** Exactly-once семантика для критичных операций

##### 2.9.3 Inventory Service (Event Sourced)

**Технологии:** Scala/Java + Akka, Apache Kafka, Redis (для оперативных остатков)

**Основные операции:**
- Управление остатками товаров на складах
- Резервирование товаров с TTL (30 минут)
- Освобождение резервов при отмене заказа или истечении TTL
- Синхронизация между регионами (eventual consistency)

**Архитектурные особенности:**
- **Оптимистичные блокировки:** Версионирование агрегатов для предотвращения конфликтов
- **Распределенные транзакции:** Через компенсирующие транзакции (Saga)
- **Шардирование:** Распределение товаров по шардам для масштабирования
- **Кэширование:** Горячие остатки в Redis для быстрого доступа

##### 2.9.4 Analytics Service (CQRS)

**Технологии:** Python/Go, ClickHouse (аналитика), MongoDB (оперативные данные), Apache Kafka (потребление событий)

**Основные операции:**
- Потребление доменных событий из Kafka для обновления Read Models
- Генерация реальных дашбордов для менеджеров
- A/B тестирование новых функций и промоакций
- Прогнозирование спроса на основе исторических данных

**Архитектура CQRS:**
- **Write Side:** События публикуются Order, Payment, Inventory сервисами
- **Read Side:** Проекторы обновляют Read Models в ClickHouse и MongoDB
- **Query Side:** Оптимизированные запросы к денормализованным данным
- **Eventual Consistency:** Задержка обновления Read Models ≤ 5 секунд

### 3. Инфраструктурные сервисы

#### 3.1 Event Bus (Apache Kafka)

- **Конфигурация:**
  - Кластер из 3 брокеров с репликацией фактором 3
  - Топики организованы по ограниченным контекстам:
    - `identity-auth-events`
    - `workout-training-events`
    - `social-community-events`
    - `health-device-events`
    - `commerce-promotions-events`
    - `gamification-events`
    - `event-booking-events`
    - `analytics-recommendations-events`
  - Schema Registry для управления версиями схем доменных событий

#### 3.2 API Gateway (GraphQL)

- **Технологии:** Apollo Server, GraphQL
- **Схема GraphQL:**
  - Единая схема, агрегирующая данные из всех контекстов
  - DataLoader для решения проблемы N+1 запросов
  - Field-level security и авторизация
  - Кэширование на уровне резолверов

#### 3.3 Search Service

- **Технологии:** Elasticsearch, Kibana
- **Основные индексы:**
  - Пользователи (поиск по имени, интересам, местоположению)
  - Группы (поиск по названию, тематике, активности)
  - Тренировки (аналитика и агрегация)
  - Товары (полнотекстовый поиск по каталогу)

#### 3.4 Event Sourcing & CQRS Infrastructure

**Apache Kafka для Event Streaming:**
- **Кластерная конфигурация:** 3 брокера в каждом регионе с репликацией фактором 3
- **Топики событий:**
  - `business.orders` - события заказов (OrderCreated, OrderCancelled)
  - `business.payments` - финансовые события (PaymentCompleted, PaymentRefunded)
  - `business.inventory` - события запасов (StockReserved, StockReleased)
  - `analytics.events` - события для аналитики (обогащенные данные)
- **Retention политики:** 7 дней для оперативных данных, 7 лет для аудита
- **Schema Registry:** Управление версиями схем событий (Avro/Protobuf)

**Хранилища для Read Models:**
- **ClickHouse:** Для аналитических запросов и агрегаций (column-oriented)
- **MongoDB:** Для оперативных Read Models (OrderSummary, CustomerProfile)
- **Redis:** Для кэширования горячих данных и сессий
- **Elasticsearch:** Для полнотекстового поиска и сложных запросов

**Akka Cluster для Actor Model:**
- **Seed Nodes:** 3 узла для bootstrap кластера в каждом регионе
- **Sharding:** Распределение агрегатов по узлам кластера (consistent hashing)
- **Supervision:** Иерархии супервизии для отказоустойчивости
- **Persistence:** Event journal в Kafka, snapshot store в S3/GCS
- **Мониторинг:** Активные акторы, очереди сообщений, время восстановления

## Схема развертывания (Deployment Architecture)

### Региональная структура

#### Регион: EU-West (Амстердам)

- **Кластер Kubernetes:** EKS (AWS)
- **Базы данных:**
  - PostgreSQL: user_profiles, social_graph (мастер-реплика)
  - Redis: сессии, кэши, лидерборды (кластерный режим)
  - MongoDB: workout_sessions (шардирование по пользователям)
- **Сервисы:** Identity, Social, Workout, Gamification

#### Регион: US-East (Вирджиния)

- **Кластер Kubernetes:** EKS (AWS)
- **Базы данных:**
  - PostgreSQL: commerce_data, recommendations
  - Redis: кэш промоакций, сессии корзин
  - Elasticsearch: поисковый кластер
- **Сервисы:** Commerce, Recommendations, Analytics Engine

#### Регион: AP-Southeast (Сингапур)

- **Кластер Kubernetes:** GKE (Google Cloud)
- **Базы данных:**
  - TimescaleDB: health_metrics (для временных рядов)
  - PostgreSQL: event_bookings, device_registry
  - Redis: очереди ожидания, кэши событий
- **Сервисы:** Health, Device, Event Management, Booking

### Глобальная балансировка

- **GeoDNS:** Маршрутизация пользователей к ближайшему региону
- **CDN:** CloudFront для статического контента (изображения, видео тренировок)
- **Global Load Balancer:** Распределение трафика между регионами

### Глобальная Event Sourcing инфраструктура

**Центральный Event Hub (ЕС регион):**
- **Kafka Cluster:** 6 брокеров для глобальных бизнес-событий
- **ClickHouse Cluster:** Для кросс-региональной аналитики и отчетности
- **Schema Registry:** Централизованное управление схемами событий
- **Akka Management Center:** Мониторинг и управление кластерами акторов

**Региональные Event Stores:**
- Каждый регион имеет локальный Kafka кластер для низкой задержки
- Репликация критичных событий в центральный хаб через MirrorMaker 2
- Локальные Read Models для оперативных запросов (≤ 50ms latency)
- Гео-шардирование: Данные пользователей хранятся в их домашнем регионе

**Межрегиональная синхронизация:**
- **MirrorMaker 2:** Репликация топиков между регионами для disaster recovery
- **Конфликтное разрешение:** Last-write-wins с векторными часами для временных меток
- **Гео-аффинити:** Пользовательские запросы направляются в их регион
- **Холодная архивация:** События старше 1 года перемещаются в S3 Glacier

## Мониторинг и наблюдаемость

### 1. Distributed Tracing

- **Стандарт:** OpenTelemetry
- **Бэкенд:** Jaeger для хранения и визуализации трейсов
- **Инструментация:** Автоматическая для всех микросервисов

### 2. Метрики и мониторинг

- **Сбор метрик:** Prometheus с экспортерами для всех компонентов
- **Визуализация:** Grafana с дашбордами по доменам
- **Алертинг:** Alertmanager с эскалацией по критичности

### 3. Логирование

- **Сбор логов:** Fluentd/Fluent Bit
- **Хранилище:** Elasticsearch
- **Анализ:** Kibana с дашбордами для каждого контекста

## Стратегия миграции к DDD-архитектуре

### Фаза 1: Модульный монолит (3-4 месяца)

1. Выделение модулей по ограниченным контекстам
2. Внедрение единого языка для каждого контекста
3. Рефакторинг к агрегатам с инвариантами

### Фаза 2: Гибридная архитектура (2-3 месяца)

1. Экстракция Identity & Auth Context в отдельный микросервис
2. Внедрение доменных событий между модулями
3. Миграция данных к полиглотному хранению

### Фаза 3: Полная DDD-микросервисная архитектура (3-4 месяца)

1. Выделение всех ограниченных контекстов в микросервисы
2. Настройка событийной шины и командной шины
3. Внедрение стратегий управления транзакциями

## Безопасность и комплаенс

### 1. Аутентификация и авторизация

- **Протокол:** OAuth 2.0 + OpenID Connect
- **Токены:** JWT с коротким временем жизни
- **MFA:** Многофакторная аутентификация для администраторов

### 2. Защита данных

- **Шифрование:** TLS 1.3 для передачи, AES-256 для хранения
- **Маскирование данных:** Для аналитики и тестовых сред
- **GDPR compliance:** Геошардирование данных по регионам

### 3. Аудит и соответствие

- **Логи аудита:** Все критические операции логируются
- **Соответствие стандартам:** ISO 27001, HIPAA (для медицинских данных)
- **Пентесты:** Регулярное тестирование на проникновение

---

**Заключение:** Представленная базовая архитектура интегрирует принципы Domain-Driven Design с микросервисной архитектурой, создавая систему, которая точно отражает бизнес-процессы фитнес-социального приложения. Архитектура обеспечивает масштабируемость, отказоустойчивость и гибкость для будущего развития системы.
точно отражает бизнес-процессы фитнес-социального приложения. Архитектура обеспечивает масштабируемость, отказоустойчивость и гибкость для будущего развития системы.
