# 13. Базовая архитектура системы

## Обзор
Базовая архитектура описывает детализированную структуру системы с учетом бизнес-требований, нефункциональных требований, выбранных архитектурных опций и атрибутов качества. Архитектура построена на принципах Domain-Driven Design (DDD), что позволяет четко отразить бизнес-процессы и обеспечить гибкость системы.

## Архитектурные принципы

### 1. Domain-Driven Design (DDD)
- **Ограниченные контексты:** Четкие границы вокруг каждой бизнес-области
- **Единый язык:** Общий язык между разработчиками и бизнесом
- **Агрегаты:** Инкапсуляция бизнес-правил и инвариантов
- **Доменные события:** Моделирование бизнес-событий как первоклассных концепций

### 2. Принцип разделения ответственности (Single Responsibility)
Каждый микросервис соответствует ограниченному контексту и отвечает за одну бизнес-возможность с четко определенным контрактом API.

### 3. Принцип слабой связанности (Loose Coupling)
Сервисы взаимодействуют через асинхронные доменные события (event-driven) и имеют минимальные синхронные зависимости.

### 4. Принцип устойчивости к сбоям (Resilience)
Система проектируется с учетом возможных сбоев и продолжает работать при частичных отказах, с Circuit Breaker для внешних зависимостей.

### 5. Принцип наблюдаемости (Observability)
Все компоненты системы обеспечивают метрики, логи и трассировку для мониторинга и отладки с использованием OpenTelemetry.

### 6. Принцип безопасности по дизайну (Security by Design)
Безопасность интегрирована на всех уровнях архитектуры, с Zero Trust подходом и многофакторной аутентификацией.

## Доменная архитектура (DDD-based)

### Ограниченные контексты и их соответствие сервисам

#### 1. **User & Social Context (Core Domain)**
**Бизнес-возможности:** Управление пользователями, социальным графом, группами, сообществами

**Сервисы:**
- **User Management Service** - Управление профилями, аутентификация
- **Social Graph Service** - Социальные связи, друзья, группы
- **Group Management Service** - Создание и управление сообществами

**Ключевые агрегаты:**
- `User` (агрегат-корень): `userId`, `profile`, `privacySettings`, `friendsList`
- `SocialGroup` (агрегат-корень): `groupId`, `members`, `moderationRules`, `content`
- `Friendship`: `user1Id`, `user2Id`, `status`, `establishedDate`

**Инварианты:**
- Максимальное количество друзей: 5000 на пользователя
- Минимальный возраст для создания групп: 16 лет
- Правила модерации контента в группах

#### 2. **Activity & Training Context**
**Бизнес-возможности:** Трекинг тренировок, анализ метрик, управление тренировочными планами

**Сервисы:**
- **Workout Tracking Service** - Запись и хранение тренировок
- **Training Analytics Service** - Анализ и сравнение метрик
- **Training Plan Service** - Создание и управление тренировочными планами

**Ключевые агрегаты:**
- `TrainingSession` (агрегат-корень): `sessionId`, `userId`, `exercises`, `metrics`, `deviceReadings`
- `TrainingPlan`: `planId`, `workouts`, `schedule`, `goals`
- `Exercise`: `exerciseId`, `type`, `sets`, `repetitions`, `weight`

**Бизнес-правила:**
- Валидация ЧСС: 40-220 BPM (с учетом возраста)
- Проверка GPS координат на корректность
- Расчет калорий по формуле MET × вес × время

#### 3. **Health & Device Context**
**Бизнес-возможности:** Интеграция медицинских устройств, сбор и валидация данных о здоровье

**Сервисы:**
- **Device Integration Service** - Подключение и управление устройствами
- **Health Metrics Service** - Обработка и валидация медицинских данных
- **Alert Service** - Генерация оповещений о критических значениях

**Ключевые агрегаты:**
- `Device` (агрегат-корень): `deviceId`, `type`, `calibration`, `connectionStatus`
- `HealthMetric`: `metricId`, `type`, `value`, `timestamp`, `validationStatus`
- `Alert`: `alertId`, `severity`, `message`, `acknowledged`

**Бизнес-правила:**
- Соответствие медицинским стандартам (ISO, сертификаты)
- Валидация данных по возрастным нормам
- Автоматическое определение аномалий

#### 4. **Commerce & Recommendations Context**
**Бизнес-возможности:** Управление товарами, персонализированные рекомендации, промоакции

**Сервисы:**
- **Product Catalog Service** - Управление каталогом товаров
- **Recommendation Engine** - Генерация персонализированных рекомендаций
- **Promotion Service** - Управление промоакциями и скидками

**Ключевые агрегаты:**
- `Product` (агрегат-корень): `productId`, `sku`, `specifications`, `inventory`, `price`
- `Recommendation`: `recommendationId`, `userId`, `products`, `score`, `reason`
- `Promotion`: `promotionId`, `conditions`, `discount`, `validityPeriod`

**Бизнес-правила:**
- Вес рекомендации: 70% на основе истории, 30% на основе социального графа
- Минимальная история для персонализации: 5 тренировочных сессий
- Проверка совместимости товаров с тренировочными планами

### 5. **Поддерживающие домены (Supporting Domains)**
- **Gamification Context** - Движок геймификации
- **Notification Context** - Сервис уведомлений
- **Analytics Context** - Аналитический движок

## Компонентная архитектура

### 1. Слой представления (Presentation Layer)

#### 1.1 Клиентские приложения
- **Мобильные приложения (iOS/Android):** React Native для кроссплатформенной разработки
- **Веб-приложение:** React с использованием PWA (Progressive Web App)
- **Виджеты для умных часов:** Native разработка для Apple Watch и Wear OS

#### 1.2 API Gateway
- **Технология:** Kong/APIGEE с GraphQL
- **Функции:**
  - Единая точка входа для всех клиентов
  - Аутентификация и авторизация (JWT валидация)
  - Rate limiting и защита от DDoS
  - Маршрутизация запросов к соответствующим сервисам
  - Агрегация данных из нескольких ограниченных контекстов
  - Трансформация протоколов (GraphQL/REST)

### 2. Бизнес-сервисы по ограниченным контекстам

#### 2.1 User & Social Context Services

##### 2.1.1 User Management Service
- **Технологии:** Java + Spring Boot, PostgreSQL
- **Основные операции:**
  - Регистрация и аутентификация (OAuth 2.0, JWT, MFA)
  - Управление профилем и настройками приватности
  - Управление спортивным инвентарем пользователя
  - Валидация минимального возраста (13+)
- **DDD компоненты:**
  - Агрегат `User` с инвариантом "макс. 5000 друзей"
  - Доменные события: `UserRegistered`, `ProfileUpdated`, `InventoryAdded`

##### 2.1.2 Social Graph Service
- **Технологии:** Java + Spring Boot, Neo4j (графовая БД)
- **Основные операции:**
  - Управление друзьями и подписчиками
  - Создание и управление группами с модерацией
  - Поиск пользователей по интересам и местоположению
  - Рекомендации друзей на основе социального графа
- **DDD компоненты:**
  - Агрегат `SocialGroup` с правилами модерации
  - Доменные события: `FriendshipEstablished`, `GroupCreated`, `UserJoinedGroup`

##### 2.1.3 Group Management Service
- **Технологии:** Node.js + TypeScript, PostgreSQL
- **Основные операции:**
  - Управление членством в группах
  - Контент-модерация в сообществах
  - Организация групповых тренировок
  - Управление правами и ролями в группах

#### 2.2 Activity & Training Context Services

##### 2.2.1 Workout Tracking Service
- **Технологии:** Go, Cassandra (для временных рядов), PostgreSQL (для метаданных)
- **Основные операции:**
  - Запись и хранение данных тренировок с бизнес-валидацией
  - Интеграция с внешними устройствами
  - Расчет статистики и прогресса с физиологической валидацией
  - Сравнение с предыдущими тренировками и рекордами
- **DDD компоненты:**
  - Агрегат `TrainingSession` с валидацией метрик
  - Доменные события: `WorkoutStarted`, `WorkoutCompleted`, `PersonalRecordAchieved`

##### 2.2.2 Training Analytics Service
- **Технологии:** Python + FastAPI, Redis (для кэша аналитики)
- **Основные операции:**
  - Анализ тренировочных данных в реальном времени
  - Выявление паттернов и трендов
  - Прогнозирование прогресса и результатов
  - Генерация персонализированных отчетов

##### 2.2.3 Training Plan Service
- **Технологии:** Python, PostgreSQL
- **Основные операции:**
  - Создание и управление персонализированными тренировочными планами
  - Адаптация планов на основе прогресса
  - Рекомендации по интенсивности и восстановлению
  - Интеграция с календарем пользователя

#### 2.3 Health & Device Context Services

##### 2.3.1 Device Integration Service
- **Технологии:** Kotlin (Android), Swift (iOS), Python (сервер)
- **Поддерживаемые платформы:**
  - Apple HealthKit и Google Fit (мобильные)
  - Fitbit API, Garmin Connect, Polar Flow
  - Стандартные протоколы: Bluetooth, ANT+
- **Основные операции:**
  - Обнаружение и подключение устройств
  - Калибровка и валидация данных
  - Синхронизация в реальном времени
  - Управление энергопотреблением

##### 2.3.2 Health Metrics Service
- **Технологии:** Python + FastAPI, PostgreSQL + TimescaleDB
- **Основные операции:**
  - Обработка и валидация медицинских метрик
  - Агрегация данных для аналитики
  - Обнаружение аномалий и паттернов
  - Генерация рекомендаций по здоровью
- **DDD компоненты:**
  - Агрегат `HealthMetric` с медицинской валидацией
  - Доменные события: `MetricRecorded`, `AnomalyDetected`, `HealthAlertGenerated`

#### 2.4 Commerce & Recommendations Context Services

##### 2.4.1 Product Catalog Service
- **Технологии:** Java + Spring Boot, PostgreSQL
- **Основные операции:**
  - Управление каталогом спортивных товаров
  - Интеграция с системой инвентаризации компании
  - Обновление цен и наличия в реальном времени
  - Поддержка региональных промоакций

##### 2.4.2 Recommendation Engine
- **Технологии:** Python + TensorFlow/PyTorch, Redis (для кэша)
- **Модели машинного обучения:**
  - Collaborative filtering для рекомендаций товаров
  - Content-based filtering для тренировочных планов
  - Graph neural networks для социальных рекомендаций
  - Reinforcement learning для адаптивных рекомендаций
- **DDD компоненты:**
  - Агрегат `Recommendation` с правилами персонализации
  - Доменные события: `RecommendationGenerated`, `ProductViewed`, `PurchaseCompleted`

##### 2.4.3 Promotion Service
- **Технологии:** Node.js, Redis
- **Основные операции:**
  - Управление промоакциями и скидками
  - Применение правил и условий акций
  - Интеграция с системой лояльности
  - Анализ эффективности промоакций

### 3. Инфраструктурные сервисы

#### 3.1 Event Bus (Apache Kafka)
- **Конфигурация:**
  - Кластер из 3 брокеров с репликацией фактором 3
  - Топики организованы по ограниченным контекстам:
    - `user-social-events`
    - `activity-training-events`
    - `health-device-events`
    - `commerce-recommendation-events`
  - Schema Registry для управления версиями схем доменных событий

#### 3.2 API Gateway (GraphQL)
- **Технологии:** Apollo Server, GraphQL
- **Схема GraphQL:**
  - Единая схема, агрегирующая данные из всех контекстов
  - DataLoader для решения проблемы N+1 запросов
  - Field-level security и авторизация
  - Кэширование на уровне резолверов

#### 3.3 Search Service
- **Технологии:** Elasticsearch, Kibana
- **Основные индексы:**
  - Пользователи (поиск по имени, интересам, местоположению)
  - Группы (поиск по названию, тематике, активности)
  - Тренировки (аналитика и агрегация)
  - Товары (полнотекстовый поиск по каталогу)

### 4. Сервисы данных и аналитики

#### 4.1 Analytics Engine
- **Технологии:** Apache Spark, Airflow, Delta Lake
- **Основные пайплайны:**
  - Ежедневная агрегация метрик по пользователям и группам
  - Обучение и обновление моделей рекомендаций
  - Анализ поведения пользователей для улучшения UX
  - Генерация бизнес-отчетов по вовлеченности и продажам

#### 4.2 Data Lake
- **Технологии:** Amazon S3 / Google Cloud Storage
- **Структура по доменам:**
  - `/raw/user-social/` - сырые данные социальных взаимодействий
  - `/raw/activity-training/` - данные тренировок и метрик
  - `/raw/health-device/` - медицинские данные с устройств
  - `/raw/commerce/` - данные по продажам и промоакциям

## Коммуникация между ограниченными контекстами

### 1. Синхронная коммуникация (REST/gRPC)
- **Используется для:** Немедленного ответа, транзакционных операций
- **Примеры:**
  - Проверка доступности товара при оформлении заказа
  - Валидация прав доступа к ресурсам
  - Получение текущего статуса тренировки

### 2. Асинхронная коммуникация (Domain Events)
- **Используется для:** Долгих операций, обновлений данных, нотификаций
- **Типы связей:**
  - **Partnership:** User & Social ↔ Activity & Training (тесная координация)
  - **Customer-Supplier:** Activity → Health & Devices (запрос данных)
  - **Conformist:** Commerce → E-commerce система компании (интеграция)

### 3. Командная шина (Command Bus)
- **Назначение:** Обработка команд и запросов между контекстами
- **Паттерны:** CQRS для разделения чтения и записи
- **Примеры команд:**
  - `CreateTrainingPlanCommand`
  - `JoinSocialGroupCommand`
  - `PurchaseProductCommand`

## Схема развертывания (Deployment Architecture)

### Региональная структура

#### Регион: EU-West (Амстердам)
- **Кластер Kubernetes:** EKS (AWS)
- **Базы данных:**
  - PostgreSQL: user_profiles, social_graph (мастер-реплика)
  - Neo4j: social_connections (кластер из 3 нод)
  - Cassandra: workout_metrics (шардирование по пользователям)
- **Сервисы:** Все сервисы User & Social Context, основные сервисы Activity Context

#### Регион: US-East (Вирджиния)
- **Кластер Kubernetes:** EKS (AWS)
- **Базы данных:**
  - PostgreSQL: commerce_data, recommendations
  - Redis: кэш, сессии, лидерборды
  - Elasticsearch: поисковый кластер
- **Сервисы:** Commerce & Recommendations Context, Analytics Engine

#### Регион: AP-Southeast (Сингапур)
- **Кластер Kubernetes:** GKE (Google Cloud)
- **Базы данных:**
  - TimescaleDB: health_metrics (для временных рядов)
  - PostgreSQL: device_registry, alerts
- **Сервисы:** Health & Device Context, Notification Service

### Глобальная балансировка
- **GeoDNS:** Маршрутизация пользователей к ближайшему региону
- **CDN:** CloudFront для статического контента (изображения, видео тренировок)
- **Global Load Balancer:** Распределение трафика между регионами

## Мониторинг и наблюдаемость

### 1. Distributed Tracing
- **Стандарт:** OpenTelemetry
- **Бэкенд:** Jaeger для хранения и визуализации трейсов
- **Инструментация:** Автоматическая для всех микросервисов

### 2. Метрики и мониторинг
- **Сбор метрик:** Prometheus с экспортерами для всех компонентов
- **Визуализация:** Grafana с дашбордами по доменам
- **Алертинг:** Alertmanager с эскалацией по критичности

### 3. Логирование
- **Сбор логов:** Fluentd/Fluent Bit
- **Хранилище:** Elasticsearch
- **Анализ:** Kibana с дашбордами для каждого контекста

## Стратегия миграции к DDD-архитектуре

### Фаза 1: Модульный монолит (3-4 месяца)
1. Выделение модулей по ограниченным контекстам
2. Внедрение единого языка для каждого контекста
3. Рефакторинг к агрегатам с инвариантами

### Фаза 2: Гибридная архитектура (2-3 месяца)
1. Экстракция User & Social Context в отдельный микросервис
2. Внедрение доменных событий между модулями
3. Миграция данных к полиглотному хранению

### Фаза 3: Полная DDD-микросервисная архитектура (3-4 месяца)
1. Выделение всех ограниченных контекстов в микросервисы
2. Настройка событийной шины и командной шины
3. Внедрение CQRS для критичных доменов

## Безопасность и комплаенс

### 1. Аутентификация и авторизация
- **Протокол:** OAuth 2.0 + OpenID Connect
- **Токены:** JWT с коротким временем жизни
- **MFA:** Многофакторная аутентификация для администраторов

### 2. Защита данных
- **Шифрование:** TLS 1.3 для передачи, AES-256 для хранения
- **Маскирование данных:** Для аналитики и тестовых сред
- **GDPR compliance:** Геошардирование данных по регионам

### 3. Аудит и соответствие
- **Логи аудита:** Все критические операции логируются
- **Соответствие стандартам:** ISO 27001, HIPAA (для медицинских данных)
- **Пентесты:** Регулярное тестирование на проникновение

---

**Заключение:** Представленная базовая архитектура интегрирует принципы Domain-Driven Design с микросервисной архитектурой, создавая систему, которая точно отражает бизнес-процессы фитнес-социального приложения. Архитектура обеспечивает масштабируемость, отказоустойчивость и гибкость для будущего развития системы.

