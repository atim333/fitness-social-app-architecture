# 13. Базовая архитектура системы

## Обзор
Базовая архитектура описывает детализированную структуру системы с учетом бизнес-требований, нефункциональных требований, выбранных архитектурных опций и атрибутов качества. Эта архитектура является основой для реализации системы.

## Архитектурные принципы

### 1. Принцип разделения ответственности (Single Responsibility)
Каждый микросервис отвечает за одну бизнес-возможность (bounded context) и имеет четко определенный контракт API.

### 2. Принцип слабой связанности (Loose Coupling)
Сервисы взаимодействуют через асинхронные сообщения (event-driven) и имеют минимальные синхронные зависимости.

### 3. Принцип устойчивости к сбоям (Resilience)
Система проектируется с учетом возможных сбоев и продолжает работать при частичных отказах.

### 4. Принцип наблюдаемости (Observability)
Все компоненты системы обеспечивают метрики, логи и трассировку для мониторинга и отладки.

### 5. Принцип безопасности по дизайну (Security by Design)
Безопасность интегрирована на всех уровнях архитектуры, а не добавлена как дополнение.

## Компонентная архитектура

### 1. Слой представления (Presentation Layer)

#### 1.1 Клиентские приложения
- **Мобильные приложения (iOS/Android):** React Native для кроссплатформенной разработки
- **Веб-приложение:** React с использованием PWA (Progressive Web App)
- **Виджеты для умных часов:** Native разработка для Apple Watch и Wear OS

#### 1.2 API Gateway
- **Технология:** Kong/APIGEE
- **Функции:**
  - Единая точка входа для всех клиентов
  - Аутентификация и авторизация (JWT валидация)
  - Rate limiting и защита от DDoS
  - Маршрутизация запросов к соответствующим сервисам
  - Кэширование ответов
  - Трансформация протоколов (REST/GraphQL/gRPC)

### 2. Бизнес-сервисы (Business Services Layer)

#### 2.1 User Service
- **Ответственность:** Управление профилями пользователей, аутентификация, авторизация
- **Технологии:** Node.js + TypeScript, PostgreSQL
- **Основные операции:**
  - Регистрация и аутентификация (OAuth 2.0, JWT)
  - Управление профилем и настройками
  - Управление подписками и ролями
  - Хранение спортивного инвентаря пользователя
- **Масштабирование:** Горизонтальное по пользовательским сегментам

#### 2.2 Social Graph Service
- **Ответственность:** Управление социальными связями, группами, друзьями
- **Технологии:** Java + Spring Boot, Neo4j (графовая БД)
- **Основные операции:**
  - Управление друзьями и подписчиками
  - Создание и управление группами
  - Поиск пользователей по интересам и местоположению
  - Рекомендации друзей и групп
- **Масштабирование:** Шардирование по регионам

#### 2.3 Workout Service
- **Ответственность:** Трекинг, хранение и анализ тренировок
- **Технологии:** Go, Cassandra (для временных рядов), PostgreSQL (для метаданных)
- **Основные операции:**
  - Запись и хранение данных тренировок
  - Интеграция с внешними устройствами (HealthKit, Google Fit, Fitbit)
  - Расчет статистики и прогресса
  - Сравнение с предыдущими тренировками
- **Масштабирование:** Горизонтальное, отдельные кластера для разных типов тренировок

#### 2.4 Gamification Engine
- **Ответственность:** Система мотивации через игровые механики
- **Технологии:** Python + FastAPI, Redis (для лидербордов)
- **Основные операции:**
  - Расчет баллов и уровней
  - Управление достижениями и бейджами
  - Обновление рейтинговых таблиц
  - Начисление наград
- **Масштабирование:** Вертикальное + горизонтальное для лидербордов

#### 2.5 Recommendation Service
- **Ответственность:** Персонализированные рекомендации
- **Технологии:** Python + TensorFlow/PyTorch, Redis (для кэша рекомендаций)
- **Основные операции:**
  - Рекомендации тренировок
  - Предложения по обновлению инвентаря
  - Рекомендации друзей и групп
  - Персонализированные промоакции
- **Особенности:** Машинное обучение в оффлайне (batch) и онлайн (real-time)

#### 2.6 Notification Service
- **Ответственность:** Управление всеми видами уведомлений
- **Технологии:** Node.js, RabbitMQ (для очередей уведомлений)
- **Основные операции:**
  - Отправка push-уведомлений (Firebase Cloud Messaging, Apple Push Notification)
  - Email рассылки
  - In-app уведомления
  - Управление подписками на уведомления
- **Масштабирование:** Горизонтальное с разделением по типам уведомлений

### 3. Инфраструктурные сервисы (Infrastructure Services Layer)

#### 3.1 Event Bus (Apache Kafka)
- **Ответственность:** Асинхронная коммуникация между сервисами
- **Конфигурация:**
  - 3 ноды брокеров с репликацией фактором 3
  - 100+ топиков для различных типов событий
  - Schema Registry для управления схемами сообщений
  - Kafka Connect для интеграции с внешними системами
- **Основные события:**
  - `user.registered` → триггер welcome-письма
  - `workout.completed` → обновление статистики, проверка достижений
  - `achievement.unlocked` → уведомление друзей
  - `group.created` → рекомендации участников

#### 3.2 API Composition Service
- **Ответственность:** Агрегация данных из нескольких сервисов для клиентов
- **Технологии:** Node.js + GraphQL
- **Основные функции:**
  - Единая GraphQL схема для всех клиентов
  - DataLoader для решения проблемы N+1
  - Кэширование на уровне резолверов
  - Агрегация данных из User, Social, Workout сервисов

#### 3.3 Search Service
- **Ответственность:** Полнотекстовый поиск и агрегации
- **Технологии:** Elasticsearch
- **Основные индексы:**
  - Пользователи (по имени, интересам, местоположению)
  - Группы (по названию, описанию, интересам)
  - Тренировки (для аналитики и агрегаций)
- **Масштабирование:** Кластер из 5+ нод с репликацией

### 4. Сервисы данных и аналитики (Data & Analytics Layer)

#### 4.1 Analytics Engine
- **Ответственность:** Обработка больших данных, аналитика, машинное обучение
- **Технологии:** Apache Spark, Airflow (для оркестрации), S3/HDFS (для хранения)
- **Основные пайплайны:**
  - Ежедневная агрегация метрик пользователей
  - Обучение моделей рекомендаций
  - Анализ поведения пользователей
  - Генерация отчетов для бизнеса

#### 4.2 Data Lake
- **Ответственность:** Хранение сырых данных для аналитики
- **Технологии:** Amazon S3 / Google Cloud Storage
- **Структура:**
  - Raw zone (сырые данные из Kafka)
  - Processed zone (обработанные данные)
  - Curated zone (готовые для анализа данные)

### 5. Интеграционные адаптеры (Integration Adapters)

#### 5.1 E-commerce Integration
- **Ответственность:** Интеграция с системой продаж компании
- **Протоколы:** REST API, GraphQL
- **Основные функции:**
  - Получение каталога товаров
  - Создание заказов
  - Отслеживание статуса заказов
  - Применение промокодов

#### 5.2 Device Integration
- **Ответственность:** Интеграция с фитнес-устройствами
- **Поддерживаемые платформы:**
  - Apple HealthKit
  - Google Fit
  - Fitbit API
  - Garmin Connect
- **Особенности:** Адаптеры для каждого протокола, нормализация данных

## Схема развертывания (Deployment Architecture)

### Региональная структура
