# 12. Сценарии использования приложения

## Обзор
Сценарии использования (Use Cases) описывают взаимодействие пользователей с системой для достижения конкретных целей. Эти сценарии используются для проектирования пользовательского интерфейса, API и бизнес-логики. В DDD-перспективе каждый сценарий связывается с ограниченными контекстами, агрегатами и доменными событиями.

## DDD-перспектива сценариев

### Ключевые ограниченные контексты:
1. **Identity & Access Context** - управление пользователями, аутентификация, авторизация
2. **Workout Tracking Context** - трекинг тренировок, сбор телеметрии
3. **Social Graph Context** - социальные связи, группы, события
4. **Gamification Context** - достижения, челленджи, награды
5. **Inventory & Commerce Context** - управление инвентарем, рекомендации товаров
6. **Notification Context** - уведомления, коммуникации
7. **Analytics Context** - аналитика, машинное обучение, рекомендации
8. **Device Integration Context** - интеграция с внешними устройствами

### Основные агрегаты:
- **User** - профиль пользователя, настройки
- **WorkoutSession** - тренировочная сессия с метриками
- **SocialGroup** - социальная группа с участниками
- **Challenge** - соревнование или челлендж
- **Equipment** - спортивный инвентарь
- **Event** - событие для совместных тренировок

## Основные акторы (Actors)

### Первичные акторы:
1. **Новичок (Beginner)** - новый пользователь, только установивший приложение
2. **Активный пользователь (Active User)** - регулярно использующий приложение для тренировок
3. **Социальный лидер (Social Leader)** - пользователь, активно участвующий в группах и соревнованиях
4. **Профессиональный спортсмен (Pro Athlete)** - пользователь с высокими требованиями к аналитике и устройствам
5. **Администратор (Admin)** - сотрудник компании, управляющий контентом и промоакциями

### Вторичные акторы:
6. **Система рекомендаций (Recommendation System)** - автоматическая система рекомендаций
7. **Внешние устройства (External Devices)** - фитнес-браслеты, датчики
8. **Платежная система (Payment System)** - внешние системы обработки платежей

---

## Use Case 1: Регистрация и создание профиля

### ID:
UC-001

### DDD-анализ:
- **Ограниченные контексты:** Identity & Access Context, Social Graph Context
- **Основные агрегаты:** User (корневой), PrivacySettings, SportInventory
- **Объекты-значения:** Email, PasswordHash, UserPreferences, SportInterest
- **Доменные события:** UserRegistered, ProfileCreated, InterestsSelected, PrivacySettingsConfigured
- **Инварианты:**
  - Email должен быть уникальным в системе
  - Пользователь должен быть старше 13 лет
  - Пароль должен соответствовать политике безопасности
- **Бизнес-правила:**
  - Автоматическая верификация email при регистрации
  - Создание стандартного набора спортивных интересов при первом входе
  - Настройка приватности по умолчанию для нового пользователя

### Акторы:
Новичок

### Предусловия:
Пользователь скачал и открыл приложение впервые.

### Основной поток:
1. Пользователь нажимает "Начать"
2. Система предлагает войти через социальные сети или зарегистрироваться по email
3. Пользователь выбирает "Регистрация по email"
4. Система запрашивает email, пароль и подтверждение пароля
5. Пользователь вводит данные и нажимает "Продолжить"
6. Система отправляет письмо для подтверждения email
7. Пользователь подтверждает email и возвращается в приложение
8. Система запрашивает базовую информацию (имя, дата рождения, пол)
9. Пользователь вводит данные
10. Система предлагает выбрать спортивные интересы из списка (бег, йога, велоспорт и т.д.)
11. Пользователь выбирает 3-5 интересов
12. Система предлагает указать уровень подготовки (новичок, любитель, профессионал)
13. Пользователь выбирает уровень
14. Система создает профиль, публикует UserRegistered, показывает приветственный экран

### Альтернативный поток A: Регистрация через социальные сети
1. На шаге 2 пользователь выбирает "Войти через Facebook/Google/Apple"
2. Система перенаправляет в сервис аутентификации
3. Пользователь подтверждает доступ
4. Система получает базовую информацию из социального профиля
5. Переход к шагу 8 основного потока

### Альтернативный поток B: Пропуск шагов настройки
1. На шагах 8-13 пользователь может нажать "Пропустить"
2. Система создает профиль с минимальными данными
3. Пользователь может заполнить профиль позже в настройках

### Постусловия:
Создан агрегат User с настройками приватности. Пользователь аутентифицирован в системе. Публикованы доменные события для интеграции с другими контекстами.

---

## Use Case 2: Завершение тренировки с трекингом

### ID:
UC-002

### DDD-анализ:
- **Ограниченные контексты:** Workout Tracking Context, Device Integration Context, Analytics Context, Health & Safety Context
- **Основные агрегаты:** WorkoutSession (корневой), Exercise, Metric, DeviceReading
- **Объекты-значения:** Duration, HeartRate, GPSLocation, Pace, Calories, Elevation
- **Доменные события:**
  - WorkoutStarted
  - WorkoutPaused
  - WorkoutResumed
  - MetricRecorded
  - HealthAlertTriggered
  - WorkoutCompleted
  - WorkoutAnalyzed
- **Инварианты:**
  - Минимальная продолжительность тренировки: 1 минута
  - Максимальная продолжительность без паузы: 24 часа
  - Показатели пульса: 40-220 ударов в минуту
  - GPS координаты в допустимых диапазонах (широта: -90 до 90, долгота: -180 до 180)
- **Бизнес-правила:**
  - Автоматическая пауза при остановке движения более 10 секунд
  - Расчет калорий на основе веса пользователя, возраста и интенсивности
  - Валидация данных с внешних устройств на соответствие физиологическим нормам
  - Генерация предупреждений при опасных показателях здоровья

### Акторы:
Активный пользователь, Внешние устройства (опционально)

### Предусловия:
Пользователь авторизован в приложении. Приложение имеет доступ к данным о местоположении (для outdoor-тренировок).

### Основной поток:
1. Пользователь нажимает "Начать тренировку" на главном экране
2. Система показывает экран выбора типа тренировки (бег, ходьба, велосипед, йога и т.д.)
3. Пользователь выбирает "Бег"
4. Система предлагает выбрать цель (расстояние, время, калории) или тренировку без цели
5. Пользователь выбирает "5 км" в качестве цели
6. Система показывает экран подготовки с таймером 3-2-1, публикует WorkoutStarted
7. Начинается трекинг тренировки:
   - Отображается текущее время, расстояние, темп, калории
   - На карте отображается маршрут (если outdoor)
   - Система периодически озвучивает прогресс (каждые 500 метров)
   - Публикуются MetricRecorded события каждые 30 секунд
8. Пользователь завершает тренировку, нажав "Стоп"
9. Система показывает экран результатов:
   - Общая статистика (время, расстояние, средний темп, калории)
   - Достижения (если есть)
   - Сравнение с предыдущими тренировками
10. Пользователь может добавить заметки или фото к тренировке
11. Пользователь нажимает "Сохранить"
12. Система сохраняет тренировку, обновляет статистику пользователя, публикует WorkoutCompleted и WorkoutAnalyzed

### Альтернативный поток A: Использование внешнего устройства
1. На шаге 1 система обнаруживает подключенное фитнес-устройство (например, Apple Watch)
2. Система предлагает использовать данные с устройства
3. Пользователь подтверждает
4. Во время тренировки отображаются дополнительные метрики (пульс, высота, cadence)
5. После завершения данные синхронизируются с устройством

### Альтернативный поток B: Пауза во время тренировки
1. Во время тренировки пользователь нажимает "Пауза"
2. Трекинг приостанавливается, публикуется WorkoutPaused
3. Пользователь может возобновить тренировку (публикуется WorkoutResumed) или завершить ее

### Альтернативный поток C: Автоматическое определение паузы
1. Во время бега пользователь останавливается (например, на светофоре)
2. Система автоматически ставит на паузу через 10 секунд остановки
3. При возобновлении движения система автоматически возобновляет трекинг

### Альтернативный поток D: Срабатывание предупреждения о здоровье
1. Во время тренировки пульс пользователя превышает безопасный порог (например, 190 уд/мин для возраста 30 лет)
2. Система публикует HealthAlertTriggered
3. Пользователь получает визуальное и аудио предупреждение
4. Система предлагает снизить интенсивность или остановиться

### Постусловия:
Создан агрегат WorkoutSession со всеми метриками. Статистика пользователя обновлена. Если достигнуты новые достижения - показываются уведомления. Публикуются доменные события для интеграции с другими контекстами (Social, Gamification, Analytics).

---

## Use Case 3: Создание социальной группы

### ID:
UC-003

### DDD-анализ:
- **Ограниченные контексты:** Social Graph Context, Notification Context, User Context
- **Основные агрегаты:** SocialGroup (корневой), GroupMembership, GroupSettings, UserProfile
- **Объекты-значения:** GroupType, PrivacyLevel, GeographicRegion, MembershipRole, GroupCategory
- **Доменные события:**
  - GroupCreated
  - GroupSettingsUpdated
  - MemberInvited
  - MemberJoined
  - GroupPromoted
- **Инварианты:**
  - Название группы должно быть уникальным в рамках одного региона
  - Группа должна иметь минимум одного администратора
  - Максимальный размер группы зависит от типа подписки создателя
  - Географические ограничения должны быть валидными координатами или названиями регионов
- **Бизнес-правила:**
  - Автоматическое назначение создателя администратором группы
  - Проверка прав пользователя на создание групп (минимум 3 завершенные тренировки)
  - Автоматическая модерация названий и описаний групп
  - Ограничение создания групп для пользователей с нарушенными правилами сообщества

### Акторы:
Социальный лидер

### Предусловия:
Пользователь авторизован. Пользователь имеет минимум 3 завершенные тренировки.

### Основной поток:
1. Пользователь переходит в раздел "Сообщество"
2. Пользователь нажимает "Создать группу"
3. Система запрашивает название группы
4. Пользователь вводит "Бегуны Москвы"
5. Система запрашивает описание группы
6. Пользователь вводит "Группа для любителей бега в Москве"
7. Система предлагает выбрать тип группы (открытая, закрытая, приватная)
8. Пользователь выбирает "Открытая"
9. Система предлагает выбрать интересы группы (бег, марафон, parkrun)
10. Пользователь выбирает соответствующие интересы
11. Система предлагает установить географические ограничения (город, район)
12. Пользователь выбирает "Москва"
13. Система создает группу, назначает пользователя администратором, публикует GroupCreated
14. Система показывает экран управления группой

### Альтернативный поток A: Создание группы по шаблону
1. На шаге 2 пользователь выбирает "Создать по шаблону"
2. Система предлагает шаблоны (Челлендж на месяц, Подготовка к марафону, Утренние пробежки)
3. Пользователь выбирает шаблон
4. Система заполняет часть полей автоматически
5. Пользователь корректирует при необходимости и сохраняет

### Альтернативный поток B: Ограничение по уровню подготовки
1. На шаге 11 система предлагает установить ограничения по уровню подготовки
2. Пользователь выбирает "Только для продвинутых"
3. В группу смогут вступить только пользователи с уровнем "любитель" или "профессионал"

### Альтернативный поток C: Автоматическое приглашение друзей
1. После создания группы система анализирует друзей пользователя с похожими интересами
2. Система автоматически отправляет приглашения 5 наиболее подходящим друзьям
3. Публикуются события MemberInvited

### Постусловия:
Создан агрегат SocialGroup с настройками. Пользователь назначен администратором. Группа отображается в поиске для других пользователей. Публикуются доменные события для уведомления потенциальных участников.

---

## Use Case 4: Участие в групповом челлендже

### ID:
UC-004

### DDD-анализ:
- **Ограниченные контексты:** Gamification Context, Social Graph Context, Workout Tracking Context, Notification Context, Analytics Context
- **Основные агрегаты:** Challenge (корневой), ParticipantProgress, Leaderboard, Reward, UserContribution
- **Объекты-значения:** ChallengeType, ChallengeStatus, ProgressValue, RankingPosition, RewardTier, TimeInterval
- **Доменные события:**
  - ChallengeAnnounced
  - ChallengeJoined
  - ProgressUpdated
  - MilestoneAchieved
  - LeaderboardUpdated
  - RewardUnlocked
  - ChallengeCompleted
- **Инварианты:**
  - Прогресс участника не может уменьшаться (кроме корректировок администратором)
  - Участник не может быть зарегистрирован в одном челлендже более одного раза
  - Награды могут быть выданы только при достижении соответствующих условий
  - Человек может участвовать только в челленджах, доступных в его регионе
- **Бизнес-правила:**
  - Автоматическая синхронизация прогресса тренировок с челленджем
  - Пересчет рейтинга при каждом обновлении прогресса участника
  - Проверка соответствия региональных ограничений челленджа
  - Ограничение на количество участников в челлендже (если установлено)
  - Выдача промежуточных наград при достижении контрольных точек

### Акторы:
Активный пользователь, Социальный лидер, Система рекомендаций

### Предусловия:
Пользователь состоит как минимум в одной группе. В группе активен челлендж.

### Основной поток:
1. Пользователь заходит в группу "Бегуны Москвы"
2. Система показывает активный челлендж "100 км за январь"
3. Пользователь нажимает "Участвовать"
4. Система добавляет пользователя в список участников челленджа, публикует ChallengeJoined
5. Пользователь завершает тренировку (UC-002)
6. Система автоматически добавляет километраж к челленджу, публикует ProgressUpdated
7. Если достигнута контрольная точка (например, 25%), публикуется MilestoneAchieved
8. Пользователь заходит в раздел челленджа
9. Система показывает:
   - Прогресс пользователя (например, 35/100 км)
   - Рейтинг участников (обновляется после каждого ProgressUpdated)
   - Оставшееся время (например, 15 дней)
10. По завершении челленджа система определяет победителей, публикует ChallengeCompleted
11. Пользователь получает уведомление о результатах и наградах

### Альтернативный поток A: Рекомендация челленджа
1. Пользователь заходит в приложение
2. Система рекомендаций предлагает присоединиться к челленджу на основе истории тренировок
3. Пользователь принимает предложение
4. Переход к шагу 4 основного потока

### Альтернативный поток B: Создание личного челленджа на основе группового
1. На шаге 3 пользователь нажимает "Создать личную цель"
2. Система предлагает скорректировать цель (например, 50 км вместо 100 км)
3. Пользователь устанавливает личную цель
4. Система создает персональный челлендж на основе группового

### Альтернативный поток C: Досрочное завершение челленджа
1. Пользователь достигает цели челленджа раньше срока (например, пробегает 100 км за 20 дней вместо 31)
2. Система публикует ChallengeCompleted досрочно
3. Пользователь получает бонусные награды за досрочное завершение

### Постусловия:
Пользователь участвует в челлендже. Прогресс тренировок автоматически учитывается. По завершении пользователь получает виртуальные или реальные награды. Публикуются доменные события для интеграции с другими системами (нотификации, аналитика, коммерция).

---

## Use Case 5: Получение рекомендаций по обновлению экипировки

### ID:
UC-005

### DDD-анализ:
- **Ограниченные контексты:** Inventory & Commerce Context, Analytics Context, Workout Tracking Context, Notification Context, Promotions Context
- **Основные агрегаты:** Equipment (корневой), UsageHistory, ProductCatalog, Recommendation, UserProfile
- **Объекты-значения:** EquipmentType, WearLevel, ProductSpecification, RecommendationScore, PurchaseHistory
- **Доменные события:**
  - EquipmentAdded
  - UsageRecorded
  - WearThresholdReached
  - RecommendationGenerated
  - PromotionApplied
  - PurchaseInitiated
- **Инварианты:**
  - Оборудование не может иметь отрицательный износ
  - Рекомендации должны основываться на актуальных данных об использовании
  - Промокоды действительны только в установленный период
  - Рекомендуемый товар должен быть в наличии в регионе пользователя
- **Бизнес-правила:**
  - Автоматический расчет износа на основе пробега и типа тренировок
  - Генерация рекомендаций при достижении порога износа (например, 800 км для беговых кроссовок)
  - Учет региональных промоакций при формировании рекомендаций
  - Персонализация рекомендаций на основе типа стопы, веса, стиля бега
  - Интеграция с e-commerce для проверки наличия и цен

### Акторы:
Профессиональный спортсмен, Система рекомендаций

### Предусловия:
Пользователь указал свой спортивный инвентарь в профиле. Пользователь активно тренируется.

### Основной поток:
1. Пользователь завершил 500-ю тренировку по бегу
2. Система анализирует агрегат Equipment пользователя:
   - Пробег текущей обуви (например, 800 км)
   - Средний темп и тип поверхности (дорожка, асфальт, трейл)
   - Историю замен обуви
3. Система определяет, что достигнут порог износа, публикует WearThresholdReached
4. Система отправляет push-уведомление: "Ваши кроссовки прошли 800 км. Рекомендуем обновить обувь для предотвращения травм"
5. Пользователь нажимает на уведомление
6. Система показывает детализированный отчет:
   - История использования текущей обуви (агрегат UsageHistory)
   - Рекомендации по выбору новой обуви
   - Сравнение моделей из агрегата ProductCatalog
7. Система предлагает подходящие модели из ассортимента компании
8. Пользователь выбирает "Посмотреть рекомендации"
9. Система показывает персонализированные рекомендации с фильтрами:
   - Для бега по асфальту
   - Уровень амортизации
   - Вес и тип стопы
10. Система применяет доступные промоакции, публикует PromotionApplied
11. Пользователь выбирает модель и нажимает "Купить"
12. Система перенаправляет в магазин компании с предзаполненной корзиной, публикует PurchaseInitiated

### Альтернативный поток A: Активное запрашивание рекомендаций
1. Пользователь заходит в раздел "Мой инвентарь"
2. Пользователь нажимает "Получить рекомендации"
3. Система анализирует данные и показывает рекомендации

### Альтернативный поток B: Рекомендации на основе промоакции
1. В компании проходит промоакция на беговые кроссовки
2. Система рекомендует обновить обувь пользователям, у которых пробег превышает 600 км
3. В рекомендации включается информация о скидке

### Альтернативный поток C: Рекомендация дополнительного оборудования
1. На основе анализа тренировок система выявляет потребность в дополнительном оборудовании
2. Например, пользователь начал бегать в холодную погоду - система рекомендует термобелье
3. Рекомендация формируется с учетом сезона и региона пользователя

### Постусловия:
Пользователь получил персонализированные рекомендации на основе данных об износе оборудования. Система интегрирована с e-commerce для seamless покупки. Публикуются доменные события для аналитики и отслеживания конверсии.

---

## Use Case 6: Организация оффлайн-встречи для совместной тренировки

### ID:
UC-006

### DDD-анализ:
- **Ограниченные контексты:** Social Graph Context, Event Management Context, Location & Mapping Context, Notification Context, Workout Planning Context
- **Основные агрегаты:** Event (корневой), EventParticipation, Location, Schedule, GroupAssociation
- **Объекты-значения:** EventType, EventStatus, LocationCoordinates, DateTimeRange, ParticipantLimit, RecurrencePattern
- **Доменные события:**
  - EventCreated
  - EventPublished
  - ParticipantRegistered
  - EventUpdated
  - EventCancelled
  - ReminderSent
  - EventCompleted
- **Инварианты:**
  - Дата события должна быть в будущем относительно времени создания
  - Местоположение должно быть валидными координатами или адресом
  - Количество участников не может превышать установленный лимит
  - Организатор события должен быть членом группы, в которой создается событие
- **Бизнес-правила:**
  - Автоматическая проверка доступности местоположения (парки, стадионы, безопасные маршруты)
  - Ограничение частоты создания событий для одного организатора
  - Автоматическая отправка напоминаний за 24 часа и 1 час до события
  - Проверка погодных условий для outdoor-событий и отправка рекомендаций
  - Подбор оптимального времени встречи на основе расписания большинства участников

### Акторы:
Социальный лидер, Активный пользователь

### Предусловия:
Пользователь состоит в группе. Пользователь имеет друзей в приложении.

### Основной поток:
1. Пользователь заходит в группу "Бегуны Москвы"
2. Пользователь нажимает "Организовать встречу"
3. Система запрашивает тип встречи (тренировка, соревнование, семинар)
4. Пользователь выбирает "Совместная тренировка"
5. Система запрашивает дату и время
6. Пользователь выбирает завтра, 19:00
7. Система предлагает выбрать место на карте или ввести адрес
8. Пользователь выбирает "Парк Горького, главный вход"
9. Система показывает карту с выбранным местом, проверяет доступность локации
10. Пользователь добавляет описание: "Легкая пробежка 5 км для всех уровней"
11. Пользователь устанавливает максимальное количество участников (20 человек)
12. Система создает событие, публикует EventCreated и EventPublished
13. Событие отображается в группе, участники группы могут записаться
14. За 24 часа до события система отправляет напоминание всем записавшимся, публикует ReminderSent

### Альтернативный поток A: Приглашение друзей напрямую
1. После создания события пользователь нажимает "Пригласить друзей"
2. Система показывает список друзей с учетом их спортивных интересов и местоположения
3. Пользователь выбирает друзей для приглашения
4. Система отправляет персональные приглашения

### Альтернативный поток B: Повторяющееся событие
1. На шаге 5 пользователь выбирает "Повторяющееся событие"
2. Система предлагает выбрать частоту (еженедельно, по вторникам и четвергам)
3. Пользователь устанавливает повторение
4. Система создает серию событий с уникальными ID для каждого экземпляра

### Альтернативный поток C: Отмена события
1. Организатор решает отменить событие
2. Система публикует EventCancelled
3. Все зарегистрированные участники получают уведомление об отмене
4. Событие помечается как отмененное в календаре

### Постусловия:
Создан агрегат Event с информацией о встрече. Участники группы могут записываться. Система автоматически управляет напоминаниями и уведомлениями. После завершения события публикуется EventCompleted для аналитики.

---

## Use Case 7: Использование приложения в регионе без стабильного интернета

### ID:
UC-007

### DDD-анализ:
- **Ограниченные контексты:** Workout Tracking Context, Data Synchronization Context, Device Context, Location Context, Offline Operations Context
- **Основные агрегаты:** OfflineWorkoutSession (корневой), LocalDataStore, SyncQueue, MapCache, DeviceBuffer
- **Объекты-значения:** ConnectionStatus, SyncPriority, DataChunk, LocationBatch, CompressionLevel
- **Доменные события:**
  - OfflineModeActivated
  - WorkoutDataBuffered
  - SyncQueueCreated
  - ConnectionRestored
  - DataSyncStarted
  - DataSyncCompleted
  - SyncConflictDetected
- **Инварианты:**
  - Оффлайн данные должны быть сохранены локально перед завершением тренировки
  - Размер локального хранилища не должен превышать лимит устройства
  - Данные для синхронизации должны иметь временные метки и порядковые номера
  - При конфликте синхронизации приоритет имеют данные с устройства
- **Бизнес-правила:**
  - Автоматическое переключение в оффлайн режим при потере соединения
  - Компрессия данных для экономии места на устройстве
  - Приоритетная синхронизация ключевых метрик (время, расстояние, маршрут)
  - Автоматическое разрешение конфликтов на основе временных меток
  - Уведомление пользователя о необходимости синхронизации при восстановлении связи

### Акторы:
Активный пользователь

### Предусловия:
Пользователь собирается в поход в горный регион. Пользователь заранее загрузил карты.

### Основной поток:
1. Пользователь включает режим "Оффлайн" в настройках, система публикует OfflineModeActivated
2. Пользователь начинает тренировку (поход) без подключения к интернету
3. Система записывает трек, используя GPS телефона, данные буферизуются в агрегате DeviceBuffer
4. Система сохраняет данные локально в агрегате LocalDataStore, публикует WorkoutDataBuffered
5. Пользователь периодически видит свой прогресс на загруженной карте из агрегата MapCache
6. После возвращения в зону покрытия пользователь включает синхронизацию
7. Система обнаруживает восстановление связи, публикует ConnectionRestored
8. Система создает агрегат SyncQueue с данными для синхронизации
9. Система загружает данные на сервер, публикует DataSyncStarted и DataSyncCompleted
10. Система обрабатывает данные и добавляет тренировку в историю

### Альтернативный поток A: Частичная синхронизация при слабом сигнале
1. В зоне слабого сигнала система пытается синхронизировать ключевые данные
2. Система отправляет только основные метрики (координаты, время старта/финиша)
3. Детальная телеметрия сохраняется для последующей синхронизации
4. Система использует повышенный уровень компрессии для экономии трафика

### Альтернативный поток B: Ручная синхронизация
1. Пользователь вручную выбирает тренировки для синхронизации из списка в агрегате SyncQueue
2. Система показывает прогресс загрузки для каждого элемента очереди
3. При обрыве соединения система возобновляет загрузку с места остановки

### Альтернативный поток C: Обнаружение конфликта данных
1. При синхронизации обнаруживается, что те же данные уже были загружены с другого устройства
2. Система публикует SyncConflictDetected
3. Пользователю предлагается выбрать, какие данные сохранить (с устройства или с сервера)
4. Выбранные данные сохраняются, конфликт разрешается

### Постусловия:
Тренировка сохранена локально в агрегате OfflineWorkoutSession и синхронизирована при появлении соединения. Данные доступны в облаке. Очередь синхронизации очищена. Все доменные события обработаны соответствующими контекстами.

---

## Матрица трассируемости сценариев использования с DDD-контекстами

| Use Case ID | Название | Соответствующие бизнес-требования | DDD-контексты | Основные агрегаты | Доменные события |
|-------------|----------|-----------------------------------|---------------|-------------------|------------------|
| UC-001 | Регистрация и создание профиля | 1, 4 | Identity & Access, Social Graph | User, PrivacySettings | UserRegistered, ProfileCreated |
| UC-002 | Завершение тренировки с трекингом | 2, 4, 5, 9 | Workout Tracking, Device Integration, Analytics | WorkoutSession, Metric | WorkoutStarted, WorkoutCompleted, MetricsRecorded |
| UC-003 | Создание социальной группы | 1, 3 | Social Graph, Notification | SocialGroup, GroupMembership | GroupCreated, MemberJoined |
| UC-004 | Участие в групповом челлендже | 1, 2, 7 | Gamification, Social Graph, Analytics | Challenge, ParticipantProgress | ChallengeJoined, ProgressUpdated, RewardEarned |
| UC-005 | Получение рекомендаций по обновлению экипировки | 4, 8, 10, 11 | Inventory & Commerce, Analytics, Promotions | Equipment, ProductCatalog | WearThresholdReached, RecommendationGenerated |
| UC-006 | Организация оффлайн-встречи | 1, 3 | Social Graph, Event Management | Event, EventParticipation | EventCreated, ParticipantRegistered |
| UC-007 | Использование в регионе без интернета | 1, 2, 5 | Offline Operations, Data Synchronization | OfflineWorkoutSession, SyncQueue | OfflineModeActivated, DataSyncCompleted |

## Взаимодействие ограниченных контекстов в сценариях

### Сквозные сценарии с участием нескольких контекстов:

1. **Тренировка с последующим участием в челлендже (UC-002 → UC-004):**
   - Workout Tracking Context публикует WorkoutCompleted
   - Gamification Context подписывается на событие и обновляет прогресс в челлендже
   - Social Graph Context получает уведомление для отображения в ленте группы

2. **Рекомендация экипировки на основе износа (UC-002 → UC-005):**
   - Workout Tracking Context накапливает данные об использовании оборудования
   - Analytics Context анализирует износ и определяет момент для рекомендации
   - Inventory & Commerce Context формирует персонализированное предложение
   - Promotions Context добавляет региональные промоакции

3. **Организация встречи с оффлайн-участием (UC-006 → UC-007):**
   - Event Management Context создает событие с геолокацией
   - Offline Operations Context кэширует карты и данные события
   - При восстановлении связи Data Synchronization Context синхронизирует результаты

## Примечания по реализации с учетом DDD

### Архитектурные решения:

1. **Стратегия разделения контекстов:**
   - Каждый ограниченный контекст реализуется как отдельный микросервис
   - Обмен данными между контекстами через доменные события (event-driven architecture)
   - Использование API Gateway для маршрутизации запросов к соответствующим контекстам

2. **Управление агрегатами:**
   - Каждый агрегат имеет четко определенные границы транзакций
   - Оптимистичные блокировки для конкурентного доступа к агрегатам
   - Event sourcing для критичных агрегатов (User, WorkoutSession, Challenge)

3. **Синхронизация данных между контекстами:**
   - Асинхронная обработка доменных событий через message broker (Kafka/RabbitMQ)
   - Materialized views для запросов, затрагивающих несколько контекстов
   - Saga pattern для управления distributed transactions

### Особые требования DDD:

1. **Инварианты и бизнес-правила:**
   - Все инварианты проверяются внутри агрегатов перед сохранением изменений
   - Сложные бизнес-правила вынесены в отдельные доменные сервисы
   - Валидация данных на всех уровнях (UI, Application, Domain)

2. **Консистентность данных:**
   - Eventual consistency для данных, распределенных между контекстами
   - Компенсирующие транзакции для отката изменений при сбоях
   - Механизмы идемпотентности для повторной обработки событий

3. **Масштабируемость:**
   - Каждый контекст может масштабироваться независимо
   - Разделение чтения и записи (CQRS) для контекстов с высокой нагрузкой
   - Географическое распределение данных по регионам пользователей

### Безопасность в DDD-архитектуре:

1. **Контроль доступа к агрегатам:**
   - Проверка прав доступа перед каждой операцией с агрегатом
   - Ролевая модель доступа с учетом контекста
   - Аудит всех изменений агрегатов

2. **Защита доменных событий:**
   - Шифрование конфиденциальных данных в событиях
   - Проверка целостности событий при передаче между контекстами
   - Ограничение доступа к шинам событий

## Заключение

Сценарии использования, представленные в этом документе, охватывают ключевые функциональности фитнес-социального приложения. DDD-подход позволяет четко разделить ответственность между различными доменными контекстами, обеспечивая масштабируемость и гибкость архитектуры.

Каждый сценарий спроектирован с учетом инвариантов, бизнес-правил и доменных событий, что обеспечивает целостность данных и соответствие бизнес-требованиям. Матрица трассируемости демонстрирует связь между функциональностью, бизнес-требованиями и архитектурными компонентами, что важно для управления разработкой и тестированием системы.


