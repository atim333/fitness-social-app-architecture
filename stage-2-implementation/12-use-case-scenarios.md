# 12. Сценарии использования приложения

## Обзор
Сценарии использования (Use Cases) описывают взаимодействие пользователей с системой для достижения конкретных целей. Эти сценарии используются для проектирования пользовательского интерфейса, API и бизнес-логики. В DDD-перспективе каждый сценарий связывается с ограниченными контекстами, агрегатами и доменными событиями.

## DDD-перспектива сценариев

### Ключевые ограниченные контексты:
1. **Identity & Authentication Context** - управление пользователями, аутентификация, авторизация
2. **Workout & Training Context** - трекинг тренировок, сбор телеметрии
3. **Social & Community Context** - социальные связи, группы, события
4. **Gamification & Motivation Context** - достижения, челленджи, награды
5. **Commerce & Promotions Context** - управление инвентарем, рекомендации товаров, промоакции
6. **Health & Device Integration Context** - интеграция с медицинскими устройствами, сбор данных о здоровье
7. **Event Management & Booking Context** - организация событий, бронирование мест
8. **Analytics & Recommendations Context** - аналитика, машинное обучение, персонализация

### Основные агрегаты:
- **User** - профиль пользователя, учетные данные
- **TrainingSession** - тренировочная сессия с метриками
- **SocialGroup** - социальная группа с участниками
- **Challenge** - соревнование или челлендж
- **Equipment** - спортивный инвентарь и его использование
- **SportEvent** - спортивное событие с расписанием и местом
- **ShoppingSession** - сессия покупки с корзиной товаров
- **Booking** - бронирование места на событие

## Основные акторы (Actors)

### Первичные акторы:
1. **Новичок (Beginner)** - новый пользователь, только установивший приложение
2. **Активный пользователь (Active User)** - регулярно использующий приложение для тренировок
3. **Социальный лидер (Social Leader)** - пользователь, активно участвующий в группах и соревнованиях
4. **Профессиональный спортсмен (Pro Athlete)** - пользователь с высокими требованиями к аналитике и устройствам
5. **Администратор (Admin)** - сотрудник компании, управляющий контентом и промоакциями

### Вторичные акторы:
6. **Система рекомендаций (Recommendation System)** - автоматическая система рекомендаций
7. **Внешние устройства (External Devices)** - фитнес-браслеты, датчики
8. **Платежная система (Payment System)** - внешние системы обработки платежей

---

## Use Case 1: Регистрация и создание профиля

### ID:
UC-001

### DDD-анализ:
- **Ограниченные контексты:** Identity & Authentication Context, Social & Community Context
- **Основные агрегаты:** User (корневой), PrivacySettings, SportPreferences
- **Объекты-значения:** Email, PasswordHash, UserPreferences, SportInterest
- **Доменные события:** UserRegistered, ProfileCreated, InterestsSelected, PrivacySettingsConfigured
- **Инварианты:**
  - Email должен быть уникальным в системе
  - Пользователь должен быть старше 13 лет
  - Пароль должен соответствовать политике безопасности (12+ символов, спецсимволы)
- **Бизнес-правила:**
  - Автоматическая верификация email при регистрации
  - Создание стандартного набора спортивных интересов при первом входе
  - Настройка приватности по умолчанию для нового пользователя

### Акторы:
Новичок

### Предусловия:
Пользователь скачал и открыл приложение впервые.

### Основной поток:
1. Пользователь нажимает "Начать"
2. Система предлагает войти через социальные сети или зарегистрироваться по email
3. Пользователь выбирает "Регистрация по email"
4. Система запрашивает email, пароль и подтверждение пароля
5. Пользователь вводит данные и нажимает "Продолжить"
6. Система отправляет письмо для подтверждения email
7. Пользователь подтверждает email и возвращается в приложение
8. Система запрашивает базовую информацию (имя, дата рождения, пол)
9. Пользователь вводит данные
10. Система предлагает выбрать спортивные интересы из списка (бег, йога, велоспорт и т.д.)
11. Пользователь выбирает 3-5 интересов
12. Система предлагает указать уровень подготовки (новичок, любитель, профессионал)
13. Пользователь выбирает уровень
14. Система создает профиль, публикует UserRegistered, показывает приветственный экран

### Альтернативный поток A: Регистрация через социальные сети
1. На шаге 2 пользователь выбирает "Войти через Facebook/Google/Apple"
2. Система перенаправляет в сервис аутентификации
3. Пользователь подтверждает доступ
4. Система получает базовую информацию из социального профиля
5. Переход к шагу 8 основного потока

### Альтернативный поток B: Пропуск шагов настройки
1. На шагах 8-13 пользователь может нажать "Пропустить"
2. Система создает профиль с минимальными данными
3. Пользователь может заполнить профиль позже в настройках

### Постусловия:
Создан агрегат User с настройками приватности. Пользователь аутентифицирован в системе. Публикованы доменные события для интеграции с другими контекстами.

---

## Use Case 2: Завершение тренировки с трекингом

### ID:
UC-002

### DDD-анализ:
- **Ограниченные контексты:** Workout & Training Context, Health & Device Integration Context, Analytics & Recommendations Context
- **Основные агрегаты:** TrainingSession (корневой), Exercise, Metric, DeviceReading
- **Объекты-значения:** Duration, HeartRate, GPSLocation, Pace, Calories, Elevation
- **Доменные события:**
  - WorkoutStarted
  - WorkoutPaused
  - WorkoutResumed
  - MetricRecorded
  - HealthAlertTriggered
  - WorkoutCompleted
  - WorkoutAnalyzed
- **Инварианты:**
  - Минимальная продолжительность тренировки: 1 минута
  - Максимальная продолжительность без паузы: 24 часа
  - Показатели пульса: 40-220 ударов в минуту
  - GPS координаты в допустимых диапазонах (широта: -90 до 90, долгота: -180 до 180)
- **Бизнес-правила:**
  - Автоматическая пауза при остановке движения более 10 секунд
  - Расчет калорий на основе веса пользователя, возраста и интенсивности
  - Валидация данных с внешних устройств на соответствие физиологическим нормам
  - Генерация предупреждений при опасных показателях здоровья

### Акторы:
Активный пользователь, Внешние устройства (опционально)

### Предусловия:
Пользователь авторизован в приложении. Приложение имеет доступ к данным о местоположении (для outdoor-тренировок).

### Основной поток:
1. Пользователь нажимает "Начать тренировку" на главном экране
2. Система показывает экран выбора типа тренировки (бег, ходьба, велосипед, йога и т.д.)
3. Пользователь выбирает "Бег"
4. Система предлагает выбрать цель (расстояние, время, калории) или тренировку без цели
5. Пользователь выбирает "5 км" в качестве цели
6. Система показывает экран подготовки с таймером 3-2-1, публикует WorkoutStarted
7. Начинается трекинг тренировки:
   - Отображается текущее время, расстояние, темп, калории
   - На карте отображается маршрут (если outdoor)
   - Система периодически озвучивает прогресс (каждые 500 метров)
   - Публикуются MetricRecorded события каждые 30 секунд
8. Пользователь завершает тренировку, нажав "Стоп"
9. Система показывает экран результатов:
   - Общая статистика (время, расстояние, средний темп, калории)
   - Достижения (если есть)
   - Сравнение с предыдущими тренировками
10. Пользователь может добавить заметки или фото к тренировке
11. Пользователь нажимает "Сохранить"
12. Система сохраняет тренировку, обновляет статистику пользователя, публикует WorkoutCompleted и WorkoutAnalyzed

### Альтернативный поток A: Использование внешнего устройства
1. На шаге 1 система обнаруживает подключенное фитнес-устройство (например, Apple Watch)
2. Система предлагает использовать данные с устройства
3. Пользователь подтверждает
4. Во время тренировки отображаются дополнительные метрики (пульс, высота, cadence)
5. После завершения данные синхронизируются с устройством

### Альтернативный поток B: Пауза во время тренировки
1. Во время тренировки пользователь нажимает "Пауза"
2. Трекинг приостанавливается, публикуется WorkoutPaused
3. Пользователь может возобновить тренировку (публикуется WorkoutResumed) или завершить ее

### Альтернативный поток C: Автоматическое определение паузы
1. Во время бега пользователь останавливается (например, на светофоре)
2. Система автоматически ставит на паузу через 10 секунд остановки
3. При возобновлении движения система автоматически возобновляет трекинг

### Альтернативный поток D: Срабатывание предупреждения о здоровье
1. Во время тренировки пульс пользователя превышает безопасный порог (например, 190 уд/мин для возраста 30 лет)
2. Система публикует HealthAlertTriggered
3. Пользователь получает визуальное и аудио предупреждение
4. Система предлагает снизить интенсивность или остановиться

### Постусловия:
Создан агрегат TrainingSession со всеми метриками. Статистика пользователя обновлена. Если достигнуты новые достижения - показываются уведомления. Публикуются доменные события для интеграции с другими контекстами (Social, Gamification, Analytics).

---

## Use Case 3: Покупка товара с промокодом и гарантией наличия

### ID:
UC-003

### DDD-анализ:
- **Ограниченные контексты:** Commerce & Promotions Context, Inventory Context, Pricing Context, Order Context
- **Основные агрегаты:** ShoppingSession (корневой), Product, Promotion, InventoryReservation, Order
- **Объекты-значения:** CartItem, Price, Discount, Quantity, ReservationStatus, OrderStatus
- **Доменные события:**
  - CartCreated
  - ItemAddedToCart
  - PromotionApplied
  - PriceSessionValidated
  - InventoryReserved
  - OrderCreated
  - CartCleared
  - ReservationExpired
- **Инварианты:**
  - Количество товара в корзине не может превышать доступное на складе
  - Суммарная скидка по промокоду не может превышать установленный лимит (например, 70% от цены)
  - Ценовая сессия действительна только в течение установленного времени (15 минут)
  - Резервирование товара автоматически снимается через TTL (30 минут)
- **Бизнес-правила:**
  - Проверка наличия товара в регионе пользователя перед применением промокода
  - Фиксация цен на время ценовой сессии для предотвращения изменений
  - Автоматическое освобождение неоплаченных резервирований через TTL
  - Компенсирующие действия при сбоях на любом этапе оформления заказа
  - Идемпотентность операций через Idempotency-Key для предотвращения дублей

### Акторы:
Активный пользователь

### Предусловия:
Пользователь авторизован. В корзине есть товары. Пользователь имеет действующий промокод.

### Основной поток:
1. Пользователь добавляет товары в корзину, система публикует CartCreated и ItemAddedToCart
2. Пользователь переходит к оформлению заказа
3. Пользователь применяет промокод, система публикует PromotionApplied
4. Система создает ценовую сессию на 15 минут, фиксируя цены
5. Пользователь нажимает "Оформить заказ" с указанием Idempotency-Key в заголовке
6. Система проверяет Idempotency-Key: если заказ с таким ключом уже существует, возвращает существующий заказ
7. Система валидирует ценовую сессию, публикует PriceSessionValidated
8. Система резервирует товар на складах региона пользователя с TTL 30 минут, публикует InventoryReserved
9. Система создает заказ со статусом "confirmed", публикует OrderCreated
10. Система очищает корзину пользователя, публикует CartCleared
11. Система возвращает подтверждение заказа пользователю

### Альтернативный поток A: Товара нет в наличии
1. На шаге 8 система обнаруживает недостаточное количество товара
2. Система предлагает пользователю варианты:
   - Оформить частичный заказ на доступное количество
   - Подождать пополнения склада
   - Выбрать альтернативный товар
3. Пользователь выбирает вариант, система продолжает оформление

### Альтернативный поток B: Промокод недействителен
1. На шаге 3 промокод не проходит валидацию (истек срок, не подходит к товару)
2. Система показывает сообщение об ошибке и предлагает ввести другой промокод
3. Пользователь вводит новый промокод или продолжает без скидки

### Альтернативный поток C: Таймаут ценовой сессии
1. Пользователь медлит с оформлением заказа, и ценовая сессия истекает
2. Система показывает предупреждение о необходимости обновить цены
3. Система создает новую ценовую сессию с актуальными ценами
4. Пользователь подтверждает новые цены и продолжает оформление

### Альтернативный поток D: Сбой на любом этапе
1. При сбое на любом этапе система выполняет компенсирующие действия:
   - Отменяет резервирование товара
   - Восстанавливает корзину в исходное состояние
   - Уведомляет пользователя об ошибке
2. Пользователь может повторить попытку с тем же Idempotency-Key

### Постусловия:
Создан заказ со статусом "confirmed". Товар зарезервирован на 30 минут. Корзина очищена. Если в течение 30 минут заказ не оплачен, резервирование автоматически снимается (публикуется ReservationExpired).

---

## Use Case 4: Бронирование места на платном спортивном событии

### ID:
UC-004

### DDD-анализ:
- **Ограниченные контексты:** Event Management & Booking Context, Commerce & Promotions Context, Payment Context, Notification Context
- **Основные агрегаты:** SportEvent (корневой), Booking, Waitlist, PaymentTransaction
- **Объекты-значения:** SeatNumber, EventStatus, BookingStatus, PaymentAmount, PaymentMethod
- **Доменные события:**
  - EventCreated
  - SeatAvailabilityChecked
  - SeatTemporarilyReserved
  - PaymentInitiated
  - PaymentConfirmed
  - BookingConfirmed
  - BookingCancelled
  - SeatReleased
  - WaitlistNotificationSent
- **Инварианты:**
  - Место не может быть забронировано более одного раза одновременно
  - Временное резервирование действительно только в течение TTL (15 минут)
  - Статус бронирования может меняться только в допустимой последовательности
  - Возврат средств возможен только в соответствии с политикой отмены события
- **Бизнес-правила:**
  - Приоритетное бронирование для премиум-пользователей (24-часовое окно)
  - Автоматическая отмена неоплаченных броней через TTL 15 минут
  - Автоматическое предложение освободившихся мест пользователям в листе ожидания
  - Компенсирующие действия при сбоях оплаты или системных ошибках
  - Идемпотентность операций бронирования через Idempotency-Key

### Акторы:
Активный пользователь, Социальный лидер

### Предусловия:
Событие создано администратором. Пользователь авторизован. У пользователя достаточно средств на счету.

### Основной поток:
1. Пользователь выбирает событие в календаре и нажимает "Забронировать место"
2. Система запрашивает Idempotency-Key (генерируется автоматически или предоставляется клиентом)
3. Система проверяет доступность мест, публикует SeatAvailabilityChecked
4. Система блокирует выбранное место с помощью SELECT FOR UPDATE, предотвращая параллельные бронирования
5. Система создает временное резервирование с TTL 15 минут, публикует SeatTemporarilyReserved
6. Пользователь подтверждает бронирование и переходит к оплате
7. Система инициирует платеж, публикует PaymentInitiated
8. Платежная система подтверждает успешную оплату
9. Система меняет статус бронирования на "confirmed", публикует PaymentConfirmed и BookingConfirmed
10. Место окончательно закрепляется за пользователем
11. Система отправляет подтверждение бронирования на email и push-уведомление

### Альтернативный поток A: Премиум-бронирование
1. Премиум-пользователь имеет доступ к бронированию за 24 часа до общего доступа
2. Система проверяет статус подписки пользователя
3. Если пользователь премиум, система позволяет забронировать место раньше
4. Остальные шаги аналогичны основному потоку

### Альтернативный поток B: Истечение TTL резервирования
1. Пользователь не завершил оплату в течение 15 минут
2. Система автоматически освобождает место, публикует SeatReleased
3. Система уведомляет пользователя об истечении времени бронирования
4. Освободившееся место предлагается следующему в очереди ожидания

### Альтернативный поток C: Место уже забронировано
1. На шаге 4 система обнаруживает, что место уже забронировано другим пользователем
2. Система предлагает альтернативные доступные места
3. Если пользователь согласен, продолжается бронирование нового места
4. Если нет - пользователь может встать в лист ожидания

### Альтернативный поток D: Сбой оплаты
1. На шаге 8 платеж отклоняется (недостаточно средств, ошибка карты)
2. Система освобождает место и уведомляет пользователя
3. Пользователь может повторить попытку с другой картой или способом оплаты
4. При повторной попытке используется тот же Idempotency-Key для предотвращения дублей

### Постусловия:
Место забронировано и оплачено. Бронирование подтверждено. В случае неоплаты в течение TTL место автоматически освобождается. Все компенсирующие действия выполнены при необходимости.

---

## Use Case 5: Создание социальной группы

### ID:
UC-005

### DDD-анализ:
- **Ограниченные контексты:** Social & Community Context, Identity & Authentication Context, Notification Context
- **Основные агрегаты:** SocialGroup (корневой), GroupMembership, GroupSettings, UserProfile
- **Объекты-значения:** GroupType, PrivacyLevel, GeographicRegion, MembershipRole, GroupCategory
- **Доменные события:**
  - GroupCreated
  - GroupSettingsUpdated
  - MemberInvited
  - MemberJoined
  - GroupPromoted
- **Инварианты:**
  - Название группы должно быть уникальным в рамках одного региона
  - Группа должна иметь минимум одного администратора
  - Максимальный размер группы зависит от типа подписки создателя
  - Географические ограничения должны быть валидными координатами или названиями регионов
- **Бизнес-правила:**
  - Автоматическое назначение создателя администратором группы
  - Проверка прав пользователя на создание групп (минимум 3 завершенные тренировки)
  - Автоматическая модерация названий и описаний групп
  - Ограничение создания групп для пользователей с нарушенными правилами сообщества

### Акторы:
Социальный лидер

### Предусловия:
Пользователь авторизован. Пользователь имеет минимум 3 завершенные тренировки.

### Основной поток:
1. Пользователь переходит в раздел "Сообщество"
2. Пользователь нажимает "Создать группу"
3. Система запрашивает название группы
4. Пользователь вводит "Бегуны Москвы"
5. Система запрашивает описание группы
6. Пользователь вводит "Группа для любителей бега в Москве"
7. Система предлагает выбрать тип группы (открытая, закрытая, приватная)
8. Пользователь выбирает "Открытая"
9. Система предлагает выбрать интересы группы (бег, марафон, parkrun)
10. Пользователь выбирает соответствующие интересы
11. Система предлагает установить географические ограничения (город, район)
12. Пользователь выбирает "Москва"
13. Система создает группу, назначает пользователя администратором, публикует GroupCreated
14. Система показывает экран управления группой

### Альтернативный поток A: Создание группы по шаблону
1. На шаге 2 пользователь выбирает "Создать по шаблону"
2. Система предлагает шаблоны (Челлендж на месяц, Подготовка к марафону, Утренние пробежки)
3. Пользователь выбирает шаблон
4. Система заполняет часть полей автоматически
5. Пользователь корректирует при необходимости и сохраняет

### Альтернативный поток B: Ограничение по уровню подготовки
1. На шаге 11 система предлагает установить ограничения по уровню подготовки
2. Пользователь выбирает "Только для продвинутых"
3. В группу смогут вступить только пользователи с уровнем "любитель" или "профессионал"

### Альтернативный поток C: Автоматическое приглашение друзей
1. После создания группы система анализирует друзей пользователя с похожими интересами
2. Система автоматически отправляет приглашения 5 наиболее подходящим друзьям
3. Публикуются события MemberInvited

### Постусловия:
Создан агрегат SocialGroup с настройками. Пользователь назначен администратором. Группа отображается в поиске для других пользователей. Публикуются доменные события для уведомления потенциальных участников.

---

## Use Case 6: Участие в групповом челлендже

### ID:
UC-006

### DDD-анализ:
- **Ограниченные контексты:** Gamification & Motivation Context, Social & Community Context, Workout & Training Context, Analytics & Recommendations Context
- **Основные агрегаты:** Challenge (корневой), ParticipantProgress, Leaderboard, Reward, UserContribution
- **Объекты-значения:** ChallengeType, ChallengeStatus, ProgressValue, RankingPosition, RewardTier, TimeInterval
- **Доменные события:**
  - ChallengeAnnounced
  - ChallengeJoined
  - ProgressUpdated
  - MilestoneAchieved
  - LeaderboardUpdated
  - RewardUnlocked
  - ChallengeCompleted
- **Инварианты:**
  - Прогресс участника не может уменьшаться (кроме корректировок администратором)
  - Участник не может быть зарегистрирован в одном челлендже более одного раза
  - Награды могут быть выданы только при достижении соответствующих условий
  - Человек может участвовать только в челленджах, доступных в его регионе
- **Бизнес-правила:**
  - Автоматическая синхронизация прогресса тренировок с челленджем
  - Пересчет рейтинга при каждом обновлении прогресса участника
  - Проверка соответствия региональных ограничений челленджа
  - Ограничение на количество участников в челлендже (если установлено)
  - Выдача промежуточных наград при достижении контрольных точек

### Акторы:
Активный пользователь, Социальный лидер, Система рекомендаций

### Предусловия:
Пользователь состоит как минимум в одной группе. В группе активен челлендж.

### Основной поток:
1. Пользователь заходит в группу "Бегуны Москвы"
2. Система показывает активный челлендж "100 км за январь"
3. Пользователь нажимает "Участвовать"
4. Система добавляет пользователя в список участников челленджа, публикует ChallengeJoined
5. Пользователь завершает тренировку (UC-002)
6. Система автоматически добавляет километраж к челленджу, публикует ProgressUpdated
7. Если достигнута контрольная точка (например, 25%), публикуется MilestoneAchieved
8. Пользователь заходит в раздел челленджа
9. Система показывает:
   - Прогресс пользователя (например, 35/100 км)
   - Рейтинг участников (обновляется после каждого ProgressUpdated)
   - Оставшееся время (например, 15 дней)
10. По завершении челленджа система определяет победителей, публикует ChallengeCompleted
11. Пользователь получает уведомление о результатах и наградах

### Альтернативный поток A: Рекомендация челленджа
1. Пользователь заходит в приложение
2. Система рекомендаций предлагает присоединиться к челленджу на основе истории тренировок
3. Пользователь принимает предложение
4. Переход к шагу 4 основного потока

### Альтернативный поток B: Создание личного челленджа на основе группового
1. На шаге 3 пользователь нажимает "Создать личную цель"
2. Система предлагает скорректировать цель (например, 50 км вместо 100 км)
3. Пользователь устанавливает личную цель
4. Система создает персональный челлендж на основе группового

### Альтернативный поток C: Досрочное завершение челленджа
1. Пользователь достигает цели челленджа раньше срока (например, пробегает 100 км за 20 дней вместо 31)
2. Система публикует ChallengeCompleted досрочно
3. Пользователь получает бонусные награды за досрочное завершение

### Постусловия:
Пользователь участвует в челлендже. Прогресс тренировок автоматически учитывается. По завершении пользователь получает виртуальные или реальные награды. Публикуются доменные события для интеграции с другими системами (нотификации, аналитика, коммерция).

---

## Use Case 7: Получение рекомендаций по обновлению экипировки

### ID:
UC-007

### DDD-анализ:
- **Ограниченные контексты:** Commerce & Promotions Context, Analytics & Recommendations Context, Workout & Training Context, Health & Device Integration Context
- **Основные агрегаты:** Equipment (корневой), UsageHistory, ProductCatalog, Recommendation, UserProfile
- **Объекты-значения:** EquipmentType, WearLevel, ProductSpecification, RecommendationScore, PurchaseHistory
- **Доменные события:**
  - EquipmentAdded
  - UsageRecorded
  - WearThresholdReached
  - RecommendationGenerated
  - PromotionApplied
  - PurchaseInitiated
- **Инварианты:**
  - Оборудование не может иметь отрицательный износ
  - Рекомендации должны основываться на актуальных данных об использовании
  - Промокоды действительны только в установленный период
  - Рекомендуемый товар должен быть в наличии в регионе пользователя
- **Бизнес-правила:**
  - Автоматический расчет износа на основе пробега и типа тренировок
  - Генерация рекомендаций при достижении порога износа (например, 800 км для беговых кроссовок)
  - Учет региональных промоакций при формировании рекомендаций
  - Персонализация рекомендаций на основе типа стопы, веса, стиля бега
  - Интеграция с e-commerce для проверки наличия и цен

### Акторы:
Профессиональный спортсмен, Система рекомендаций

### Предусловия:
Пользователь указал свой спортивный инвентарь в профиле. Пользователь активно тренируется.

### Основной поток:
1. Пользователь завершил 500-ю тренировку по бегу
2. Система анализирует агрегат Equipment пользователя:
   - Пробег текущей обуви (например, 800 км)
   - Средний темп и тип поверхности (дорожка, асфальт, трейл)
   - Историю замен обуви
3. Система определяет, что достигнут порог износа, публикует WearThresholdReached
4. Система отправляет push-уведомление: "Ваши кроссовки прошли 800 км. Рекомендуем обновить обувь для предотвращения травм"
5. Пользователь нажимает на уведомление
6. Система показывает детализированный отчет:
   - История использования текущей обуви (агрегат UsageHistory)
   - Рекомендации по выбору новой обуви
   - Сравнение моделей из агрегата ProductCatalog
7. Система предлагает подходящие модели из ассортимента компании
8. Пользователь выбирает "Посмотреть рекомендации"
9. Система показывает персонализированные рекомендации с фильтрами:
   - Для бега по асфальту
   - Уровень амортизации
   - Вес и тип стопы
10. Система применяет доступные промоакции, публикует PromotionApplied
11. Пользователь выбирает модель и нажимает "Купить"
12. Система перенаправляет в магазин компании с предзаполненной корзиной, публикует PurchaseInitiated

### Альтернативный поток A: Активное запрашивание рекомендаций
1. Пользователь заходит в раздел "Мой инвентарь"
2. Пользователь нажимает "Получить рекомендации"
3. Система анализирует данные и показывает рекомендации

### Альтернативный поток B: Рекомендации на основе промоакции
1. В компании проходит промоакция на беговые кроссовки
2. Система рекомендует обновить обувь пользователям, у которых пробег превышает 600 км
3. В рекомендации включается информация о скидке

### Альтернативный поток C: Рекомендация дополнительного оборудования
1. На основе анализа тренировок система выявляет потребность в дополнительном оборудовании
2. Например, пользователь начал бегать в холодную погоду - система рекомендует термобелье
3. Рекомендация формируется с учетом сезона и региона пользователя

### Постусловия:
Пользователь получил персонализированные рекомендации на основе данных об износе оборудования. Система интегрирована с e-commerce для seamless покупки. Публикуются доменные события для аналитики и отслеживания конверсии.

---

## Use Case 8: Организация оффлайн-встречи для совместной тренировки

### ID:
UC-008

### DDD-анализ:
- **Ограниченные контексты:** Social & Community Context, Event Management & Booking Context, Location & Mapping Context, Notification Context, Workout & Training Context
- **Основные агрегаты:** Event (корневой), EventParticipation, Location, Schedule, GroupAssociation
- **Объекты-значения:** EventType, EventStatus, LocationCoordinates, DateTimeRange, ParticipantLimit, RecurrencePattern
- **Доменные события:**
  - EventCreated
  - EventPublished
  - ParticipantRegistered
  - EventUpdated
  - EventCancelled
  - ReminderSent
  - EventCompleted
- **Инварианты:**
  - Дата события должна быть в будущем относительно времени создания
  - Местоположение должно быть валидными координатами или адресом
  - Количество участников не может превышать установленный лимит
  - Организатор события должен быть членом группы, в которой создается событие
- **Бизнес-правила:**
  - Автоматическая проверка доступности местоположения (парки, стадионы, безопасные маршруты)
  - Ограничение частоты создания событий для одного организатора
  - Автоматическая отправка напоминаний за 24 часа и 1 час до события
  - Проверка погодных условий для outdoor-событий и отправка рекомендаций
  - Подбор оптимального времени встречи на основе расписания большинства участников

### Акторы:
Социальный лидер, Активный пользователь

### Предусловия:
Пользователь состоит в группе. Пользователь имеет друзей в приложении.

### Основной поток:
1. Пользователь заходит в группу "Бегуны Москвы"
2. Пользователь нажимает "Организовать встречу"
3. Система запрашивает тип встречи (тренировка, соревнование, семинар)
4. Пользователь выбирает "Совместная тренировка"
5. Система запрашивает дату и время
6. Пользователь выбирает завтра, 19:00
7. Система предлагает выбрать место на карте или ввести адрес
8. Пользователь выбирает "Парк Горького, главный вход"
9. Система показывает карту с выбранным местом, проверяет доступность локации
10. Пользователь добавляет описание: "Легкая пробежка 5 км для всех уровней"
11. Пользователь устанавливает максимальное количество участников (20 человек)
12. Система создает событие, публикует EventCreated и EventPublished
13. Событие отображается в группе, участники группы могут записаться
14. За 24 часа до события система отправляет напоминание всем записавшимся, публикует ReminderSent

### Альтернативный поток A: Приглашение друзей напрямую
1. После создания события пользователь нажимает "Пригласить друзей"
2. Система показывает список друзей с учетом их спортивных интересов и местоположения
3. Пользователь выбирает друзей для приглашения
4. Система отправляет персональные приглашения

### Альтернативный поток B: Повторяющееся событие
1. На шаге 5 пользователь выбирает "Повторяющееся событие"
2. Система предлагает выбрать частоту (еженедельно, по вторникам и четвергам)
3. Пользователь устанавливает повторение
4. Система создает серию событий с уникальными ID для каждого экземпляра

### Альтернативный поток C: Отмена события
1. Организатор решает отменить событие
2. Система публикует EventCancelled
3. Все зарегистрированные участники получают уведомление об отмене
4. Событие помечается как отмененное в календаре

### Постусловия:
Создан агрегат Event с информацией о встрече. Участники группы могут записываться. Система автоматически управляет напоминаниями и уведомлениями. После завершения события публикуется EventCompleted для аналитики.


---

## Use Case 9: Использование приложения в регионе без стабильного интернета

### ID:
UC-009

### DDD-анализ:
- **Ограниченные контексты:** Workout & Training Context, Data Synchronization Context, Device Integration Context, Location Context, Offline Operations Context
- **Основные агрегаты:** OfflineWorkoutSession (корневой), LocalDataStore, SyncQueue, MapCache, DeviceBuffer
- **Объекты-значения:** ConnectionStatus, SyncPriority, DataChunk, LocationBatch, CompressionLevel
- **Доменные события:**
  - OfflineModeActivated
  - WorkoutDataBuffered
  - SyncQueueCreated
  - ConnectionRestored
  - DataSyncStarted
  - DataSyncCompleted
  - SyncConflictDetected
- **Инварианты:**
  - Оффлайн данные должны быть сохранены локально перед завершением тренировки
  - Размер локального хранилища не должен превышать лимит устройства
  - Данные для синхронизации должны иметь временные метки и порядковые номера
  - При конфликте синхронизации приоритет имеют данные с устройства
- **Бизнес-правила:**
  - Автоматическое переключение в оффлайн режим при потере соединения
  - Компрессия данных для экономии места на устройстве
  - Приоритетная синхронизация ключевых метрик (время, расстояние, маршрут)
  - Автоматическое разрешение конфликтов на основе временных меток
  - Уведомление пользователя о необходимости синхронизации при восстановлении связи

### Акторы:
Активный пользователь

### Предусловия:
Пользователь собирается в поход в горный регион. Пользователь заранее загрузил карты.

### Основной поток:
1. Пользователь включает режим "Оффлайн" в настройках, система публикует OfflineModeActivated
2. Пользователь начинает тренировку (поход) без подключения к интернету
3. Система записывает трек, используя GPS телефона, данные буферизуются в агрегате DeviceBuffer
4. Система сохраняет данные локально в агрегате LocalDataStore, публикует WorkoutDataBuffered
5. Пользователь периодически видит свой прогресс на загруженной карте из агрегата MapCache
6. После возвращения в зону покрытия пользователь включает синхронизацию
7. Система обнаруживает восстановление связи, публикует ConnectionRestored
8. Система создает агрегат SyncQueue с данными для синхронизации
9. Система загружает данные на сервер, публикует DataSyncStarted и DataSyncCompleted
10. Система обрабатывает данные и добавляет тренировку в историю

### Альтернативный поток A: Частичная синхронизация при слабом сигнале
1. В зоне слабого сигнала система пытается синхронизировать ключевые данные
2. Система отправляет только основные метрики (координаты, время старта/финиша)
3. Детальная телеметрия сохраняется для последующей синхронизации
4. Система использует повышенный уровень компрессии для экономии трафика

### Альтернативный поток B: Ручная синхронизация
1. Пользователь вручную выбирает тренировки для синхронизации из списка в агрегате SyncQueue
2. Система показывает прогресс загрузки для каждого элемента очереди
3. При обрыве соединения система возобновляет загрузку с места остановки

### Альтернативный поток C: Обнаружение конфликта данных
1. При синхронизации обнаруживается, что те же данные уже были загружены с другого устройства
2. Система публикует SyncConflictDetected
3. Пользователю предлагается выбрать, какие данные сохранить (с устройства или с сервера)
4. Выбранные данные сохраняются, конфликт разрешается

### Постусловия:
Тренировка сохранена локально в агрегате OfflineWorkoutSession и синхронизирована при появлении соединения. Данные доступны в облаке. Очередь синхронизации очищена. Все доменные события обработаны соответствующими контекстами.

---

## Use Case 10: Участие в глобальном соревновании с массовой регистрацией

### ID:
UC-010

### DDD-анализ:
- **Ограниченные контексты:** Event Management & Booking Context, Gamification & Motivation Context, Social & Community Context, Analytics & Recommendations Context
- **Основные агрегаты:** GlobalChallenge (корневой), MassRegistration, RegionalLeaderboard, BatchProcessingQueue, CapacityManager
- **Объекты-значения:** GlobalChallengeId, RegionCode, RegistrationBatch, CapacityLimit, ProcessingPriority
- **Доменные события:**
  - GlobalChallengeAnnounced
  - MassRegistrationStarted
  - RegistrationBatchProcessed
  - CapacityThresholdReached
  - WaitlistCreated
  - RegistrationConfirmed
  - RegistrationRejected
- **Инварианты:**
  - Общее количество участников не может превышать глобальную квоту
  - Региональные квоты должны быть распределены пропорционально пользовательской базе
  - Обработка массовых регистраций должна быть идемпотентной
  - При превышении квоты должна создаваться очередь ожидания с приоритетами
- **Бизнес-правила:**
  - Приоритетная регистрация для премиум-пользователей в первые 24 часа
  - Балансировка нагрузки между регионами при массовой регистрации
  - Автоматическое масштабирование инфраструктуры при пиковых нагрузках
  - Компенсирующие действия при сбоях массовой обработки регистраций
  - Использование Idempotency-Key для предотвращения дублирования регистраций

### Акторы:
Активный пользователь, Социальный лидер, Система массовой обработки

### Предусловия:
Объявлено глобальное соревнование с ограниченным количеством мест. Пользователь авторизован.

### Основной поток:
1. Пользователь получает уведомление о старте регистрации на глобальное соревнование
2. Пользователь нажимает "Участвовать" и система генерирует Idempotency-Key
3. Система проверяет Idempotency-Key: если регистрация с таким ключом уже обработана, возвращает существующий результат
4. Система помещает запрос в агрегат BatchProcessingQueue с учетом приоритета (премиум-пользователи обрабатываются первыми)
5. Система проверяет доступность мест в регионе пользователя через агрегат CapacityManager
6. Если места есть, система создает регистрацию, публикует RegistrationConfirmed
7. Система уменьшает доступную квоту в регионе
8. Если мест нет, система добавляет пользователя в агрегат Waitlist, публикует WaitlistCreated
9. Пользователь получает подтверждение регистрации или уведомление о постановке в очередь
10. При освобождении места система автоматически регистрирует следующего в очереди

### Альтернативный поток A: Массовая регистрация в первые минуты
1. В первые минуты после открытия регистрации поступают десятки тысяч запросов
2. Система автоматически масштабирует вычислительные ресурсы для обработки пиковой нагрузки
3. Регистрации обрабатываются батчами по 1000 запросов, публикуются RegistrationBatchProcessed
4. Пользователи получают подтверждения асинхронно по мере обработки

### Альтернативный поток B: Превышение глобальной квоты
1. Глобальная квота участников исчерпана
2. Система публикует CapacityThresholdReached
3. Дальнейшие запросы автоматически направляются в глобальную очередь ожидания
4. При отмене регистрации освободившееся место предлагается следующему в очереди

### Альтернативный поток C: Сбой при массовой обработке
1. При обработке батча возникает системная ошибка
2. Система выполняет компенсирующие действия для всех обработанных в этом батче запросов
3. Система уведомляет администраторов о необходимости ручного вмешательства
4. После устранения ошибки обработка возобновляется с последнего успешного батча

### Постусловия:
Пользователь зарегистрирован на глобальное соревнование или поставлен в очередь ожидания. Система обработала массовую регистрацию с учетом идемпотентности и компенсирующих действий. Инфраструктура автоматически масштабировалась для обработки пиковой нагрузки.

---

## Матрица трассируемости сценариев использования с DDD-контекстами

| Use Case ID | Название | Соответствующие бизнес-требования | DDD-контексты | Основные агрегаты | Ключевые технические решения |
|-------------|----------|-----------------------------------|---------------|-------------------|------------------------------|
| UC-001 | Регистрация и создание профиля | 1, 4 | Identity & Authentication, Social & Community | User, PrivacySettings | ACID транзакции, Redis сессии |
| UC-002 | Завершение тренировки с трекингом | 2, 4, 5, 9 | Workout & Training, Health & Device Integration | TrainingSession, Metric | MongoDB гео-индексы, потоковая обработка |
| UC-003 | Покупка товара с промокодом | 4, 8, 10, 11 | Commerce & Promotions, Inventory, Pricing, Order | ShoppingSession, Product, Promotion | Идемпотентность, TTL резервирования, компенсирующие транзакции |
| UC-004 | Бронирование места на событии | 1, 3, 6 | Event Management & Booking, Commerce & Promotions | SportEvent, Booking, Waitlist | SELECT FOR UPDATE, TTL, очереди ожидания |
| UC-005 | Создание социальной группы | 1, 3 | Social & Community, Identity & Authentication | SocialGroup, GroupMembership | Eventual consistency, кэширование ленты |
| UC-006 | Участие в групповом челлендже | 1, 2, 7 | Gamification & Motivation, Social & Community | Challenge, ParticipantProgress | Redis Sorted Sets, real-time обновления |
| UC-007 | Получение рекомендаций по экипировке | 4, 8, 10, 11 | Commerce & Promotions, Analytics & Recommendations | Equipment, ProductCatalog, Recommendation | ML модели, персонализация, промоакции |
| UC-008 | Организация оффлайн-встречи | 1, 3 | Social & Community, Event Management & Booking | Event, EventParticipation | Геолокация, уведомления, расписания |
| UC-009 | Использование в оффлайн-режиме | 1, 2, 5 | Workout & Training, Data Synchronization | OfflineWorkoutSession, SyncQueue | Локальное хранение, конфликт-разрешение |
| UC-010 | Участие в глобальном соревновании | 1, 2, 7, 8 | Event Management & Booking, Gamification & Motivation | GlobalChallenge, MassRegistration | Массовая обработка, идемпотентность, auto-scaling |

---

## Взаимодействие ограниченных контекстов в сценариях

### Сквозные сценарии с участием нескольких контекстов:

1. **Тренировка → Челендж → Социальная лента (UC-002 → UC-006):**
   - Workout & Training Context публикует WorkoutCompleted
   - Gamification & Motivation Context подписывается на событие и обновляет прогресс в челлендже
   - Social & Community Context получает уведомление для отображения в ленте группы
   - **Технические решения:** Асинхронные события, eventual consistency, кэширование ленты

2. **Износ экипировки → Рекомендация → Покупка (UC-002 → UC-007 → UC-003):**
   - Workout & Training Context накапливает данные об использовании оборудования
   - Analytics & Recommendations Context анализирует износ и определяет момент для рекомендации
   - Commerce & Promotions Context формирует персонализированное предложение с промоакциями
   - Inventory Context резервирует товар с TTL
   - **Технические решения:** Идемпотентность, TTL резервирования, компенсирующие транзакции

3. **Глобальное событие → Массовая регистрация → Бронирование (UC-010 → UC-004):**
   - Event Management & Booking Context объявляет глобальное событие с квотами
   - MassRegistration обрабатывает тысячи одновременных запросов с идемпотентностью
   - Booking Context управляет местами с блокировками FOR UPDATE
   - Waitlist управляет очередями ожидания
   - **Технические решения:** Batch processing, auto-scaling, SELECT FOR UPDATE, TTL

4. **Оффлайн тренировка → Синхронизация → Аналитика (UC-009 → UC-002):**
   - Offline Operations Context сохраняет данные локально
   - Data Synchronization Context управляет очередью синхронизации
   - Workout & Training Context обрабатывает синхронизированные данные
   - Analytics & Recommendations Context обновляет модели на основе новых данных
   - **Технические решения:** Конфликт-разрешение, компрессия данных, приоритетная синхронизация

### Паттерны распределенных транзакций в сценариях:

#### Паттерн: Идемпотентные операции с компенсацией
- **Применение:** UC-003 (Покупка товара), UC-004 (Бронирование), UC-010 (Массовая регистрация)
- **Реализация:**
  1. Клиент предоставляет Idempotency-Key в заголовке запроса
  2. Система проверяет, не обработан ли уже запрос с таким ключом
  3. Если обработан - возвращает существующий результат
  4. Если нет - обрабатывает запрос и сохраняет результат с ключом
  5. При ошибках выполняет компенсирующие действия

#### Паттерн: TTL-резервирования с автоматическим освобождением
- **Применение:** UC-003 (Резервирование товара), UC-004 (Временное бронирование)
- **Реализация:**
  1. Система создает резервирование с полем expires_at
  2. Фоновый процесс периодически очищает просроченные резервирования
  3. При освобождении система уведомляет ожидающих пользователей
  4. Redis TTL используется для автоматического удаления

#### Паттерн: Массовая обработка с батчингом
- **Применение:** UC-010 (Глобальная регистрация)
- **Реализация:**
  1. Запросы накапливаются в очереди
  2. Обработчик берет батчи по N запросов
  3. Каждый батч обрабатывается в транзакции
  4. Результаты возвращаются асинхронно
  5. При ошибке выполняется компенсация для всего батча

## Примечания по реализации с учетом DDD и технических решений

### Архитектурные решения:

1. **Стратегия управления транзакциями:**
   - **Строгая согласованность:** Для финансовых операций (UC-003), бронирования (UC-004), регистрации (UC-010)
   - **Eventual consistency:** Для социальных функций (UC-005, UC-008), рекомендаций (UC-007)
   - **Компенсирующие транзакции:** Для отката распределенных операций при сбоях

2. **Идемпотентность критических операций:**
   - Все модифицирующие операции принимают Idempotency-Key
   - Результаты операций кэшируются по ключу на определенное время
   - Повторные запросы с тем же ключом возвращают кэшированный результат

3. **TTL-механизмы для временных данных:**
   - Резервирование товаров: 30 минут
   - Временное бронирование мест: 15 минут
   - Ценовые сессии: 15 минут
   - Сессии корзины: 24 часа

4. **Масштабируемость для массовых операций:**
   - Горизонтальное масштабирование сервисов обработки
   - Балансировка нагрузки между регионами
   - Auto-scaling на основе метрик нагрузки
   - Батчевая обработка для снижения нагрузки на БД

### Особые требования для критических сценариев:

1. **Массовые регистрации (UC-010):**
   - Rate limiting для предотвращения DDoS
   - Очереди сообщений для буферизации запросов
   - Асинхронная обработка с уведомлениями о результате
   - Резервные копии данных в реальном времени

2. **Оффлайн работа (UC-009):**
   - Локальное шифрование данных на устройстве
   - Конфликт-разрешение при синхронизации
   - Приоритизация данных для синхронизации при слабом сигнале
   - Компрессия данных для экономии трафика

3. **Распределенные транзакции (UC-003, UC-004):**
   - Паттерн "Two-phase commit" для критических операций
   - Компенсирующие транзакции для отката
   - Мониторинг и алертинг для длительных транзакций
   - Ручное вмешательство для застрявших транзакций

### Мониторинг и observability:

1. **Метрики для критических сценариев:**
   - Время обработки транзакций (UC-003, UC-004)
   - Успешность синхронизации (UC-009)
   - Загрузка системы при массовых операциях (UC-010)
   - Конверсия рекомендаций в покупки (UC-007)

2. **Логирование для отладки:**
   - Детальные логи распределенных транзакций
   - Логи конфликт-разрешения при синхронизации
   - Аудиторские логи для финансовых операций
   - Логи обработки Idempotency-Key

3. **Трассировка распределенных операций:**
   - End-to-end трассировка через все сервисы
   - Корреляция ID для связанных операций
   - Визуализация временных диаграмм для сложных сценариев

## Заключение

Сценарии использования, представленные в этом документе, охватывают ключевые функциональности фитнес-социального приложения с интеграцией технических решений из курсовой работы. DDD-подход позволяет четко разделить ответственность между различными доменными контекстами, обеспечивая масштабируемость и гибкость архитектуры.

Интеграция паттернов идемпотентности, TTL-резервирований, компенсирующих транзакций и массовой обработки обеспечивает надежность системы в критических сценариях. Матрица трассируемости демонстрирует связь между функциональностью, бизнес-требованиями и архитектурными компонентами, что важно для управления разработкой и тестированием системы.

Каждый сценарий спроектирован с учетом инвариантов, бизнес-правил и доменных событий, что обеспечивает целостность данных и соответствие бизнес-требованиям. Технические решения, такие как SELECT FOR UPDATE для управления местами, Redis TTL для автоматического освобождения ресурсов и Idempotency-Key для предотвращения дублей, обеспечивают надежность системы в производственных условиях.


