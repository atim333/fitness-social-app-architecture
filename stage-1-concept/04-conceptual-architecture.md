# 4. Концептуальная архитектура

## Обзор

Концептуальная архитектура представляет высокоуровневое видение системы, выделяя ключевые компоненты и их взаимодействие без технических деталей. Система спроектирована с применением принципов Domain-Driven Design (DDD) для точного отражения бизнес-процессов.

## Архитектурные принципы

### 1. Event-Driven Microservices

**Обоснование выбора:**

- **Гибкость:** Независимое развертывание и масштабирование компонентов
- **Устойчивость:** Отказ одного сервиса не приводит к падению всей системы
- **Соответствие требованиям:** Социальные функции требуют асинхронной обработки событий
- **Масштабируемость:** Возможность горизонтального масштабирования по регионам

### 2. Domain-Driven Design (DDD) Approach

**Обоснование:**

- **Бизнес-ориентированность:** Архитектура отражает реальные бизнес-процессы
- **Язык Ubiquitous:** Единый язык между разработчиками и бизнесом
- **Четкие границы:** Ограниченные контексты предотвращают сцепление
- **Сфокусированная сложность:** Core Domain получает максимальное внимание

## Доменная модель системы (DDD Perspective)

### Ограниченные контексты (Bounded Contexts):

#### 1. **User & Social Context** (Core Domain - Смысловое ядро)

- **Ответственность:** Управление пользовательскими профилями, социальными связями и сообществами
- **Почему Core Domain:** Социальная вовлеченность и формирование комьюнити - основная бизнес-ценность приложения
- **Ключевые агрегаты:**
  - `User` (агрегат-корень) с `SocialConnections`, `GroupMemberships`
  - `SocialGroup` (агрегат-корень) с `Members`, `Posts`, `Discussions`
- **Бизнес-правила:**
  - Максимальное количество друзей: 5000 (инвариант агрегата User)
  - Правила приватности для медицинских данных
  - Валидация минимального возраста (13+)

#### 2. **Activity & Training Context**

- **Ответственность:** Тренировочные сессии, упражнения, метрики и прогресс
- **Тип связи с Core:** Partnership (Партнерство) - тесная интеграция с Social Context
- **Ключевые агрегаты:**
  - `TrainingSession` (агрегат-корень) с `Exercises`, `Metrics`, `DeviceReadings`
  - `TrainingPlan` (агрегат-корень) с `Workouts`, `Schedule`
- **Бизнес-валидация:**
  - Физиологические пределы (ЧСС: 40-220 BPM)
  - Валидация GPS координат
  - Проверка калорийности на соответствие формулам

#### 3. **Health & Device Context**

- **Ответственность:** Интеграция медицинских устройств, сбор и валидация данных о здоровье
- **Тип связи:** Conformist (Конформист) - соответствие медицинским стандартам
- **Ключевые агрегаты:**
  - `Device` (агрегат-корень) с `Calibrations`, `Readings`
  - `HealthMetric` (агрегат-корень) с `Measurements`, `Alerts`
- **Бизнес-правила:**
  - Соответствие стандартам (ISO, медицинские сертификаты)
  - Валидация данных по возрастным нормам
  - Аномальное обнаружение данных

#### 4. **Commerce & Recommendations Context**

- **Ответственность:** Продажи товаров, персонализированные рекомендации, промоакции
- **Тип связи:** Customer-Supplier (Заказчик-Поставщик) для Recommendations
- **Ключевые агрегаты:**
  - `Product` (агрегат-корень) с `Inventory`, `Specifications`
  - `Recommendation` (агрегат-корень) с `Rules`, `Scores`

## Высокоуровневые компоненты системы

### 1. Сервис пользователей и социального графа (User & Social Service)

- **Назначение:** Управление профилями, аутентификация, социальные связи
- **Соответствующий DDD контекст:** User & Social Context
- **Ключевые функции:**
  - Регистрация и вход (OAuth 2.0, JWT)
  - Управление социальным графом (друзья, подписки, блокировки)
  - Группы и сообщества с модерации
  - Поиск по интересам и местоположению
  - **DDD Агрегаты:** User, SocialGroup, Friendship

### 2. Сервис тренировок и активности (Workout Service)

- **Назначение:** Сбор, хранение и анализ данных о тренировках
- **Соответствующий DDD контекст:** Activity & Training Context
- **Ключевые функции:**
  - Трекинг активности (бег, йога, велосипед и т.д.)
  - Интеграция с устройствами (фитнес-браслеты, датчики)
  - История и прогресс с бизнес-валидацией
  - Сравнение с прошлыми результатами
  - **DDD Агрегаты:** TrainingSession, Exercise, ProgressTracker

### 3. Сервис интеграции устройств (Device Integration Service)

- **Назначение:** Подключение и управление сторонними устройствами
- **Соответствующий DDD контекст:** Health & Device Context
- **Ключевые функции:**
  - Поддержка протоколов Bluetooth, ANT+
  - Калибровка и валидация данных
  - Обработка медицинских метрик (пульс, кислород, давление)
  - Оповещения о критических значениях
  - **DDD Агрегаты:** Device, HealthMetric, Alert

### 4. Движок геймификации (Gamification Engine)

- **Назначение:** Система мотивации через игровые механики
- **Ключевые функции:**
  - Баллы и уровни с динамическими правилами
  - Достижения и бейджи с условиями разблокировки
  - Рейтинговые таблицы (лидерборды)
  - Награды и призы (виртуальные и физические)
  - **DDD Агрегаты:** Achievement, Leaderboard, Reward

### 5. Сервис рекомендаций (Recommendation Service)

- **Назначение:** Персонализированные рекомендации на основе ML
- **Соответствующий DDD контекст:** Commerce & Recommendations Context
- **Ключевые функции:**
  - Рекомендации тренировок на основе истории
  - Предложения по обновлению инвентаря (обувь, снаряжение)
  - Рекомендации пользователей и групп
  - Персонализированные промоакции
  - **DDD Агрегаты:** Recommendation, UserProfile, Preference

### 6. Сервис уведомлений (Notification Service)

- **Назначение:** Управление всеми видами уведомлений
- **Ключевые функции:**
  - Push-уведомления (iOS, Android)
  - Email-рассылки с персонализацией
  - In-app уведомления
  - Уведомления о достижениях друзей (социальные триггеры)
  - **DDD Агрегаты:** Notification, Subscription, DeliveryLog

### 7. Аналитический движок (Analytics Engine)

- **Назначение:** Обработка и анализ больших данных
- **Ключевые функции:**
  - Агрегация метрик пользователей в реальном времени
  - Анализ поведения и паттернов
  - Генерация отчетов для бизнеса
  - Прогнозирование тенденций и трендов
  - **DDD Агрегаты:** Report, MetricAggregate, Trend

## Карта контекстов и их взаимодействий

### Типы связей между контекстами:

1. **Партнерство (Partnership):**
   - Между User & Social Context и Activity & Training Context
   - Тесная координация для социальных тренировок

2. **Заказчик-Поставщик (Customer-Supplier):**
   - Activity → Health (запрос данных устройств)
   - User → Commerce (предоставление профилей для рекомендаций)

3. **Конформист (Conformist):**
   - Health & Devices Context → Медицинские стандарты (соответствие)
   - Commerce Context → E-commerce система компании (интеграция)

### Событийная шина и доменные события

#### Event Bus (Apache Kafka):
- **Назначение:** Асинхронная коммуникация между ограниченными контекстами
- **Топики по доменам:**
  - `user-domain-events` - события User & Social Context
  - `activity-domain-events` - события Activity & Training Context
  - `health-domain-events` - события Health & Device Context
  - `commerce-domain-events` - события Commerce & Recommendations Context

#### Ключевые доменные события:

**User & Social Context:**
- `UserRegistered` → триггер для welcome-серии
- `FriendshipEstablished` → обновление социального графа
- `GroupCreated` → инициализация модерации

**Activity & Training Context:**
- `WorkoutStarted` → начало отслеживания сессии
- `WorkoutCompleted` → расчет статистики, проверка рекордов
- `ExercisePerformed` → обновление прогресса

**Health & Device Context:**
- `HealthMetricRecorded` → валидация и анализ
- `DeviceConnected` → калибровка и синхронизация
- `AlertTriggered` → уведомление пользователя

**Commerce & Recommendations Context:**
- `ProductViewed` → обновление рекомендаций
- `PurchaseCompleted` → обновление инвентаря
- `PromotionActivated` → применение правил

## Интеграции с внешними системами

### Внутренние интеграции (компания):

- **E-commerce система:** API для доступа к товарам и промоакциям
- **Существующие приложения:** Единая система аутентификации (SSO)
- **Система инвентаризации:** Отслеживание наличия товаров

### Внешние интеграции:

- **Фитнес-устройства:** Apple HealthKit, Google Fit, Fitbit API, Garmin
- **Платежные системы:** Stripe, PayPal, Apple Pay, Google Pay
- **Социальные сети:** Facebook, Instagram, Twitter (шаринг достижений)
- **Картографические сервисы:** Google Maps, Mapbox для маршрутов
- **Медицинские стандарты:** HL7 FHIR для обмена медицинскими данными

## Бизнес-правила и валидация

### 1. Правила социального взаимодействия:

- Ограничение запросов в друзья: 50 в день
- Минимальный возраст для групп: 16 лет
- Правила модерации контента

### 2. Валидация тренировочных данных:

- **Валидация частоты сердечных сокращений (ЧСС):**
  - Минимальное допустимое значение: 40 ударов в минуту (ниже - физиологически критическое состояние)
  - Максимальное допустимое значение рассчитывается по формуле: 220 минус возраст пользователя
  - Автоматическое определение аномальных значений с генерацией предупреждений
  - Проверка скорости изменения ЧСС (не более 50 ударов в минуту за секунду)

- **Валидация геопространственных данных:**
  - Проверка корректности GPS-координат (широта: -90° до +90°, долгота: -180° до +180°)
  - Валидация высоты над уровнем моря (от -100 до 9000 метров)
  - Проверка скорости перемещения (максимум 45 км/ч для бега, 70 км/ч для велоспорта)
  - Обнаружение и коррекция "выбросов" в трекинге маршрутов

- **Валидация метаболических показателей:**
  - Расчет и проверка сожженных калорий по формуле MET (Metabolic Equivalent of Task)
  - Проверка соответствия расхода энергии типу и интенсивности тренировки
  - Валидация данных VO₂ Max (максимального потребления кислорода)
  - Контроль показателей восстановления (HRV - Heart Rate Variability)

- **Валидация временных параметров:**
  - Минимальная продолжительность тренировки: 1 минута
  - Максимальная непрерывная тренировка: 24 часа
  - Проверка корректности временных меток (хронологический порядок)
  - Обнаружение временных аномалий и дубликатов записей

### 3. Правила рекомендаций:

- **Минимальная история тренировок:** 5 сессий для персонализации
- **Вес рекомендации:** 70% на основе истории, 30% на основе социального графа
- **Обновление модели:** ежедневное ретренирование

## Глобальная инфраструктура

### Мультиоблачная стратегия:

- **AWS (60%):** Основные регионы (США, Европа), User & Social Context
- **Google Cloud (25%):** Азиатско-Тихоокеанский регион, Analytics Engine
- **Azure (15%):** Корпоративные интеграции, Commerce Context

### Геораспределение данных:

- **Региональные шарды:** Данные пользователей хранятся в их регионе (GDPR compliance)
- **Глобальная репликация:** Конфигурационные данные и каталоги товаров
- **CDN:** Статический контент (изображения, видео тренировок)

### Кластеризация по доменам:

#### Регион: EU-West
- User-Social-Cluster
- Activity-Training-Cluster
- Health-Devices-Cluster
- Commerce-Cluster

#### Регион: US-East
- User-Social-Cluster
- Activity-Training-Cluster
- Analytics-Cluster

## Преимущества DDD-подхода в данной архитектуре

1. **Четкое разделение ответственности:** Каждый контекст отвечает за свой домен
2. **Масштабируемость команд:** Разные команды могут работать над разными контекстами
3. **Эволюция архитектуры:** Контексты могут эволюционировать независимо
4. **Бизнес-фокус:** Архитектура отражает реальные бизнес-процессы
5. **Снижение сложности:** Сложность инкапсулирована внутри контекстов

## Миграционная стратегия (от монолита к DDD-микросервисам)

1. **Фаза 1:** Выделение ограниченных контекстов в монолите
2. **Фаза 2:** Создание четких границ между модулями
3. **Фаза 3:** Экстракция контекстов в отдельные микросервисы
4. **Фаза 4:** Внедрение event-driven коммуникации между сервисами



================
