# 9. Нефункциональные требования

## Обзор
Нефункциональные требования (НФТ) определяют критерии, по которым оценивается работа системы, а не её конкретное поведение. Они основаны на атрибутах качества и бизнес-требованиях.

## 1. Требования к производительности

### 1.1 Время отклика системы
- **P1.1:** 95% запросов к REST API должны обрабатываться менее чем за **200 мс**.
- **P1.2:** 99% запросов к REST API должны обрабатываться менее чем за **500 мс**.
- **P1.3:** Обновления в реальном времени (лента активности, чат) должны доставляться с задержкой менее **1 секунды**.
- **P1.4:** Загрузка приложения (от запуска до готовности) должна занимать менее **3 секунд** на мобильных устройствах.

### 1.2 Пропускная способность
- **P2.1:** Система должна обрабатывать **10 000 одновременных пользователей** в одном регионе.
- **P2.2:** API Gateway должен выдерживать **50 000 запросов в секунду** (RPS) на регион.
- **P2.3:** Система должна обрабатывать **1 000 000 событий в час** через Event Bus.
- **P2.4:** Массовая обработка запросов (глобальные события) - **10 000+ одновременных регистраций** должны быть обработаны в течение **5 минут**.

### 1.3 Масштабируемость
- **P3.1:** Система должна масштабироваться с **10 000 до 10 000 000 пользователей** без изменения архитектуры.
- **P3.2:** Добавление нового региона должно занимать не более **24 часов**.
- **P3.3:** Автоматическое горизонтальное масштабирование должно срабатывать при загрузке CPU **более 70%** и уменьшать при загрузке **менее 30%**.

## 2. Требования к надежности

### 2.1 Доступность
- **R1.1:** Общая доступность системы должна составлять **99.9%** (до 8.76 часов простоя в год).
- **R1.2:** Критические сервисы (аутентификация, оплата) должны иметь доступность **99.95%** (до 4.38 часов простоя в год).
- **R1.3:** Время восстановления после сбоя (MTTR) не должно превышать **30 минут** для критических сервисов.
- **R1.4:** Время между отказами (MTBF) для каждого сервиса должно быть не менее **720 часов**.

### 2.2 Отказоустойчивость
- **R2.1:** Отказ одного инстанса сервиса не должен влиять на работу системы.
- **R2.2:** Потеря связи с внешним сервисом (например, платежная система) не должна блокировать основные функции приложения.
- **R2.3:** Данные должны быть реплицированы как минимум в **2 разных Availability Zones** в каждом регионе.
- **R2.4:** Резервное копирование данных должно выполняться ежедневно с хранением копий за последние **30 дней**.

### 2.3 Гарантии идемпотентности и согласованности
- **R3.1:** Все критические операции (покупки, бронирования, регистрации) должны быть **идемпотентными** - повторный запрос с тем же Idempotency-Key не должен приводить к дублированию операции.
- **R3.2:** Автоматическое освобождение временных резервирований должно происходить по истечении TTL: корзины - **24 часа**, бронирования товаров - **30 минут**, бронирования мест - **15 минут**.
- **R3.3:** Компенсирующие транзакции должны обеспечивать откат распределенных операций при сбоях с успешностью **99.9%**.
- **R3.4:** Двойное бронирование ограниченных ресурсов (мест, товаров) должно быть полностью исключено с помощью пессимистических блокировок.

### 2.4 Обработка ошибок в интеграциях

**R4.1:** Для синхронных HTTP-вызовов к внешним сервисам должен использоваться паттерн Circuit Breaker с настройками:
  - Переход в состояние OPEN после **5 ошибок за 60 секунд**
  - Переход в HALF-OPEN состояние через **30 секунд**
  - Тестовые запросы в HALF-OPEN состоянии для проверки восстановления

**R4.2:** Для временных ошибок (5xx, таймауты) в синхронных вызовах должно выполняться до **2 повторных попыток** с экспоненциальной задержкой (1s, 3s).

**R4.3:** Для асинхронных операций через очереди должно выполняться повторение обработки сообщений до **3 раз** с увеличивающимися интервалами (30s, 2m, 5m).

**R4.4:** Сообщения, которые не удалось обработать после 3 попыток, должны помещаться в **Dead Letter Queue** для последующего анализа и ручной обработки.

**R4.5:** Система должна предоставлять механизмы **graceful degradation** при недоступности внешних сервисов, например, использование кешированных данных для критического функционала.

## 3. Требования к безопасности

### 3.1 Аутентификация и авторизация
- **S1.1:** Все API запросы должны аутентифицироваться с использованием **JWT токенов**.
- **S1.2:** Пароли пользователей должны храниться в хешированном виде с использованием **аргона2 или bcrypt**.
- **S1.3:** Сессии должны истекать после **7 дней** неактивности.
- **S1.4:** Поддержка многофакторной аутентификации для доступа к чувствительным данным.

### 3.2 Защита данных
- **S2.1:** Все данные должны шифроваться при передаче с использованием **TLS 1.3**.
- **S2.2:** Чувствительные данные (пароли, платежная информация, данные о здоровье) должны шифроваться и в состоянии покоя.
- **S2.3:** Доступ к данным должен контролироваться на основе **ролевой модели (RBAC)** с минимальными привилегиями.
- **S2.4:** Логи должны содержать информацию о доступе к персональным данным для аудита.

### 3.3 Защита транзакций
- **S3.1:** Все критические транзакции должны защищаться от повторного выполнения через **Idempotency-Key**.
- **S3.2:** Idempotency-Key должны быть уникальными для каждой операции и иметь TTL **24 часа**.
- **S3.3:** Результаты идемпотентных операций должны кэшироваться для предотвращения повторной обработки.

### 3.4 Соответствие стандартам
- **S4.1:** Система должна соответствовать требованиям **GDPR** для пользователей из ЕС.
- **S4.2:** Для данных о здоровье должна обеспечиваться конфиденциальность в соответствии с **HIPAA** (для США).
- **S4.3:** Платежные операции должны соответствовать **PCI DSS**.
- **S4.4:** Регулярное проведение пентестов не реже **1 раза в год**.

## 4. Требования к удобству использования

### 4.1 Пользовательский интерфейс
- **U1.1:** Приложение должно иметь рейтинг **не менее 4.5 звёзд** в App Store и Google Play.
- **U1.2:** Частота падений (crash rate) приложения должна быть **менее 0.1%** сессий.
- **U1.3:** Поддержка **15 языков** на момент глобального запуска.
- **U1.4:** Приложение должно быть доступно для людей с ограниченными возможностями (соответствие **WCAG 2.1 AA**).

### 4.2 Обучаемость
- **U2.1:** Новый пользователь должен быть способен завершить первую тренировку в течение **5 минут** после регистрации.
- **U2.2:** 90% пользователей должны понимать основные функции приложения без дополнительных инструкций.

## 5. Требования к совместимости

### 5.1 Платформы и устройства
- **C1.1:** Поддержка **iOS 14+** и **Android 10+**.
- **C1.2:** Поддержка основных фитнес-устройств: **Apple Watch, Fitbit, Garmin, Samsung Galaxy Watch**.
- **C1.3:** Интеграция с **Apple HealthKit** и **Google Fit**.
- **C1.4:** Поддержка различных размеров экранов и ориентаций.

### 5.2 Внешние системы
- **C2.1:** Интеграция с минимум **3 платежными системами** (Stripe, PayPal, Apple Pay/Google Pay).
- **C2.2:** Интеграция с системой управления промокодами компании.
- **C2.3:** API для интеграции с корпоративными системами (для B2B-сегмента).

## 6. Требования к сопровождаемости

### 6.1 Модульность и тестируемость
- **M1.1:** Каждый микросервис должен иметь **покрытие unit-тестами не менее 80%**.
- **M1.2:** Покрытие интеграционными тестами ключевых сценариев — **100%**.
- **M1.3:** Время сборки и развертывания одного сервиса не должно превышать **10 минут**.
- **M1.4:** Использование контейнеризации (Docker) для всех компонентов.

### 6.2 Мониторинг и логирование
- **M2.1:** Сбор метрик со всех сервисов в единой системе мониторинга (Prometheus).
- **M2.2:** Централизованное логирование (ELK stack) с хранением логов не менее **90 дней**.
- **M2.3:** Наличие дашбордов для отслеживания ключевых бизнес-метрик и метрик системы.
- **M2.4:** Автоматическое алертирование при превышении пороговых значений.
- **M2.5:** Мониторинг состояния Circuit Breaker для всех критических сервисов с алертированием при переходе в OPEN состояние.
- **M2.6:** Отслеживание количества сообщений в Dead Letter Queue с алертированием при превышении порога в **10 сообщений**.

### 6.3 Управление конфигурациями и feature flags

**M3.1:** Изменение feature flags и конфигураций должно выполняться без перезапуска сервисов.
**M3.2:** Время распространения изменений конфигураций между всеми инстансами сервисов не должно превышать **5 минут**.
**M3.3:** Система должна поддерживать одновременное проведение **100+ A/B тестов** для промоакций и челленджей.
**M3.4:** История изменений конфигураций должна храниться не менее **90 дней** для аудита и возможности отката.
**M3.5:** Интерфейс управления feature flags должен быть доступен маркетологам (нетехническим специалистам) через веб-интерфейс.
**M3.6:** Система должна обеспечивать консистентность конфигураций во всех инстансах сервисов (отсутствие конфигурационного дрифта).

## 7. Требования к развертыванию

### 7.1 Инфраструктура
- **D1.1:** Использование инфраструктуры как кода (Terraform) для управления облачными ресурсами.
- **D1.2:** Возможность развертывания системы в нескольких облачных провайдерах (AWS, GCP, Azure).
- **D1.3:** Поддержка blue-green деплоев и canary релизов.
- **D1.4:** Время развертывания нового региона не должно превышать **2 часов**.

### 7.2 Резервное копирование и восстановление
- **D2.1:** Полное восстановление системы из бэкапа должно занимать не более **4 часов**.
- **D2.2:** Точка восстановления (RPO) для пользовательских данных — **15 минут**.
- **D2.3:** Время восстановления (RTO) для критических сервисов — **30 минут**.

## 8. Требования к транзакционной обработке

### 8.1 Идемпотентность
- **T1.1:** Все операции, изменяющие состояние (покупки, бронирования, регистрации), должны быть идемпотентными.
- **T1.2:** Idempotency-Key должны генерироваться клиентом и иметь длину **не менее 32 символов**.
- **T1.3:** Результаты идемпотентных операций должны храниться **24 часа** для возможности повторного получения результата.

### 8.2 TTL-резервирования
- **T2.1:** Временные резервирования должны автоматически освобождаться по истечении TTL без ручного вмешательства.
- **T2.2:** Система должна отслеживать и освобождать просроченные резервирования с задержкой не более **1 секунды**.
- **T2.3:** Пользователи должны получать уведомления за **5 минут** до истечения TTL временных резервирований.

### 8.3 Компенсирующие транзакции
- **T3.1:** Для всех распределенных транзакций должны быть определены компенсирующие действия.
- **T3.2:** Компенсирующие транзакции должны выполняться автоматически при обнаружении неустранимых ошибок.
- **T3.3:** Логи компенсирующих транзакций должны храниться не менее **30 дней** для аудита.

### 8.4 Массовая обработка
- **T4.1:** Система должна поддерживать обработку **10 000+ запросов** в батчевом режиме.
- **T4.2:** Задержка массовой обработки не должна превышать **5 минут** для 10 000 запросов.
- **T4.3:** Статус каждого запроса в массовой обработке должен быть отслеживаемым.

### 8.5 Блокировки ресурсов
- **T5.1:** Пессимистические блокировки должны применяться только для операций с ограниченными ресурсами.
- **T5.2:** Максимальное время удержания блокировки не должно превышать **30 секунд**.
- **T5.3:** Система должна автоматически обнаруживать и разрешать взаимные блокировки (deadlocks).

## 9. Требования к экологичности

### 9.1 Энергоэффективность
- **E1.1:** Оптимизация использования ресурсов для снижения углеродного следа.
- **E1.2:** Использование энергоэффективных регионов облачных провайдеров, где это возможно.

## Приоритеты требований

| Категория | Приоритет | Обоснование |
|-----------|-----------|-------------|
| Безопасность | Высший | Защита персональных данных и данных о здоровье критична для репутации компании и соответствия регуляторным требованиям. |
| Надежность | Высокий | Пользователи ожидают стабильной работы приложения, особенно во время тренировок. |
| Транзакционная обработка | Высокий | Гарантии идемпотентности и согласованности критичны для финансовых операций и бронирований. |
| Производительность | Высокий | Низкая задержка важна для социальных функций и работы в реальном времени. |
| Масштабируемость | Средний | Требуется для поддержки роста пользовательской базы. |
| Сопровождаемость | Средний | Важно для эффективной разработки и эксплуатации. |
| Удобство использования | Средний | Влияет на удовлетворенность пользователей и рейтинги в магазинах приложений. |
| Совместимость | Низкий | Необходима для охвата широкой аудитории, но может быть реализована постепенно. |
| Экологичность | Низкий | Важно с точки зрения корпоративной социальной ответственности. |

## Методы верификации

1. **Нагрузочное тестирование:** Для проверки требований к производительности и масштабируемости.
2. **Тестирование безопасности:** Пентесты, статический анализ кода, проверки зависимостей.
3. **Тестирование идемпотентности:** Повторные отправки запросов с одинаковыми Idempotency-Key для проверки отсутствия дублирования.
4. **Тестирование TTL-механизмов:** Проверка автоматического освобождения ресурсов по истечении времени.
5. **Тестирование компенсирующих транзакций:** Имитация сбоев на разных этапах распределенных операций.
6. **Тестирование массовой обработки:** Нагрузочное тестирование с 10 000+ одновременных запросов.
7. **Мониторинг в production:** Постоянный сбор метрик для проверки соответствия требованиям к надежности и производительности.
8. **Юзабилити-тестирование:** Для проверки требований к удобству использования.
9. **Аудит кода и архитектуры:** Регулярные проверки на соответствие стандартам и best practices.

## Связь с архитектурными решениями (ADR)

| Номер НФТ | Связанные ADR | Описание |
|-----------|---------------|----------|
| T1.1, T1.2, T1.3 | ADR-015 | Требования идемпотентности реализуются через Idempotency-Key |
| T2.1, T2.2, T2.3 | ADR-016 | TTL-резервирования для автоматического освобождения ресурсов |
| T3.1, T3.2, T3.3 | ADR-017 | Компенсирующие транзакции для отката распределенных операций |
| T4.1, T4.2, T4.3 | ADR-019 | Массовая обработка через батчинг для глобальных событий |
| T5.1, T5.2, T5.3 | ADR-018 | Пессимистические блокировки для управления ограниченными ресурсами |
| P2.4 | ADR-019 | Обработка 10 000+ одновременных регистраций |
| R3.1, R3.2, R3.3, R3.4 | ADR-015, ADR-016, ADR-017, ADR-018 | Гарантии идемпотентности и согласованности |
| S3.1, S3.2, S3.3 | ADR-015 | Защита транзакций через идемпотентность |
| R4.1, R4.2 | ADR-008, ADR-009 | Circuit Breaker и Retry Pattern для синхронных вызовов |
| R4.3, R4.4 | ADR-020 | Retry и Dead Letter Queue для асинхронных операций |
| R4.5 | ADR-008, ADR-009 | Fallback механизмы при недоступности внешних сервисов |
| M2.5 | ADR-008 | Мониторинг состояния Circuit Breaker |
| M2.6 | ADR-020 | Мониторинг Dead Letter Queue |
| M3.1, M3.2, M3.3, M3.4, M3.5, M3.6 | ADR-021 | Управление конфигурациями и feature flags для A/B тестирования |

Эти нефункциональные требования будут использоваться для принятия архитектурных решений и оценки качества системы на всех этапах разработки и эксплуатации.

