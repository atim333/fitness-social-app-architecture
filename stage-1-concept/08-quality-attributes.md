# 8. Атрибуты качества (Quality Attributes)

## Обзор
Атрибуты качества определяют, насколько хорошо система выполняет свои функции с точки зрения различных нефункциональных характеристик. В соответствии с требованиями задания, выделяем **три основных атрибута качества**, которые будут влиять на архитектурные решения.

## Основные атрибуты качества (3)

### 1. Масштабируемость (Scalability)

#### Определение:
Способность системы справляться с увеличением нагрузки (количества пользователей, данных, транзакций) без снижения производительности и с минимальным увеличением затрат.

#### Критические аспекты:
- **Горизонтальное масштабирование:** Возможность добавлять новые инстансы сервисов для обработки возрастающей нагрузки.
- **Геораспределение:** Поддержка пользователей по всему миру с низкой задержкой.
- **Масштабирование данных:** Эффективное хранение и обработка растущих объемов данных (тренировки, социальные взаимодействия).
- **Массовая обработка:** Обработка тысяч одновременных запросов при глобальных событиях.

#### Сценарии:
- **SC-1:** Во время запуска глобального челленджа количество одновременных пользователей увеличивается в 10 раз за 1 час.
- **SC-2:** Количество пользователей растет с 100 тыс. до 10 млн за 2 года.
- **SC-3:** Объем данных тренировок растет на 1 ТБ в месяц.
- **SC-4:** 10,000+ одновременных регистраций на глобальное событие с обработкой в течение 5 минут.

#### Архитектурные тактики:
- Использование микросервисной архитектуры для независимого масштабирования компонентов.
- Шардирование баз данных по регионам и типам данных.
- Кэширование часто запрашиваемых данных (Redis, Memcached).
- Автоматическое масштабирование в облачной инфраструктуре (Kubernetes HPA, AWS Auto Scaling).
- **Батчевая обработка массовых операций** через Apache Kafka (ADR-019).
- **Идемпотентность операций** для безопасного масштабирования (ADR-015).

### 2. Надежность (Reliability)

#### Определение:
Способность системы выполнять требуемые функции при заданных условиях в течение определенного времени, включая отказоустойчивость и доступность.

#### Критические аспекты:
- **Доступность (Availability):** Система должна быть доступна 99.9% времени (до 8.76 часов простоя в год).
- **Отказоустойчивость (Fault Tolerance):** Система должна продолжать работать при отказах отдельных компонентов.
- **Восстановляемость (Recoverability):** Возможность быстрого восстановления после сбоев.
- **Идемпотентность:** Гарантия однократного выполнения критических операций при повторах.
- **Компенсация сбоев:** Возможность отката распределенных операций при частичных отказах.

#### Сценарии:
- **REL-1:** Сбой в одном из региональных дата-центров не должен влиять на пользователей в других регионах.
- **REL-2:** Потеря связи с внешним сервисом (например, фитнес-устройством) не должна приводить к потере данных тренировки.
- **REL-3:** Ошибка в одном микросервисе не должна вызывать каскадный отказ всей системы.
- **REL-4:** Повторная отправка платежного запроса не должна приводить к двойному списанию (идемпотентность).
- **REL-5:** Сбой при бронировании места должен автоматически освобождать ресурсы (TTL-резервирования).

#### Архитектурные тактики:
- Репликация данных в нескольких Availability Zones.
- Использование паттернов Circuit Breaker, Retry, Fallback для взаимодействия с внешними сервисами.
- Регулярные бэкапы и возможность быстрого восстановления данных.
- Мониторинг и алертинг для раннего обнаружения проблем.
- **Идемпотентные операции через Idempotency-Key** (ADR-015).
- **TTL-резервирования для автоматического освобождения ресурсов** (ADR-016).
- **Компенсирующие транзакции (Saga pattern)** для отката распределенных операций (ADR-017).

#### Архитектурные решения для обработки ошибок в интеграциях

**Контекст:** В микросервисной архитектуре обработка ошибок в межсервисных коммуникациях критически важна для общей надежности системы.

**Стратегии обработки для различных типов интеграций:**

**HTTP/REST (Синхронные вызовы) - Пример: Social Service → Notification Service:**
- **Circuit Breaker Pattern:** 
  - CLOSED/OPEN/HALF-OPEN состояния
  - Порог: 5 ошибок за 60 секунд
  - HALF-OPEN после 30 секунд блокировки
- **Retry Pattern:**
  - 2 попытки с exponential backoff (1s, 3s)
  - Только для временных ошибок (5xx, timeout)
- **Fallback Mechanism:**
  - Использование кешированных данных
  - Graceful degradation - базовый функционал продолжает работать

**Асинхронные вызовы (очереди) - Пример: Workout Service → Analytics Service:**
- **Retry с Exponential Backoff:**
  - 30 секунд → 2 минуты → 5 минут
- **Dead Letter Queue (DLQ):**
  - Изоляция проблемных сообщений после 3 неудачных попыток
  - Возможность ручного разбора и повторной обработки
- **Compensating Actions:**
  - Автоматическая отмена зависимых операций
  - Уведомление пользователя о проблеме

**Обоснование выбора стратегий:**
- **Circuit Breaker** предотвращает каскадные отказы и снижает нагрузку на проблемные сервисы
- **Retry с backoff** дает время на восстановление сервисов без немедленной перегрузки
- **DLQ** обеспечивает гарантию доставки и возможность обработки исключительных ситуаций
- **Compensating transactions** поддерживают согласованность данных между сервисами

### 3. Производительность (Performance)

#### Определение:
Способность системы обрабатывать запросы за приемлемое время и с использованием разумного количества ресурсов.

#### Критические аспекты:
- **Задержка (Latency):** Время отклика для ключевых операций должно быть минимальным.
- **Пропускная способность (Throughput):** Система должна обрабатывать большое количество запросов в единицу времени.
- **Эффективность использования ресурсов:** Минимизация использования CPU, памяти, сети.
- **Автоматическое освобождение ресурсов:** Предотвращение накопления "мертвых" резервирований.

#### Сценарии:
- **PERF-1:** 95% запросов к API должны обрабатываться менее чем за 200 мс.
- **PERF-2:** Лента активности должна обновляться в реальном времени с задержкой менее 1 секунды.
- **PERF-3:** Данные с фитнес-устройств должны отображаться в приложении с задержкой менее 5 секунд.
- **PERF-4:** Автоматическое освобождение зарезервированных мест через 15 минут без нагрузки на систему.

#### Архитектурные тактики:
- Использование асинхронной обработки и event-driven архитектуры для длительных операций.
- Кэширование на нескольких уровнях (CDN, Redis, браузерный кэш).
- Оптимизация запросов к базам данных (индексы, denormalization при необходимости).
- Load balancing для распределения нагрузки между инстансами.
- **TTL-механизмы в Redis** для автоматического удаления временных данных (ADR-016).
- **Пессимистические блокировки** только для критических операций, минимизация времени удержания (ADR-018).

## Дополнительные атрибуты качества для различных компонентов

### Безопасность (Security) - для компонентов обработки персональных данных
- **Аспекты:** Конфиденциальность, целостность, аутентификация, авторизация.
- **Тактики:** Шифрование данных, использование JWT, RBAC, регулярные аудиты безопасности.
- **Новые аспекты:** Защита от дублирования транзакций через Idempotency-Key.

### Удобство поддержки (Maintainability) - для всех компонентов
- **Аспекты:** Модульность, тестируемость, документированность.
- **Тактики:** Чистая архитектура, покрытие тестами, документация API, логирование.
- **Новые аспекты:** Упрощение отладки распределенных транзакций через компенсирующие действия.

### Совместимость (Compatibility) - для интеграционных компонентов
- **Аспекты:** Возможность интеграции с различными устройствами и внешними системами.
- **Тактики:** Использование стандартных протоколов (REST, GraphQL), адаптеры для различных API.
- **Новые аспекты:** Стандартизация подхода к идемпотентности для всех интеграций.

### Управляемость (Manageability) - для операционных компонентов
- **Аспекты:** Легкость мониторинга, развертывания, настройки.
- **Тактики:** Централизованное логирование, feature flags, конфигурация как код.
- **Новые аспекты:** Мониторинг TTL-сроков и автоматической очистки ресурсов.

## Приоритеты и компромиссы

### Компромисс 1: Производительность vs Согласованность данных
- **Контекст:** Социальная лента активности требует низкой задержки, но данные могут быть не совсем актуальными.
- **Решение:** Использование eventual consistency для ленты активности (кэширование, асинхронное обновление) и strong consistency для критических данных (прогресс тренировок, платежи).
- **Нюанс:** Для бронирования мест - строгая согласованность через пессимистические блокировки (ADR-018).

### Компромисс 2: Масштабируемость vs Сложность
- **Контекст:** Микросервисная архитектура улучшает масштабируемость, но увеличивает сложность разработки и эксплуатации.
- **Решение:** Начать с модульного монолита для MVP и эволюционировать в микросервисы по мере роста нагрузки и команды.
- **Нюанс:** Массовая обработка через батчинг увеличивает задержку, но улучшает масштабируемость (ADR-019).

### Компромисс 3: Безопасность vs Удобство использования
- **Контекст:** Частые запросы аутентификации повышают безопасность, но ухудшают пользовательский опыт.
- **Решение:** Использовать долгоживущие JWT токены с refresh токенами, двухфакторную аутентификацию по желанию пользователя.
- **Нюанс:** Идемпотентность улучшает безопасность (защита от дублей) без ущерба для UX (ADR-015).

### Компромисс 4: Надежность vs Производительность
- **Контекст:** Компенсирующие транзакции повышают надежность, но добавляют накладные расходы.
- **Решение:** Использовать компенсирующие транзакции только для критических операций (покупки, бронирования).
- **Нюанс:** TTL-резервирования обеспечивают надежность (автоочистка) с минимальным impact на производительность (ADR-016).

## Метрики атрибутов качества

| Атрибут | Метрика | Целевое значение | Метод измерения | Связь с ADR |
|---------|---------|------------------|-----------------|-------------|
| Масштабируемость | Время добавления нового инстанса сервиса | < 5 минут | Мониторинг инфраструктуры | ADR-006, ADR-019 |
| Масштабируемость | Макс. одновременных регистраций | 10,000+ | Load testing | ADR-019 |
| Надежность | Доступность (uptime) | 99.9% | Мониторинг (Prometheus, Grafana) | ADR-008, ADR-017 |
| Надежность | Дублирующие транзакции | 0% | Аудит логов операций | ADR-015 |
| Производительность | P95 latency API | < 200 мс | Application Performance Monitoring (APM) | ADR-016, ADR-018 |
| Производительность | Время освобождения TTL-ресурсов | < 1 секунда | Мониторинг фоновых процессов | ADR-016 |
| Безопасность | Время обнаружения инцидента | < 5 минут | SIEM система, алертинг | ADR-015 |
| Удобство поддержки | Время восстановления после сбоя (MTTR) | < 30 минут | Мониторинг и процессы инцидент-менеджмента | ADR-017 |
| Управляемость | Задержка массовой обработки | < 5 минут для 10K запросов | Мониторинг очередей Kafka | ADR-019 |
| Надежность | Circuit Breaker срабатывания | < 5 случаев/день | Мониторинг через Prometheus | ADR-008 (Circuit Breaker) |
| Надежность | Сообщения в DLQ | 0 в нормальном режиме | Мониторинг очередей (AWS SQS/RabbitMQ) | ADR-020 (Dead Letter Queue) |
| Надежность | Успешность компенсирующих транзакций | > 99.9% | Аудит логов Saga Orchestrator | ADR-017 (Compensating Transactions) |
| Производительность | P95 задержка HTTP-вызовов | < 200 мс | APM инструменты (Datadog/New Relic) | ADR-008, ADR-009 |
| Надежность | Время восстановления (MTTR) после сбоя интеграции | < 10 минут | Мониторинг и алертинг | ADR-008, ADR-017 |
| Управляемость | Время изменения feature flags | < 5 минут | Мониторинг Configuration Service | ADR-021 |

## Влияние атрибутов качества на архитектурные решения

1. **Выбор облачных провайдеров:** Использование AWS, GCP, Azure для обеспечения глобальной масштабируемости и надежности.
2. **Микросервисная архитектура:** Для независимого масштабирования и повышения отказоустойчивости.
3. **Event-driven design:** Для улучшения производительности и обработки асинхронных операций.
4. **Геораспределенные базы данных:** Для снижения задержки и повышения доступности.
5. **Service Mesh (Istio/Linkerd):** Для улучшения наблюдаемости, безопасности и управления трафиком.
6. **Идемпотентность операций:** Для гарантии надежности критических операций (ADR-015).
7. **TTL-резервирования:** Для автоматического освобождения ресурсов и предотвращения деградации производительности (ADR-016).
8. **Компенсирующие транзакции:** Для обеспечения согласованности данных в распределенной системе (ADR-017).
9. **Пессимистические блокировки:** Для строгой синхронизации доступа к ограниченным ресурсам (ADR-018).
10. **Батчевая обработка:** Для масштабирования при экстремальных нагрузках (ADR-019).



#### Обработка ошибок в интеграциях микросервисов

**Идемпотентность критических операций (ADR-015):**
- **Контекст:** Защита от двойного выполнения операций при сетевых сбоях и повторных запросах
- **Влияние на надежность:** Устраняет риск дублирующих транзакций (повторные платежи, двойное бронирование)
- **Влияние на безопасность:** Предотвращает финансовые потери и конфликты данных
- **Реализация:** Генерация уникального Idempotency-Key клиентом, валидация на стороне сервера
- **Применение:** Платежи, бронирование мест на тренировки, регистрация на события
- **Метрика:** 0% дублирующих транзакций при соблюдении клиентом протокола

**TTL-резервирования с автоматической очисткой (ADR-016):**
- **Контекст:** Временные резервирования ресурсов (мест на тренировках, инвентаря)
- **Влияние на надежность:** Гарантированное освобождение ресурсов при сбоях в процессе бронирования
- **Влияние на производительность:** Предотвращает накопление "заблокированных" ресурсов, улучшая доступность
- **Реализация:** Redis с установленным TTL для каждого резервирования
- **Процесс:** Автоматическая отмена резервирования по истечении таймаута (15 минут для тренировок)
- **Метрика:** 100% автоматическое освобождение ресурсов по истечении TTL

**Компенсирующие транзакции для распределенных процессов (ADR-017):**
- **Контекст:** Сложные бизнес-процессы, затрагивающие несколько микросервисов
- **Влияние на надежность:** Обеспечение согласованности при частичных отказах
- **Реализация:** Компенсирующие действия, активируемые по истечении TTL или при явных ошибках
- **Пример процесса:** 
  1. Бронирование места на тренировке (Training Service) → создание записи с TTL
  2. Создание записи в календаре (Calendar Service) → если неудача, отправка события отмены
  3. Получение события отмены → автоматическая отмена бронирования
- **Принцип:** Каждая операция имеет обратную операцию-компенсацию
- **Метрика:** Успешность компенсирующих действий > 99.9%

**Стратегии обработки сетевых сбоев:**
- **Синхронные вызовы (HTTP/REST):**
  - **Circuit Breaker:** Изоляция проблемных сервисов после 5 ошибок за 60 секунд
  - **Retry с экспоненциальной задержкой:** 2 попытки с backoff (1s, 3s) для временных ошибок
  - **Fallback-механизмы:** Использование кешированных данных или упрощенной логики
  
- **Асинхронные вызовы (очереди сообщений):**
  - **Dead Letter Queue:** Изоляция неудачно обработанных сообщений после 3 попыток
  - **Ручная обработка исключений:** Возможность анализа и повторной отправки сообщений из DLQ
  - **Мониторинг и алертинг:** Уведомление при накоплении сообщений в DLQ

**Пессимистические блокировки для ограниченных ресурсов (ADR-018):**
- **Контекст:** Высококонкурентный доступ к ограниченным ресурсам (групповые тренировки, соревнования)
- **Влияние на согласованность:** Гарантия уникального выделения ресурса
- **Влияние на производительность:** Минимизация времени блокировки (только на период подтверждения)
- **Реализация:** Краткосрочные блокировки на уровне базы данных или распределенного кэша
- **Метрика:** 0% случаев двойного выделения одного ресурса

**Батчевая обработка массовых операций (ADR-019):**
- **Контекст:** Пиковые нагрузки (запуск глобальных челленджей, массовые регистрации)
- **Влияние на масштабируемость:** Возможность обработки десятков тысяч одновременных запросов
- **Влияние на производительность:** Увеличение задержки для отдельных операций, но защита от перегрузки
- **Реализация:** Apache Kafka для буферизации и batch-обработки
- **Метрика:** Обработка 10K запросов на регистрацию в событие за < 5 минут


Эти атрибуты качества и связанные с ними решения  обеспечивают баланс между надежностью, производительностью и масштабируемостью в соответствии с бизнес-требованиями.


