# 8. Атрибуты качества (Quality Attributes)

## Обзор
Атрибуты качества определяют, насколько хорошо система выполняет свои функции с точки зрения различных нефункциональных характеристик. В соответствии с требованиями задания, выделяем **три основных атрибута качества**, которые будут влиять на архитектурные решения.

## Основные атрибуты качества (3)

### 1. Масштабируемость (Scalability)

#### Определение:
Способность системы справляться с увеличением нагрузки (количества пользователей, данных, транзакций) без снижения производительности и с минимальным увеличением затрат.

#### Критические аспекты:
- **Горизонтальное масштабирование:** Возможность добавлять новые инстансы сервисов для обработки возрастающей нагрузки.
- **Геораспределение:** Поддержка пользователей по всему миру с низкой задержкой.
- **Масштабирование данных:** Эффективное хранение и обработка растущих объемов данных (тренировки, социальные взаимодействия).
- **Массовая обработка:** Обработка тысяч одновременных запросов при глобальных событиях.

#### Сценарии:
- **SC-1:** Во время запуска глобального челленджа количество одновременных пользователей увеличивается в 10 раз за 1 час.
- **SC-2:** Количество пользователей растет с 100 тыс. до 10 млн за 2 года.
- **SC-3:** Объем данных тренировок растет на 1 ТБ в месяц.
- **SC-4:** 10,000+ одновременных регистраций на глобальное событие с обработкой в течение 5 минут.

#### Архитектурные тактики:
- Использование микросервисной архитектуры для независимого масштабирования компонентов.
- Шардирование баз данных по регионам и типам данных.
- Кэширование часто запрашиваемых данных (Redis, Memcached).
- Автоматическое масштабирование в облачной инфраструктуре (Kubernetes HPA, AWS Auto Scaling).
- **Батчевая обработка массовых операций** через Apache Kafka (ADR-019).
- **Идемпотентность операций** для безопасного масштабирования (ADR-015).

### 2. Надежность (Reliability)

#### Определение:
Способность системы выполнять требуемые функции при заданных условиях в течение определенного времени, включая отказоустойчивость и доступность.

#### Критические аспекты:
- **Доступность (Availability):** Система должна быть доступна 99.9% времени (до 8.76 часов простоя в год).
- **Отказоустойчивость (Fault Tolerance):** Система должна продолжать работать при отказах отдельных компонентов.
- **Восстановляемость (Recoverability):** Возможность быстрого восстановления после сбоев.
- **Идемпотентность:** Гарантия однократного выполнения критических операций при повторах.
- **Компенсация сбоев:** Возможность отката распределенных операций при частичных отказах.

#### Сценарии:
- **REL-1:** Сбой в одном из региональных дата-центров не должен влиять на пользователей в других регионах.
- **REL-2:** Потеря связи с внешним сервисом (например, фитнес-устройством) не должна приводить к потере данных тренировки.
- **REL-3:** Ошибка в одном микросервисе не должна вызывать каскадный отказ всей системы.
- **REL-4:** Повторная отправка платежного запроса не должна приводить к двойному списанию (идемпотентность).
- **REL-5:** Сбой при бронировании места должен автоматически освобождать ресурсы (TTL-резервирования).

#### Архитектурные тактики:
- Репликация данных в нескольких Availability Zones.
- Использование паттернов Circuit Breaker, Retry, Fallback для взаимодействия с внешними сервисами.
- Регулярные бэкапы и возможность быстрого восстановления данных.
- Мониторинг и алертинг для раннего обнаружения проблем.
- **Идемпотентные операции через Idempotency-Key** (ADR-015).
- **TTL-резервирования для автоматического освобождения ресурсов** (ADR-016).
- **Компенсирующие транзакции (Saga pattern)** для отката распределенных операций (ADR-017).

### 3. Производительность (Performance)

#### Определение:
Способность системы обрабатывать запросы за приемлемое время и с использованием разумного количества ресурсов.

#### Критические аспекты:
- **Задержка (Latency):** Время отклика для ключевых операций должно быть минимальным.
- **Пропускная способность (Throughput):** Система должна обрабатывать большое количество запросов в единицу времени.
- **Эффективность использования ресурсов:** Минимизация использования CPU, памяти, сети.
- **Автоматическое освобождение ресурсов:** Предотвращение накопления "мертвых" резервирований.

#### Сценарии:
- **PERF-1:** 95% запросов к API должны обрабатываться менее чем за 200 мс.
- **PERF-2:** Лента активности должна обновляться в реальном времени с задержкой менее 1 секунды.
- **PERF-3:** Данные с фитнес-устройств должны отображаться в приложении с задержкой менее 5 секунд.
- **PERF-4:** Автоматическое освобождение зарезервированных мест через 15 минут без нагрузки на систему.

#### Архитектурные тактики:
- Использование асинхронной обработки и event-driven архитектуры для длительных операций.
- Кэширование на нескольких уровнях (CDN, Redis, браузерный кэш).
- Оптимизация запросов к базам данных (индексы, denormalization при необходимости).
- Load balancing для распределения нагрузки между инстансами.
- **TTL-механизмы в Redis** для автоматического удаления временных данных (ADR-016).
- **Пессимистические блокировки** только для критических операций, минимизация времени удержания (ADR-018).

## Дополнительные атрибуты качества для различных компонентов

### Безопасность (Security) - для компонентов обработки персональных данных
- **Аспекты:** Конфиденциальность, целостность, аутентификация, авторизация.
- **Тактики:** Шифрование данных, использование JWT, RBAC, регулярные аудиты безопасности.
- **Новые аспекты:** Защита от дублирования транзакций через Idempotency-Key.

### Удобство поддержки (Maintainability) - для всех компонентов
- **Аспекты:** Модульность, тестируемость, документированность.
- **Тактики:** Чистая архитектура, покрытие тестами, документация API, логирование.
- **Новые аспекты:** Упрощение отладки распределенных транзакций через компенсирующие действия.

### Совместимость (Compatibility) - для интеграционных компонентов
- **Аспекты:** Возможность интеграции с различными устройствами и внешними системами.
- **Тактики:** Использование стандартных протоколов (REST, GraphQL), адаптеры для различных API.
- **Новые аспекты:** Стандартизация подхода к идемпотентности для всех интеграций.

### Управляемость (Manageability) - для операционных компонентов
- **Аспекты:** Легкость мониторинга, развертывания, настройки.
- **Тактики:** Централизованное логирование, feature flags, конфигурация как код.
- **Новые аспекты:** Мониторинг TTL-сроков и автоматической очистки ресурсов.

## Приоритеты и компромиссы

### Компромисс 1: Производительность vs Согласованность данных
- **Контекст:** Социальная лента активности требует низкой задержки, но данные могут быть не совсем актуальными.
- **Решение:** Использование eventual consistency для ленты активности (кэширование, асинхронное обновление) и strong consistency для критических данных (прогресс тренировок, платежи).
- **Нюанс:** Для бронирования мест - строгая согласованность через пессимистические блокировки (ADR-018).

### Компромисс 2: Масштабируемость vs Сложность
- **Контекст:** Микросервисная архитектура улучшает масштабируемость, но увеличивает сложность разработки и эксплуатации.
- **Решение:** Начать с модульного монолита для MVP и эволюционировать в микросервисы по мере роста нагрузки и команды.
- **Нюанс:** Массовая обработка через батчинг увеличивает задержку, но улучшает масштабируемость (ADR-019).

### Компромисс 3: Безопасность vs Удобство использования
- **Контекст:** Частые запросы аутентификации повышают безопасность, но ухудшают пользовательский опыт.
- **Решение:** Использовать долгоживущие JWT токены с refresh токенами, двухфакторную аутентификацию по желанию пользователя.
- **Нюанс:** Идемпотентность улучшает безопасность (защита от дублей) без ущерба для UX (ADR-015).

### Компромисс 4: Надежность vs Производительность
- **Контекст:** Компенсирующие транзакции повышают надежность, но добавляют накладные расходы.
- **Решение:** Использовать компенсирующие транзакции только для критических операций (покупки, бронирования).
- **Нюанс:** TTL-резервирования обеспечивают надежность (автоочистка) с минимальным impact на производительность (ADR-016).

## Метрики атрибутов качества

| Атрибут | Метрика | Целевое значение | Метод измерения | Связь с ADR |
|---------|---------|------------------|-----------------|-------------|
| Масштабируемость | Время добавления нового инстанса сервиса | < 5 минут | Мониторинг инфраструктуры | ADR-006, ADR-019 |
| Масштабируемость | Макс. одновременных регистраций | 10,000+ | Load testing | ADR-019 |
| Надежность | Доступность (uptime) | 99.9% | Мониторинг (Prometheus, Grafana) | ADR-008, ADR-017 |
| Надежность | Дублирующие транзакции | 0% | Аудит логов операций | ADR-015 |
| Производительность | P95 latency API | < 200 мс | Application Performance Monitoring (APM) | ADR-016, ADR-018 |
| Производительность | Время освобождения TTL-ресурсов | < 1 секунда | Мониторинг фоновых процессов | ADR-016 |
| Безопасность | Время обнаружения инцидента | < 5 минут | SIEM система, алертинг | ADR-015 |
| Удобство поддержки | Время восстановления после сбоя (MTTR) | < 30 минут | Мониторинг и процессы инцидент-менеджмента | ADR-017 |
| Управляемость | Задержка массовой обработки | < 5 минут для 10K запросов | Мониторинг очередей Kafka | ADR-019 |

## Влияние атрибутов качества на архитектурные решения

1. **Выбор облачных провайдеров:** Использование AWS, GCP, Azure для обеспечения глобальной масштабируемости и надежности.
2. **Микросервисная архитектура:** Для независимого масштабирования и повышения отказоустойчивости.
3. **Event-driven design:** Для улучшения производительности и обработки асинхронных операций.
4. **Геораспределенные базы данных:** Для снижения задержки и повышения доступности.
5. **Service Mesh (Istio/Linkerd):** Для улучшения наблюдаемости, безопасности и управления трафиком.
6. **Идемпотентность операций:** Для гарантии надежности критических операций (ADR-015).
7. **TTL-резервирования:** Для автоматического освобождения ресурсов и предотвращения деградации производительности (ADR-016).
8. **Компенсирующие транзакции:** Для обеспечения согласованности данных в распределенной системе (ADR-017).
9. **Пессимистические блокировки:** Для строгой синхронизации доступа к ограниченным ресурсам (ADR-018).
10. **Батчевая обработка:** Для масштабирования при экстремальных нагрузках (ADR-019).

## Интеграция с техническими решениями из курсовой работы

### Идемпотентность (ADR-015):
- **Влияние на надежность:** Устраняет риск двойных операций при сетевых сбоях.
- **Влияние на безопасность:** Защищает от повторного списания средств.
- **Метрика:** 0% дублирующих транзакций.

### TTL-резервирования (ADR-016):
- **Влияние на производительность:** Автоматическое освобождение ресурсов предотвращает накопление "мертвых" блокировок.
- **Влияние на надежность:** Гарантирует, что забронированные ресурсы будут доступны через разумное время.
- **Метрика:** 100% автоматическое освобождение по истечении TTL.

### Компенсирующие транзакции (ADR-017):
- **Влияние на надежность:** Обеспечивает откат распределенных операций при сбоях.
- **Влияние на согласованность:** Поддерживает целостность данных в микросервисной архитектуре.
- **Метрика:** < 0.1% failed transactions без компенсации.

### Пессимистические блокировки (ADR-018):
- **Влияние на согласованность:** Гарантирует, что ограниченный ресурс не будет продан/забронирован дважды.
- **Влияние на производительность:** Может увеличить задержку при высокой конкуренции.
- **Метрика:** 0% случаев двойного бронирования.

### Массовая обработка (ADR-019):
- **Влияние на масштабируемость:** Позволяет обрабатывать десятки тысяч одновременных запросов.
- **Влияние на производительность:** Увеличивает задержку для отдельных пользователей, но защищает систему от перегрузки.
- **Метрика:** Обработка 10K запросов за < 5 минут.

Эти атрибуты качества и связанные с ними решения из курсовой работы обеспечивают баланс между надежностью, производительностью и масштабируемостью в соответствии с бизнес-требованиями.


