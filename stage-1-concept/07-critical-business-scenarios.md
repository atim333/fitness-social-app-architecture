# 7. Критические бизнес-сценарии

## Обзор
Критические бизнес-сценарии описывают ключевые процессы и взаимодействия, которые должны быть поддержаны архитектурой для достижения бизнес-целей. Эти сценарии используются для валидации архитектурных решений и выявления потенциальных узких мест.

## Сценарий 1: Регистрация нового пользователя и формирование первичного вовлечения

### Контекст:
Новый пользователь скачивает приложение, регистрируется и должен быть вовлечен в первые 7 дней для обеспечения долгосрочной ретенции.

### Основной поток:
1. Пользователь скачивает приложение из App Store/Google Play.
2. Регистрируется через email или социальные сети (OAuth).
3. Заполняет профиль: указывает спортивные интересы, цели, уровень подготовки.
4. Система рекомендует 3-5 групп по интересам и 5-10 потенциальных друзей (по геолокации, интересам).
5. Пользователь совершает первую тренировку (система предлагает простую тренировку по выбранному виду спорта).
6. После тренировки пользователь получает достижение "Первая тренировка" и видит свой прогресс.
7. Система отправляет welcome-email и push-уведомление с предложением пригласить друзей.

### Архитектурные требования:
- Низкая задержка при регистрации (< 2 сек).
- Интеграция с внешними OAuth провайдерами (Google, Facebook, Apple).
- Персонализированные рекомендации в реальном времени.
- Надежная отправка email и push-уведомлений.

### Критические метрики:
- Конверсия скачивание → регистрация: > 40%.
- Конверсия регистрация → первая тренировка: > 30%.
- Дневное удержание (Day 1 Retention): > 60%.

---

## Сценарий 2: Социальное взаимодействие и влияние в группах

### Контекст:
Пользователь активно использует социальные функции приложения, участвует в группах, что повышает его вовлеченность и лояльность к бренду.

### Основной поток:
1. Пользователь заходит в приложение и видит ленту активности друзей и групп.
2. Видит, что друг достиг нового уровня или завершил сложную тренировку.
3. Реагирует на активность друга (лайк, комментарий).
4. Публикует результаты своей тренировки в группе.
5. Участвует в групповом челлендже (например, "100 км за месяц").
6. Приглашает нового пользователя в группу.
7. Получает уведомления о активности в группе (новые сообщения, достижения участников).

### Архитектурные требования:
- Реальное время для ленты активности (WebSockets или Server-Sent Events).
- Высокая доступность сервиса социального графа (> 99.9%).
- Эффективный поиск и рекомендации групп.
- Масштабируемая система уведомлений.

### Критические метрики:
- Среднее время в приложении для социально активных пользователей: > 20 мин/день.
- Количество взаимодействий (лайки, комментарии) на пользователя в день: > 5.
- Рост групп: 10% в месяц.

---

## Сценарий 3: Тренировка с подключением внешних устройств и продвинутой аналитикой

### Контекст:
Продвинутый пользователь использует подключенные устройства (фитнес-браслет, датчик пульса) для получения детальной аналитики и улучшения результатов.

### Основной поток:
1. Пользователь подключает фитнес-браслет через Bluetooth.
2. Начинает тренировку, выбирая тип (бег, велосипед) и цель (например, интервальная тренировка).
3. Во время тренировки приложение отображает в реальном времени: пульс, темп, калории, маршрут на карте.
4. Данные синхронизируются с облаком каждые 30 секунд.
5. После тренировки система анализирует данные:
   - Сравнивает с предыдущими результатами.
   - Оценивает эффективность (на основе пульса, темпа).
   - Дает рекомендации по восстановлению.
6. Пользователь видит детальный отчет и может поделиться им с друзьями.
7. На основе данных система рекомендует новую экипировку (например, кроссовки для бега после 500 км).

### Архитектурные требования:
- Обработка потоковых данных в реальном времени.
- Интеграция с различными протоколами устройств (Bluetooth, ANT+).
- Хранение больших объемов телеметрии.
- Машинное обучение для аналитики и рекомендаций.

### Критические метрики:
- Задержка отображения данных с устройства: < 5 сек.
- Точность данных (синхронизация с устройствами): > 95%.
- Конверсия рекомендаций экипировки в просмотры товара: > 10%.

---

## Сценарий 4: Участие в глобальном соревновании и промоакции

### Контекст:
Компания запускает глобальное соревнование (например, "Марафон на 1000 км") с промоакциями для стимулирования продаж.

### Основной поток:
1. Пользователь получает уведомление о старте нового глобального челленджа.
2. Регистрируется на челлендж.
3. Во время челленджа видит свой прогресс и позицию в глобальном и региональном рейтинге.
4. Получает промокод на скидку после достижения промежуточной цели (например, 100 км).
5. Использует промокод в магазине компании (онлайн или оффлайн).
6. После завершения челленджа получает виртуальный бейдж и, если попал в топ-100, реальный приз (например, новая пара кроссовок).
7. Приглашает друзей участвовать в челлендже (реферальная программа).

### Архитектурные требования:
- Обработка пиковых нагрузок (в день старта челленджа).
- Глобальная синхронизация рейтингов в реальном времени.
- Интеграция с системой промокодов и e-commerce.
- Геораспределенная инфраструктура для низкой задержки.

### Критические метрики:
- Участие в челленджах: > 20% активных пользователей.
- Конверсия промокодов в покупки: > 15%.
- Рост продаж во время челленджа: > 25%.

---

## Сценарий 5: Поддержка пользователя в "диких" регионах

### Контекст:
Группа пользователей отправляется в регион с плохим интернетом (например, горный поход) и хочет использовать приложение для трекинга.

### Основной поток:
1. Пользователь заранее загружает карты региона для оффлайн использования.
2. Во время похода приложение записывает трек, даже без подключения к интернету.
3. Данные сохраняются локально и синхронизируются при появлении соединения.
4. Пользователь может видеть свой прогресс и маршрут оффлайн.
5. При наличии слабого соединения (2G) приложение отправляет ключевые данные (например, координаты для безопасности).
6. После возвращения в зону покрытия все данные синхронизируются, и пользователь получает полный отчет.

### Архитектурные требования:
- Оффлайн-поддержка на мобильных клиентах.
- Эффективная синхронизация данных (конфликт-разрешение при одновременном редактировании).
- Сжатие и оптимизация данных для слабых сетей.
- Приоритизация критических данных (например, сигналы SOS).

### Критические метрики:
- Успешная синхронизация после оффлайн-сессии: > 99%.
- Задержка отправки критических данных при слабом соединении: < 60 сек.
- Удовлетворенность пользователей в "диких" регионах: > 4.0 по 5-балльной шкале.

---

## Сценарий 6: Покупка товара с промокодом и гарантией наличия

### Контекст:
Пользователь выбирает товар в приложении, применяет промокод и оформляет заказ с гарантией наличия товара на складе.

### Основной поток:
1. Пользователь добавляет товары в корзину в приложении.
2. Применяет промокод для получения скидки.
3. Система фиксирует цены на 15 минут (создает ценовую сессию).
4. Пользователь подтверждает заказ с указанием Idempotency-Key для предотвращения дублирования.
5. Система выполняет последовательные проверки:
   - Проверка доступности товара на складах региона пользователя
   - Валидация промокода и расчет финальной цены
   - Резервирование товара с TTL 30 минут
6. Создается заказ со статусом "confirmed".
7. Отправляется уведомление о подтверждении заказа.
8. Корзина пользователя очищается.

### Архитектурные требования:
- **Идемпотентность операций:** Idempotency-Key для предотвращения дублирования заказов
- **TTL резервирований:** Автоматическое освобождение товара через 30 минут при неоплате
- **Компенсирующие транзакции:** Откат резервирований при ошибках
- **Стандартизация ошибок:** Единые HTTP-коды и форматы ошибок между сервисами
- **Строгая согласованность:** Для операций с инвентарем и финансами

### Критические метрики:
- Время обработки заказа: < 5 секунд
- Успешное завершение транзакции: > 99.5%
- Автоматическое освобождение неоплаченных резервирований: 100%
- Конверсия бронирования в покупку: > 85%

---

## Сценарий 7: Бронирование места на платном спортивном событии

### Контекст:
Пользователь регистрируется на платное спортивное событие с ограниченным количеством мест.

### Основной поток:
1. Пользователь выбирает событие в календаре тренировок.
2. Нажимает "Забронировать место" и указывает Idempotency-Key.
3. Система выполняет проверки:
   - Проверка доступности мест с блокировкой FOR UPDATE
   - Проверка квалификации пользователя (требуемый уровень подготовки)
   - Валидация промокода при наличии
4. Место временно резервируется с TTL 15 минут.
5. Пользователь подтверждает оплату.
6. Бронирование подтверждается, статус меняется на "confirmed".
7. Место исключается из доступных для других пользователей.
8. При неоплате в течение 15 минут резервирование автоматически снимается.

### Архитектурные требования:
- **Пессимистические блокировки:** SELECT FOR UPDATE для управления местами
- **TTL для временных резервирований:** Автоматическое освобождение мест
- **Компенсирующие действия:** Отмена бронирования с уведомлением ожидающих
- **Очереди ожидания:** Автоматическое предложение освободившихся мест
- **Уведомления в реальном времени:** О статусе бронирования

### Критические метрики:
- Время бронирования места: < 3 секунды
- Загрузка системы при массовой регистрации: CPU < 70%
- Автоматическое заполнение очередей ожидания: > 90%
- Удовлетворенность пользователей процессом бронирования: > 4.5/5

---

## Матрица соответствия бизнес-целям

| Сценарий | Бизнес-цель 1 (Вовлеченность) | Бизнес-цель 2 (Продажи) | Бизнес-цель 3 (Комьюнити) | Бизнес-цель 4 (Имидж) |
|----------|-------------------------------|--------------------------|----------------------------|------------------------|
| 1. Регистрация и вовлечение | Высокое | Среднее | Низкое | Среднее |
| 2. Социальное взаимодействие | Высокое | Низкое | Высокое | Среднее |
| 3. Тренировка с устройствами | Высокое | Высокое | Среднее | Высокое |
| 4. Глобальное соревнование | Высокое | Высокое | Высокое | Высокое |
| 5. Поддержка в диких регионах | Среднее | Низкое | Среднее | Высокое |
| 6. Покупка товара с промокодом | Среднее | Высокое | Низкое | Высокое |
| 7. Бронирование места на событии | Высокое | Высокое | Высокое | Высокое |

---

## Выводы для архитектуры

1. **Масштабируемость:** Архитектура должна поддерживать пиковые нагрузки, особенно во время старта глобальных событий и массовых бронирований.
2. **Надежность:** Критично для социальных функций, трекинга тренировок и финансовых транзакций.
3. **Производительность:** Низкая задержка необходима для реального времени, работы с устройствами и операций бронирования.
4. **Устойчивость к потере связи:** Оффлайн-поддержка и эффективная синхронизация.
5. **Безопасность и конфиденциальность:** Особенно важно для данных о здоровье, местоположении и финансовой информации.
6. **Управление распределенными транзакциями:** Требуются механизмы идемпотентности, TTL резервирований, компенсирующих транзакций и пессимистических блокировок.
7. **Стандартизация коммуникации:** Единые протоколы ошибок и механизмы повторных попыток для устойчивости к сбоям.
8. **Автоматическое восстановление:** TTL-механизмы для освобождения зарезервированных ресурсов при сбоях.

Эти сценарии будут использоваться для тестирования архитектуры и принятия решений на этапах проектирования и реализации.

